---
import Layout from '../layouts/Layout.astro';
import AIPanel from '../components/AIPanel.astro';
import CharacterPanel from '../components/CharacterPanel.astro';
import WorldbookPanel from '../components/WorldbookPanel.astro';
import StatusBarPanel from '../components/StatusBarPanel.astro';
import PreviewPanel from '../components/PreviewPanel.astro';
import ChatPlayground from '../components/ChatPlayground.astro';
import WorldbookAuditor from '../components/WorldbookAuditor.astro';
import VariableCardPanel from '../components/VariableCardPanel.astro';
import SecurityCordon from '../components/SecurityCordon.astro';
import ParticleCanvas from '../components/ParticleCanvas.astro';
import GsapAnimations from '../components/GsapAnimations.astro';
---

<Layout title="SillyTavern V3 å¡ç‰‡æ„å»ºå™¨">
  <ParticleCanvas />
  <div class="app-header">
    <div class="app-brand">
      <span class="app-logo">ğŸŒŒ</span>
      <div>
        <h1 class="app-title">V3 å¡ç‰‡æ„å»ºå™¨</h1>
        <p class="app-subtitle">æœªå®Œæˆç‰ˆæœ¬</p>
      </div>
    </div>
    <div class="app-header-actions">
      <label class="fx-toggle" title="å¼€å¯/å…³é—­åŠ¨ç”»ç‰¹æ•ˆï¼ˆä½æ€§èƒ½è®¾å¤‡å»ºè®®å…³é—­ï¼‰">
        <input type="checkbox" id="fxToggle" />
        <span class="fx-toggle-track">
          <span class="fx-toggle-thumb"></span>
        </span>
        <span class="fx-toggle-label">âœ¨ ç‰¹æ•ˆ</span>
      </label>
      <span class="app-version-badge">V3 SPEC</span>
    </div>
  </div>

  <div class="app-container">
    <AIPanel />
    <CharacterPanel />
    <WorldbookPanel />
    <PreviewPanel />
    <div class="area-chat" style="display:flex;flex-direction:column;gap:16px;">
      <ChatPlayground />
      <SecurityCordon unlockClicks={10} label="ğŸ”’ å˜é‡å¡æ¨¡å—å°é”ä¸­ Â· å¼€å‘æœªå®Œæˆ">
        <VariableCardPanel />
      </SecurityCordon>
    </div>
    <StatusBarPanel />
    <WorldbookAuditor />
  </div>

  <GsapAnimations />

  <script is:inline>
    // ============================================================
    //  å­—æ®µæ³¨é‡Šå­—å…¸
    // ============================================================
    var FIELD_DICT = {
      "name": { label: "è§’è‰²å", tip: "è§’è‰²çš„æ˜¾ç¤ºåç§°", type: "string", required: true },
      "description": { label: "è§’è‰²æè¿°(é¡¶å±‚)", tip: "V2å…¼å®¹å­—æ®µï¼Œä¸data.descriptionåŒæ­¥", type: "string" },
      "personality": { label: "æ€§æ ¼(é¡¶å±‚)", tip: "V3ä¸­é€šå¸¸ç•™ç©º", type: "string" },
      "scenario": { label: "åœºæ™¯(é¡¶å±‚)", tip: "V3ä¸­é€šå¸¸ç•™ç©º", type: "string" },
      "first_mes": { label: "å¼€åœºç™½(é¡¶å±‚)", tip: "è§’è‰²è¯´çš„ç¬¬ä¸€å¥è¯", type: "string" },
      "mes_example": { label: "å¯¹è¯ç¤ºä¾‹(é¡¶å±‚)", tip: "ç¤ºèŒƒè§’è‰²è¯´è¯é£æ ¼", type: "string" },
      "creatorcomment": { label: "ä½œè€…æ³¨é‡Š(é¡¶å±‚)", tip: "V2å…¼å®¹å­—æ®µ", type: "string" },
      "avatar": { label: "å¤´åƒæ ‡è®°", tip: "å¤´åƒæ–‡ä»¶åæˆ–none", type: "string" },
      "talkativeness": { label: "è¯ç—¨ç¨‹åº¦", tip: "0.0~1.0 æ§åˆ¶ä¸»åŠ¨å‘è¨€é¢‘ç‡", type: "string" },
      "fav": { label: "æ”¶è—æ ‡è®°", tip: "æ˜¯å¦è¢«æ ‡è®°ä¸ºæ”¶è—", type: "boolean" },
      "tags": { label: "æ ‡ç­¾(é¡¶å±‚)", tip: "åˆ†ç±»æ ‡ç­¾æ•°ç»„", type: "array" },
      "spec": { label: "å¡ç‰‡è§„æ ¼", tip: "å›ºå®šä¸ºchara_card_v3", type: "string", required: true, enum: ["chara_card_v3"] },
      "spec_version": { label: "è§„æ ¼ç‰ˆæœ¬", tip: "å›ºå®šä¸º3.0", type: "string", required: true, enum: ["3.0"] },
      "data.name": { label: "è§’è‰²å", tip: "V3ä¸»æ•°æ®å±‚è§’è‰²å", type: "string", required: true },
      "data.description": { label: "è§’è‰²æè¿°", tip: "æ ¸å¿ƒæè¿°ï¼šå¤–è²Œã€æ€§æ ¼ã€èƒŒæ™¯", type: "string", required: true },
      "data.personality": { label: "æ€§æ ¼", tip: "æ¨èå†™åœ¨descriptioné‡Œ", type: "string" },
      "data.scenario": { label: "åœºæ™¯", tip: "æ¨èç”¨ä¸–ç•Œä¹¦ä»£æ›¿", type: "string" },
      "data.first_mes": { label: "å¼€åœºç™½", tip: "é¦–æ¬¡å¯¹è¯è§’è‰²å‘é€çš„ç¬¬ä¸€æ¡æ¶ˆæ¯", type: "string", required: true },
      "data.mes_example": { label: "å¯¹è¯ç¤ºä¾‹", tip: "æ ¼å¼ï¼š<START>\\n{{char}}: ...", type: "string" },
      "data.creator_notes": { label: "ä½œè€…æ³¨é‡Š", tip: "ç»™ä½¿ç”¨è€…çœ‹çš„è¯´æ˜ï¼Œä¸æ³¨å…¥AI", type: "string" },
      "data.system_prompt": { label: "ç³»ç»Ÿæç¤ºè¯", tip: "æœ€é«˜ä¼˜å…ˆçº§ç³»ç»ŸæŒ‡ä»¤ï¼Œæ…ç”¨", type: "string" },
      "data.post_history_instructions": { label: "å†å²åæŒ‡ä»¤", tip: "Author's Noteä½ç½®çš„æŒ‡ä»¤", type: "string" },
      "data.tags": { label: "æ ‡ç­¾", tip: "åˆ†ç±»æ ‡ç­¾æ•°ç»„", type: "array" },
      "data.creator": { label: "åˆ›ä½œè€…", tip: "å¡ç‰‡åˆ¶ä½œè€…åå­—", type: "string" },
      "data.character_version": { label: "å¡ç‰‡ç‰ˆæœ¬", tip: "è¿­ä»£ç‰ˆæœ¬å·", type: "string" },
      "data.alternate_greetings": { label: "å¤‡é€‰å¼€åœºç™½", tip: "å¤šä¸ªå¯é€‰å¼€åœºç™½", type: "array" },
      "data.extensions": { label: "æ‰©å±•æ•°æ®", tip: "V3æ‰©å±•å­—æ®µå®¹å™¨", type: "object" },
      "data.extensions.world": { label: "å…³è”ä¸–ç•Œä¹¦", tip: "å…³è”çš„ä¸–ç•Œä¹¦åç§°", type: "string" },
      "data.extensions.regex_scripts": { label: "æ­£åˆ™è„šæœ¬åˆ—è¡¨", tip: "åµŒå…¥å¡ç‰‡çš„æ­£åˆ™æ›¿æ¢è„šæœ¬", type: "array" },
      "data.extensions.regex_scripts[].id": { label: "è„šæœ¬ID", tip: "å”¯ä¸€æ ‡è¯†ç¬¦", type: "string" },
      "data.extensions.regex_scripts[].scriptName": { label: "è„šæœ¬åç§°", tip: "æ˜¾ç¤ºåç§°", type: "string" },
      "data.extensions.regex_scripts[].findRegex": { label: "åŒ¹é…æ­£åˆ™", tip: "æ­£åˆ™è¡¨è¾¾å¼å­—ç¬¦ä¸²", type: "string" },
      "data.extensions.regex_scripts[].replaceString": { label: "æ›¿æ¢å†…å®¹", tip: "æ›¿æ¢HTMLï¼Œ$1å¼•ç”¨æ•è·ç»„", type: "string" },
      "data.extensions.regex_scripts[].placement": { label: "ä½œç”¨èŒƒå›´", tip: "1=AIè¾“å‡º 2=ç”¨æˆ·è¾“å…¥", type: "array" },
      "data.extensions.regex_scripts[].disabled": { label: "æ˜¯å¦ç¦ç”¨", tip: "trueåˆ™ä¸ç”Ÿæ•ˆ", type: "boolean" },
      "data.extensions.regex_scripts[].runOnEdit": { label: "ç¼–è¾‘æ—¶æ‰§è¡Œ", tip: "ç¼–è¾‘æ¶ˆæ¯æ—¶é‡æ–°æ‰§è¡Œ", type: "boolean" },
      "data.character_book": { label: "å†…åµŒä¸–ç•Œä¹¦", tip: "åµŒå…¥è§’è‰²å¡çš„ä¸–ç•Œä¹¦", type: "object" },
      "data.character_book.name": { label: "ä¸–ç•Œä¹¦åç§°", tip: "ä¸–ç•Œä¹¦æ˜¾ç¤ºåç§°", type: "string" },
      "data.character_book.entries": { label: "è¯æ¡åˆ—è¡¨", tip: "æ‰€æœ‰è¯æ¡æ•°ç»„", type: "array" },
      "data.character_book.entries[].id": { label: "è¯æ¡ID", tip: "ä»0å¼€å§‹çš„ç´¢å¼•", type: "number" },
      "data.character_book.entries[].keys": { label: "è§¦å‘è¯", tip: "å‡ºç°è¿™äº›è¯æ—¶æ¿€æ´»è¯æ¡", type: "array", required: true },
      "data.character_book.entries[].secondary_keys": { label: "æ¬¡è¦è§¦å‘è¯", tip: "é…åˆselectiveLogicä½¿ç”¨", type: "array" },
      "data.character_book.entries[].comment": { label: "è¯æ¡æ ‡é¢˜", tip: "ä»…ç®¡ç†ç•Œé¢æ˜¾ç¤ºï¼Œä¸æ³¨å…¥AI", type: "string" },
      "data.character_book.entries[].content": { label: "è¯æ¡å†…å®¹", tip: "è§¦å‘åæ³¨å…¥AIçš„è®¾å®šæ–‡æœ¬", type: "string", required: true },
      "data.character_book.entries[].constant": { label: "æ˜¯å¦å¸¸é©»", tip: "true=å§‹ç»ˆæ³¨å…¥ï¼Œæ— éœ€è§¦å‘è¯", type: "boolean" },
      "data.character_book.entries[].selective": { label: "æ˜¯å¦é€‰æ‹©æ€§", tip: "true=éœ€è¦å…³é”®è¯è§¦å‘", type: "boolean" },
      "data.character_book.entries[].insertion_order": { label: "æ’å…¥é¡ºåº", tip: "æ•°å€¼è¶Šå¤§è¶Šå…ˆå¤„ç†", type: "number", range: { min: 0, max: 9999 } },
      "data.character_book.entries[].enabled": { label: "æ˜¯å¦å¯ç”¨", tip: "falseåˆ™å®Œå…¨ä¸ç”Ÿæ•ˆ", type: "boolean" },
      "data.character_book.entries[].position": { label: "æ’å…¥ä½ç½®(æ–‡æœ¬)", tip: "V2å…¼å®¹å­—æ®µ", type: "string" },
      "data.character_book.entries[].use_regex": { label: "æ­£åˆ™åŒ¹é…", tip: "è§¦å‘è¯å½“ä½œæ­£åˆ™è¡¨è¾¾å¼", type: "boolean" },
      "data.character_book.entries[].extensions": { label: "è¯æ¡æ‰©å±•å‚æ•°", tip: "V3é«˜çº§æ§åˆ¶å‚æ•°", type: "object" },
      "data.character_book.entries[].extensions.position": { label: "æ’å…¥ä½ç½®", tip: "0=è§’è‰²å‰ 4=æŒ‰æ·±åº¦(æœ€å¸¸ç”¨)", type: "number", enum: [0,1,2,3,4,5,6] },
      "data.character_book.entries[].extensions.probability": { label: "è§¦å‘æ¦‚ç‡", tip: "0~100", type: "number", range: { min: 0, max: 100 } },
      "data.character_book.entries[].extensions.useProbability": { label: "å¯ç”¨æ¦‚ç‡", tip: "falseåˆ™å¿½ç•¥æ¦‚ç‡å€¼", type: "boolean" },
      "data.character_book.entries[].extensions.depth": { label: "æ’å…¥æ·±åº¦", tip: "position=4æ—¶ç”Ÿæ•ˆ", type: "number", range: { min: 0, max: 999 } },
      "data.character_book.entries[].extensions.selectiveLogic": { label: "é€‰æ‹©é€»è¾‘", tip: "0=AND 1=NOT 2=OR", type: "number", enum: [0,1,2,3] },
      "data.character_book.entries[].extensions.group": { label: "äº’æ–¥ç»„", tip: "åŒç»„åªèƒ½æ¿€æ´»ä¸€ä¸ª", type: "string" },
      "data.character_book.entries[].extensions.group_weight": { label: "ç»„æƒé‡", tip: "äº’æ–¥ç»„å†…ä¼˜å…ˆçº§", type: "number" },
      "data.character_book.entries[].extensions.role": { label: "æ·±åº¦è§’è‰²", tip: "0=ç³»ç»Ÿ 1=ç”¨æˆ· 2=åŠ©æ‰‹", type: "number", enum: [0,1,2] },
      "data.character_book.entries[].extensions.vectorized": { label: "å‘é‡åŒ–", tip: "true=è¯­ä¹‰å‘é‡åŒ¹é…", type: "boolean" },
      "data.character_book.entries[].extensions.display_index": { label: "æ˜¾ç¤ºæ’åº", tip: "ç®¡ç†ç•Œé¢æ’åº", type: "number" },
      "data.character_book.entries[].extensions.exclude_recursion": { label: "æ’é™¤é€’å½’", tip: "å†…å®¹ä¸è§¦å‘å…¶ä»–è¯æ¡", type: "boolean" },
      "data.character_book.entries[].extensions.prevent_recursion": { label: "é˜»æ­¢é€’å½’", tip: "ä¸è¢«é€’å½’è§¦å‘", type: "boolean" },
      "data.character_book.entries[].extensions.delay_until_recursion": { label: "å»¶è¿Ÿåˆ°é€’å½’", tip: "é€’å½’æ‰«æé˜¶æ®µæ‰ç”Ÿæ•ˆ", type: "boolean" },
      "data.character_book.entries[].extensions.group_override": { label: "ç»„è¦†ç›–", tip: "å¯è¦†ç›–åŒç»„å·²æ¿€æ´»è¯æ¡", type: "boolean" },
      "data.character_book.entries[].extensions.outlet_name": { label: "è¾“å‡ºé€šé“", tip: "æŒ‡å®šæ³¨å…¥é€šé“", type: "string" },
    };

    function getFieldInfo(path) {
      if (FIELD_DICT[path]) return FIELD_DICT[path];
      var n1 = path.replace(/\.(\d+)\./g, '[].');
      if (FIELD_DICT[n1]) return FIELD_DICT[n1];
      var n2 = path.replace(/\.(\d+)$/g, '[]');
      if (FIELD_DICT[n2]) return FIELD_DICT[n2];
      return undefined;
    }
    function validateField(path, value) {
      var info = getFieldInfo(path); if (!info) return null;
      if (info.required && (value === undefined || value === null || value === '')) return 'å¿…å¡«å­—æ®µä¸èƒ½ä¸ºç©º';
      if (value !== null && value !== undefined && info.type !== 'any') {
        var t = Array.isArray(value) ? 'array' : typeof value;
        if (t !== info.type) return 'ç±»å‹é”™è¯¯ï¼šæœŸæœ› ' + info.type + 'ï¼Œå®é™… ' + t;
      }
      if (info.enum && value !== undefined && value !== null && value !== '' && info.enum.indexOf(value) === -1) return 'å€¼ä¸åœ¨å…è®¸èŒƒå›´';
      if (info.range && typeof value === 'number') {
        if (info.range.min !== undefined && value < info.range.min) return 'æœ€å°å€¼ä¸º ' + info.range.min;
        if (info.range.max !== undefined && value > info.range.max) return 'æœ€å¤§å€¼ä¸º ' + info.range.max;
      }
      return null;
    }
    function validateFullJSON(obj, pp, errs) {
      if (!pp) pp = ''; if (!errs) errs = [];
      if (obj === null || obj === undefined) return errs;
      if (Array.isArray(obj)) { obj.forEach(function(it, i) { var p = pp+'.'+i; if (typeof it==='object'&&it!==null) validateFullJSON(it,p,errs); else { var e=validateField(p,it); if(e) errs.push({path:p,message:e,value:it}); } }); }
      else if (typeof obj === 'object') { Object.keys(obj).forEach(function(k) { var fp=pp?pp+'.'+k:k; var v=obj[k]; var e=validateField(fp,v); if(e) errs.push({path:fp,message:e,value:v}); if(typeof v==='object'&&v!==null) validateFullJSON(v,fp,errs); }); }
      return errs;
    }
    window.__fieldDict__ = { getFieldInfo: getFieldInfo, validateFullJSON: validateFullJSON };

    // ============================================================
    //  DOM
    // ============================================================
    var apiUrl               = document.getElementById('apiUrl');
    var apiKey               = document.getElementById('apiKey');
    var btnFetchModels       = document.getElementById('btnFetchModels');
    var modelSelect          = document.getElementById('modelSelect');
    var presetInput          = document.getElementById('presetInput');
    var presetListContainer  = document.getElementById('presetListContainer');
    var presetStatus         = document.getElementById('presetStatus');
    var aiPrompt             = document.getElementById('aiPrompt');
    var wbPrompt             = document.getElementById('wbPrompt');
    var btnAiGenerate        = document.getElementById('btnAiGenerate');
    var aiStatus             = document.getElementById('aiStatus');
    var wbSinglePrompt       = document.getElementById('wbSinglePrompt');
    var btnAiSingleWb        = document.getElementById('btnAiSingleWb');
    var wbIncludeCharData    = document.getElementById('wbIncludeCharData');
    var draftSelect          = document.getElementById('draftSelect');
    var btnNewDraft          = document.getElementById('btnNewDraft');
    var btnDeleteDraft       = document.getElementById('btnDeleteDraft');
    var saveIndicator        = document.getElementById('saveIndicator');
    var charImageInput       = document.getElementById('charImageInput');
    var avatarImg            = document.getElementById('avatarImg');
    var avatarPlaceholder    = document.getElementById('avatarPlaceholder');
    var charName             = document.getElementById('charName');
    var wbName               = document.getElementById('wbName');
    var charDesc             = document.getElementById('charDesc');
    var firstMes             = document.getElementById('firstMes');
    var creatorNotes         = document.getElementById('creatorNotes');
    var entryComment         = document.getElementById('entryComment');
    var entryContent         = document.getElementById('entryContent');
    var entryKeys            = document.getElementById('entryKeys');
    var entryStrategy        = document.getElementById('entryStrategy');
    var entryPosition        = document.getElementById('entryPosition');
    var entryDepth           = document.getElementById('entryDepth');
    var entryRole            = document.getElementById('entryRole');
    var entryOrder           = document.getElementById('entryOrder');
    var entryProb            = document.getElementById('entryProb');
    var btnAddEntry          = document.getElementById('btnAddEntry');
    var entriesList          = document.getElementById('entriesList');
    var btnDownloadJson      = document.getElementById('btnDownloadJson');
    var btnExportPNG         = document.getElementById('btnExportPNG');

    // ============================================================
    //  çŠ¶æ€
    // ============================================================
    var worldbookEntries     = [];
    var regexScripts         = [];
    var tavernHelperScripts  = [];  // ScriptTree[] â€” é…’é¦†åŠ©æ‰‹è„šæœ¬
    var currentAvatarBase64  = "";
    var currentDraftId       = "";
    var parsedPresetList     = [];
    var editingIndex         = -1;
    var statusBarActive      = true;
    var cachedSearchResults  = null;

    if (!window.__altGreetings__) window.__altGreetings__ = [];

    var DRAFTS_KEY  = "st_v3_builder_drafts";
    var CURRENT_KEY = "st_v3_builder_current_id";
    var AI_KEY      = "st_v3_builder_ai_config";

    // ============================================================
    //  å…¨å±€æ¡¥æ¥
    // ============================================================
    window.triggerGlobalUpdate = function() { debouncedUpdateAndSave(); };

    window.injectStatusBarGlobal = function(wbEntry, regexOrArray) {
      var idx = -1;
      for (var i = 0; i < worldbookEntries.length; i++) {
        if (worldbookEntries[i].comment === wbEntry.comment) { idx = i; break; }
      }
      if (idx >= 0) worldbookEntries[idx] = wbEntry; else worldbookEntries.push(wbEntry);
      regexScripts = Array.isArray(regexOrArray) ? regexOrArray : [regexOrArray];
      renderEntriesList();
      debouncedUpdateAndSave();
    };

    // â˜… å˜é‡å¡ç”Ÿæˆå™¨ â€” æ‰¹é‡æ³¨å…¥ä¸–ç•Œä¹¦æ¡ç›® & æ­£åˆ™è„šæœ¬
    window.__injectMvuEntries__ = function(entries, newRegexScripts) {
      if (!Array.isArray(entries)) return;
      entries.forEach(function(entry) {
        var idx = -1;
        for (var i = 0; i < worldbookEntries.length; i++) {
          if (worldbookEntries[i].comment === entry.comment) { idx = i; break; }
        }
        if (idx >= 0) worldbookEntries[idx] = entry; else worldbookEntries.push(entry);
      });
      if (Array.isArray(newRegexScripts)) {
        newRegexScripts.forEach(function(rx) {
          var rxIdx = -1;
          for (var j = 0; j < regexScripts.length; j++) {
            if (regexScripts[j].scriptName === rx.scriptName) { rxIdx = j; break; }
          }
          if (rxIdx >= 0) regexScripts[rxIdx] = rx; else regexScripts.push(rx);
        });
      }
      renderEntriesList();
      debouncedUpdateAndSave();
    };

    // â˜… å˜é‡å¡ç”Ÿæˆå™¨ â€” è®¾ç½®é…’é¦†åŠ©æ‰‹è„šæœ¬ï¼ˆå®Œæ•´ ScriptTree æ ¼å¼ï¼‰
    window.__setTavernHelperScript__ = function(name, code) {
      if (!name) return;
      // ç¡®ä¿æ˜¯æ•°ç»„ï¼ˆå…¼å®¹æ—§è‰ç¨¿ï¼‰
      if (!Array.isArray(tavernHelperScripts)) tavernHelperScripts = [];
      // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨åŒåè„šæœ¬
      var found = false;
      for (var i = 0; i < tavernHelperScripts.length; i++) {
        if (tavernHelperScripts[i].name === name) {
          tavernHelperScripts[i].content = code;
          found = true; break;
        }
      }
      if (!found) {
        tavernHelperScripts.push({
          type: 'script',
          enabled: true,
          name: name,
          id: crypto.randomUUID ? crypto.randomUUID() : (Date.now().toString(36) + '-' + Math.random().toString(36).slice(2)),
          content: code,
          info: 'ç”± Card Builder å˜é‡å¡ç”Ÿæˆå™¨è‡ªåŠ¨åˆ›å»º',
          button: { enabled: true, buttons: [] },
          data: {}
        });
      }
      debouncedUpdateAndSave();
    };

    window.setStatusBarActiveState = function(active) {
      statusBarActive = active;
      debouncedUpdateAndSave();
    };

window.applyJSONFromEditor = function(json) {
  if (!json || !json.data) return;
  charName.value     = json.data.name || json.name || '';
  wbName.value       = (json.data.extensions && json.data.extensions.world) || '';
  charDesc.value     = json.data.description || '';
  firstMes.value     = json.data.first_mes || '';
  creatorNotes.value = json.data.creator_notes || '';
  if (json.data.character_book && json.data.character_book.entries) {
    worldbookEntries = json.data.character_book.entries.map(function(e) {
      return {
        comment:  e.comment || '',
        content:  e.content || '',
        keys:     e.keys || [],
        strategy: e.constant ? 'constant' : (e.extensions && e.extensions.vectorized ? 'vectorized' : 'selective'),
        position: (e.extensions && e.extensions.position !== undefined) ? e.extensions.position : 4,
        depth:    (e.extensions && e.extensions.depth !== undefined) ? e.extensions.depth : 4,
        role:     (e.extensions && e.extensions.role !== undefined) ? e.extensions.role : 0,
        order:    e.insertion_order || 100,
        prob:     (e.extensions && e.extensions.probability !== undefined) ? e.extensions.probability : 100
      };
    });
    renderEntriesList();
  }
  if (json.data.extensions && json.data.extensions.regex_scripts) {
    regexScripts = json.data.extensions.regex_scripts;
  }
  if (json.data.extensions && json.data.extensions.tavern_helper && json.data.extensions.tavern_helper.scripts) {
    var ths = json.data.extensions.tavern_helper.scripts;
    tavernHelperScripts = Array.isArray(ths) ? ths : [];
  }
  if (json.data.alternate_greetings && json.data.alternate_greetings.length > 0) {
    window.__altGreetings__ = json.data.alternate_greetings;
    if (window.__renderAltGreetings__) window.__renderAltGreetings__();
  } else {
    // â˜… å¯¼å…¥çš„å¡æ²¡æœ‰å¤‡é€‰å¼€åœºç™½æ—¶ï¼Œæ¸…ç©ºæ—§æ•°æ®
    window.__altGreetings__ = [];
    if (window.__renderAltGreetings__) window.__renderAltGreetings__();
  }
  saveCurrentDraft();
  debouncedUpdateAndSave();
};

// â˜… å¯¼å…¥å¡ç‰‡æ—¶æ¢å¤å¤´åƒï¼ˆç»™ PreviewPanel çš„ PNG å¯¼å…¥è°ƒç”¨ï¼‰
window.__setImportedAvatar__ = function(base64) {
  currentAvatarBase64 = base64;
  avatarImg.src = base64;
  avatarImg.style.display = 'block';
  avatarPlaceholder.style.display = 'none';
  debouncedUpdateAndSave();
};

    window.__getWorldbookEntries__ = function() {
      return worldbookEntries.map(function(e) {
        return {
          comment:  e.comment || '',
          content:  e.content || '',
          keys:     e.keys || [],
          strategy: e.strategy || 'selective',
          position: e.position || 4,
          depth:    e.depth || 4,
          role:     e.role || 0,
          order:    e.order || 100,
          prob:     e.prob || 100
        };
      });
    };

    window.__getActivePresetsStr__ = function() { return getActivePresetsStr(); };

    window.__getActivePresetMessages__ = function() {
      var result = [];
      parsedPresetList.forEach(function(p) {
        if (!p.enabled) return;
        var name = (p.name || '').toLowerCase();
        if (name.indexOf('example') >= 0 || name.indexOf('dialogue') >= 0
          || name.indexOf('ç¤ºä¾‹') >= 0 || name.indexOf('å¯¹è¯') >= 0
          || name.indexOf('few-shot') >= 0 || name.indexOf('fewshot') >= 0) {
          var lines = p.content.split('\n');
          var currentRole = 'user';
          var currentContent = [];
          lines.forEach(function(line) {
            var trimmed = line.trim();
            if (!trimmed) return;
            if (trimmed.match(/^<START>/i)) {
              if (currentContent.length > 0) {
                result.push({ role: currentRole, content: currentContent.join('\n').trim() });
                currentContent = [];
              }
              return;
            }
            if (trimmed.match(/^\{\{user\}\}\s*:/i) || trimmed.match(/^ç”¨æˆ·\s*:/i) || trimmed.match(/^User\s*:/i)) {
              if (currentContent.length > 0) {
                result.push({ role: currentRole, content: currentContent.join('\n').trim() });
                currentContent = [];
              }
              currentRole = 'user';
              var cleaned = trimmed.replace(/^\{\{user\}\}\s*:\s*/i, '').replace(/^ç”¨æˆ·\s*:\s*/i, '').replace(/^User\s*:\s*/i, '');
              if (cleaned) currentContent.push(cleaned);
            } else if (trimmed.match(/^\{\{char\}\}\s*:/i) || trimmed.match(/^è§’è‰²\s*:/i) || trimmed.match(/^Assistant\s*:/i)) {
              if (currentContent.length > 0) {
                result.push({ role: currentRole, content: currentContent.join('\n').trim() });
                currentContent = [];
              }
              currentRole = 'assistant';
              var cleaned2 = trimmed.replace(/^\{\{char\}\}\s*:\s*/i, '').replace(/^è§’è‰²\s*:\s*/i, '').replace(/^Assistant\s*:\s*/i, '');
              if (cleaned2) currentContent.push(cleaned2);
            } else {
              currentContent.push(trimmed);
            }
          });
          if (currentContent.length > 0) {
            result.push({ role: currentRole, content: currentContent.join('\n').trim() });
          }
        } else if (name.indexOf('jailbreak') >= 0 || name.indexOf('è¶Šç‹±') >= 0
          || name.indexOf('nsfw') >= 0 || name.indexOf('r18') >= 0
          || name.indexOf('r-18') >= 0) {
          result.push({ role: 'system', content: p.content, _isJailbreak: true });
        } else {
          result.push({ role: 'system', content: p.content });
        }
      });
      return result;
    };

    // ============================================================
    //  AI é…ç½®æŒä¹…åŒ–ï¼ˆå«é¢„è®¾ï¼‰
    // ============================================================
    function saveAIConfig() {
      localStorage.setItem(AI_KEY, JSON.stringify({
        url:        apiUrl.value.trim(),
        key:        apiKey.value.trim(),
        model:      modelSelect.value,
        presetList: parsedPresetList,   // â˜… ä¿å­˜é¢„è®¾åˆ—è¡¨
      }));
    }

    function loadAIConfig() {
      try {
        var c = JSON.parse(localStorage.getItem(AI_KEY));
        if (!c) return;
        if (c.url)   apiUrl.value = c.url;
        if (c.key)   apiKey.value = c.key;
        if (c.model) {
          modelSelect.innerHTML = '<option value="' + c.model + '">' + c.model + '</option>';
          modelSelect.value = c.model;
        }
        // â˜… æ¢å¤é¢„è®¾åˆ—è¡¨
        if (c.presetList && Array.isArray(c.presetList) && c.presetList.length > 0) {
          parsedPresetList = c.presetList;
          renderPresetList();
        }
      } catch(e) {}
    }

    apiUrl.addEventListener('input', saveAIConfig);
    apiKey.addEventListener('input', saveAIConfig);
    modelSelect.addEventListener('change', saveAIConfig);
    // ============================================================
    //  PNG å·¥å…·
    // ============================================================
    var crcTable = [];
    for (var n = 0; n < 256; n++) {
      var c = n;
      for (var k = 0; k < 8; k++) c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
      crcTable[n] = c;
    }
    function crc32(arr) { var crc=0^(-1); for(var i=0;i<arr.length;i++) crc=(crc>>>8)^crcTable[(crc^arr[i])&0xFF]; return(crc^(-1))>>>0; }
    function createTextChunk(kw, text) {
      var b64=btoa(unescape(encodeURIComponent(text)));
      var kb=new TextEncoder().encode(kw); var tb=new TextEncoder().encode(b64);
      var d=new Uint8Array(kb.length+1+tb.length); d.set(kb,0); d[kb.length]=0; d.set(tb,kb.length+1);
      var ty=new TextEncoder().encode('tEXt'); var td=new Uint8Array(4+d.length); td.set(ty,0); td.set(d,4);
      var cs=crc32(td); var ch=new Uint8Array(4+4+d.length+4);
      ch[0]=(d.length>>>24)&0xFF; ch[1]=(d.length>>>16)&0xFF; ch[2]=(d.length>>>8)&0xFF; ch[3]=d.length&0xFF;
      ch.set(td,4); ch[ch.length-4]=(cs>>>24)&0xFF; ch[ch.length-3]=(cs>>>16)&0xFF;
      ch[ch.length-2]=(cs>>>8)&0xFF; ch[ch.length-1]=cs&0xFF; return ch;
    }

    // ============================================================
    //  å¤´åƒ
    // ============================================================
    charImageInput.addEventListener('change', function(e) {
      var file = e.target.files[0]; if (!file) return;
      var reader = new FileReader();
      reader.onload = function(ev) {
        var img = new Image();
        img.onload = function() {
          var cv = document.createElement('canvas');
          cv.width = img.width; cv.height = img.height;
          cv.getContext('2d').drawImage(img, 0, 0);
          currentAvatarBase64 = cv.toDataURL('image/png');
          avatarImg.src = currentAvatarBase64;
          avatarImg.style.display = 'block';
          avatarPlaceholder.style.display = 'none';
          debouncedUpdateAndSave();
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    btnExportPNG.addEventListener('click', function() {
      if (!currentAvatarBase64) return alert("âŒ è¯·å…ˆä¸Šä¼ å¤´åƒï¼");
      try {
        var ch  = createTextChunk('chara', JSON.stringify(generateFullJSON()));
        var raw = atob(currentAvatarBase64.split(',')[1]);
        var bytes = new Uint8Array(raw.length);
        for (var i = 0; i < raw.length; i++) bytes[i] = raw.charCodeAt(i);
        var io  = bytes.length - 12;
        var bef = bytes.slice(0, io); var ie = bytes.slice(io);
        var fin = new Uint8Array(bef.length + ch.length + ie.length);
        fin.set(bef, 0); fin.set(ch, bef.length); fin.set(ie, bef.length + ch.length);
        var blob = new Blob([fin], { type: 'image/png' });
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = (charName.value.trim() || 'CharacterCard') + '.png';
        a.click(); URL.revokeObjectURL(a.href);
      } catch(err) { alert("âŒ å¯¼å‡ºå¤±è´¥: " + err.message); }
    });

    // ============================================================
    //  è‰ç¨¿ç³»ç»Ÿ
    // ============================================================
    function genId() { return 'draft_' + Date.now(); }
    function getAllDrafts() { try { return JSON.parse(localStorage.getItem(DRAFTS_KEY)) || {}; } catch(e) { return {}; } }

    function updateDraftDropdown() {
      var dr = getAllDrafts(); draftSelect.innerHTML = '';
      var ks = Object.keys(dr);
      if (!ks.length) { draftSelect.innerHTML = '<option value="">(ç©ºè‰ç¨¿ç®±)</option>'; return; }
      ks.forEach(function(id) {
        var d = dr[id]; var o = document.createElement('option');
        o.value = id;
        o.textContent = d.charName ? (d.charName + ' (' + d.updatedAt + ')') : ('æœªå‘½å (' + d.updatedAt + ')');
        if (id === currentDraftId) o.selected = true;
        draftSelect.appendChild(o);
      });
    }

    function loadDraft(id) {
      var dr = getAllDrafts(); if (!dr[id]) return;
      currentDraftId = id; localStorage.setItem(CURRENT_KEY, id);
      var d = dr[id];
      charName.value     = d.charName     || '';
      wbName.value       = d.wbName       || '';
      charDesc.value     = d.charDesc     || '';
      firstMes.value     = d.firstMes     || '';
      creatorNotes.value = d.creatorNotes || '';
      worldbookEntries   = d.worldbookEntries || [];
      regexScripts       = d.regexScripts     || [];
      tavernHelperScripts = Array.isArray(d.tavernHelperScripts) ? d.tavernHelperScripts : [];
      currentAvatarBase64 = d.avatarBase64    || '';
      window.__altGreetings__ = d.altGreetings || [];
      if (window.__renderAltGreetings__) window.__renderAltGreetings__();
      // â˜… æ¢å¤çŠ¶æ€æ æ•°æ®
      if (d.statusBarData && window.__loadStatusBarData__) {
        window.__loadStatusBarData__(d.statusBarData);
      }
      resetWBForm();
      if (currentAvatarBase64) {
        avatarImg.src = currentAvatarBase64; avatarImg.style.display = 'block'; avatarPlaceholder.style.display = 'none';
      } else {
        avatarImg.style.display = 'none'; avatarPlaceholder.style.display = 'block';
      }
      updateDraftDropdown(); renderEntriesList(); updatePreview();
    }

    function saveCurrentDraft() {
      if (!currentDraftId) currentDraftId = genId();
      var dr = getAllDrafts();
      dr[currentDraftId] = {
        charName:        charName.value.trim(),
        wbName:          wbName.value.trim(),
        charDesc:        charDesc.value.trim(),
        firstMes:        firstMes.value.trim(),
        creatorNotes:    creatorNotes.value.trim(),
        worldbookEntries: worldbookEntries,
        regexScripts:    regexScripts,
        tavernHelperScripts: tavernHelperScripts,
        avatarBase64:    currentAvatarBase64,
        altGreetings:    window.__altGreetings__ || [],
        statusBarData:   window.__getStatusBarData__ ? window.__getStatusBarData__() : null,  // â˜… ä¿å­˜çŠ¶æ€æ 
        updatedAt:       new Date().toLocaleTimeString('zh-CN', { hour12: false })
      };
      try {
        localStorage.setItem(DRAFTS_KEY, JSON.stringify(dr));
        localStorage.setItem(CURRENT_KEY, currentDraftId);
        var o = draftSelect.options[draftSelect.selectedIndex];
        if (o) {
          var dd = dr[currentDraftId];
          o.textContent = dd.charName ? (dd.charName + ' (' + dd.updatedAt + ')') : ('æœªå‘½å (' + dd.updatedAt + ')');
        }
        saveIndicator.style.display = 'inline';
        setTimeout(function() { saveIndicator.style.display = 'none'; }, 1500);
      } catch(e) {}
    }

    btnNewDraft.addEventListener('click', function() {
      currentDraftId = genId();
      charName.value = ''; wbName.value = ''; charDesc.value = ''; firstMes.value = ''; creatorNotes.value = '';
      worldbookEntries = []; regexScripts = []; tavernHelperScripts = []; currentAvatarBase64 = ''; charImageInput.value = '';
      avatarImg.style.display = 'none'; avatarPlaceholder.style.display = 'block';
      window.__altGreetings__ = [];
      if (window.__renderAltGreetings__) window.__renderAltGreetings__();
      // â˜… æ–°å»ºè‰ç¨¿æ—¶é‡ç½®çŠ¶æ€æ 
      if (window.__loadStatusBarData__) window.__loadStatusBarData__(null);
      resetWBForm(); saveCurrentDraft(); updateDraftDropdown(); renderEntriesList(); updatePreview();
    });

    btnDeleteDraft.addEventListener('click', function() {
      if (!currentDraftId || !confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return;
      var dr = getAllDrafts(); delete dr[currentDraftId];
      localStorage.setItem(DRAFTS_KEY, JSON.stringify(dr));
      var ks = Object.keys(dr);
      ks.length > 0 ? loadDraft(ks[0]) : btnNewDraft.click();
    });

    draftSelect.addEventListener('change', function(e) { if (e.target.value) loadDraft(e.target.value); });

    var autoSaveTimer;
    function debouncedUpdateAndSave() {
      clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(function() { updatePreview(); saveCurrentDraft(); }, 500);
    }

    // ============================================================
    //  é¢„è®¾ç³»ç»Ÿ
    // ============================================================
    function renderPresetList() {
      if (!parsedPresetList.length) {
        presetListContainer.style.display = 'none';
        presetStatus.textContent = "æœªæ‰¾åˆ°å¯ç”¨è§„åˆ™";
        return;
      }
      presetListContainer.style.display = 'block';
      presetStatus.textContent = "âœ… é¢„è®¾è½½å…¥æˆåŠŸï¼å·²åŠ è½½ " + parsedPresetList.length + " æ¡è§„åˆ™";
      presetListContainer.innerHTML = parsedPresetList.map(function(it, i) {
        var typeBadge = '';
        var nm = (it.name || '').toLowerCase();
        if (nm.indexOf('example') >= 0 || nm.indexOf('dialogue') >= 0 || nm.indexOf('ç¤ºä¾‹') >= 0) {
          typeBadge = ' <span style="font-size:0.6rem;color:#34d399;background:rgba(16,185,129,0.1);padding:1px 5px;border-radius:4px;">ç¤ºä¾‹å¯¹è¯</span>';
        } else if (nm.indexOf('jailbreak') >= 0 || nm.indexOf('nsfw') >= 0 || nm.indexOf('è¶Šç‹±') >= 0) {
          typeBadge = ' <span style="font-size:0.6rem;color:#f59e0b;background:rgba(245,158,11,0.1);padding:1px 5px;border-radius:4px;">JB</span>';
        } else {
          typeBadge = ' <span style="font-size:0.6rem;color:#94a3b8;background:rgba(100,116,139,0.1);padding:1px 5px;border-radius:4px;">system</span>';
        }
        return '<div class="preset-item"><input type="checkbox" id="preset_chk_' + i + '" data-index="' + i + '"' + (it.enabled ? ' checked' : '') + ' /><label for="preset_chk_' + i + '">' + it.name + typeBadge + '</label></div>';
      }).join('');

      presetListContainer.querySelectorAll('input[type="checkbox"]').forEach(function(chk) {
        chk.addEventListener('change', function(e) {
          parsedPresetList[parseInt(e.target.getAttribute('data-index'))].enabled = e.target.checked;
          saveAIConfig();  // â˜… å‹¾é€‰å˜åŒ–æ—¶ä¿å­˜
        });
      });
    }

    presetInput.addEventListener('change', function(e) {
      var file = e.target.files[0]; if (!file) return;
      var reader = new FileReader();
      reader.onload = function(ev) {
        try {
          var data = JSON.parse(ev.target.result);
          parsedPresetList = [];
          if (data.prompts) {
            var ao = (data.prompt_order && data.prompt_order.length > 0)
              ? data.prompt_order[data.prompt_order.length - 1].order : [];
            var ei = ao.filter(function(i) { return i.enabled; }).map(function(i) { return i.identifier; });
            data.prompts.forEach(function(p) {
              if (p.content && !p.marker) {
                parsedPresetList.push({
                  id:                 p.identifier,
                  name:               p.name || 'è§„åˆ™',
                  content:            p.content,
                  role:               p.role || 'system',
                  injection_position: p.injection_position || 0,
                  injection_depth:    p.injection_depth || 4,
                  enabled:            ao.length > 0 ? ei.indexOf(p.identifier) >= 0 : true
                });
              }
            });
          }
          renderPresetList();
          saveAIConfig();  // â˜… å¯¼å…¥åç«‹å³ä¿å­˜
        } catch(err) {
          presetStatus.innerHTML = "âŒ è§£æå¤±è´¥: " + err.message;
          presetStatus.style.color = '#ef4444';
          presetListContainer.style.display = 'none';
        }
      };
      reader.readAsText(file);
    });

    // ============================================================
    //  å·¥å…·å‡½æ•°
    // ============================================================
    function extractJsonObj(text) {
      var m = text.match(/```json\s*([\s\S]*?)\s*```/);
      var o = m ? JSON.parse(m[1]) : JSON.parse(text);
      return (Array.isArray(o) && o.length > 0) ? o[0] : o;
    }
    function extractJsonArray(text) {
      var m = text.match(/```json\s*([\s\S]*?)\s*```/);
      var raw = m ? m[1].trim() : text.trim();
      var p = JSON.parse(raw);
      return Array.isArray(p) ? p : [p];
    }
    function getActivePresetsStr() {
      return parsedPresetList.filter(function(p) { return p.enabled; })
        .map(function(p) { return '[è§„åˆ™: ' + p.name + ']\n' + p.content; }).join('\n\n');
    }
    function sleep(ms) { return new Promise(function(r) { setTimeout(r, ms); }); }

    // ============================================================
    //  è”ç½‘æœç´¢
    // ============================================================
    async function performSearchIfEnabled(userQuery) {
      var sc = window.__searchConfig__;
      if (!sc || !sc.isEnabled()) return { searchText: '', searchResults: null, mode: 'off' };
      var engine = sc.getEngine();
      var customQuery = sc.getCustomQuery();
      var query = customQuery || userQuery;
      var count = sc.getResultCount();
      var lang  = sc.getLang();
      if (engine !== 'none') {
        try {
          var results = await sc.executeSearch(query, count, lang);
          if (results && results.length > 0) {
            cachedSearchResults = results;
            return { searchText: sc.formatForPrompt(results), searchResults: results, mode: 'engine' };
          }
        } catch(err) {
          return { searchText: buildAINativeSearchPrompt(query), searchResults: null, mode: 'ai_fallback', error: err.message };
        }
      }
      return { searchText: buildAINativeSearchPrompt(query), searchResults: null, mode: 'ai_native' };
    }

    function buildAINativeSearchPrompt(query) {
      return '\n\nã€ğŸŒ è”ç½‘æœç´¢æŒ‡ä»¤ã€‘ï¼š\n'
        + 'è¯·ä½¿ç”¨ä½ çš„è”ç½‘æœç´¢èƒ½åŠ›ï¼Œæœç´¢ä»¥ä¸‹å…³é”®è¯ç›¸å…³çš„èµ„æ–™ä½œä¸ºåˆ›ä½œå‚è€ƒï¼š\n'
        + 'æœç´¢è¯ï¼šã€Œ' + query + 'ã€\n'
        + 'è¯·åŸºäºæœç´¢åˆ°çš„çœŸå®ä¿¡æ¯ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰æ¥ä¸°å¯Œä½ çš„åˆ›ä½œï¼Œä½¿è®¾å®šæ›´åŠ çœŸå®ã€æœ‰æ·±åº¦ã€‚\n'
        + 'å¦‚æœä½ ä¸å…·å¤‡è”ç½‘èƒ½åŠ›ï¼Œè¯·å¿½ç•¥æ­¤æŒ‡ä»¤ï¼Œç›´æ¥åŸºäºä½ çš„çŸ¥è¯†åº“åˆ›ä½œã€‚\n';
    }

    // ============================================================
    //  AI æ¨¡å‹æ‹‰å–
    // ============================================================
    btnFetchModels.addEventListener('click', async function() {
      var url = apiUrl.value.replace(/\/$/, '') + '/models';
      var key = apiKey.value.trim();
      btnFetchModels.textContent = 'â³...'; btnFetchModels.disabled = true;
      try {
        var h = { 'Content-Type': 'application/json' };
        if (key) h['Authorization'] = 'Bearer ' + key;
        var res = await fetch(url, { headers: h });
        var result = await res.json();
        var models = Array.isArray(result.data)
          ? result.data.map(function(m) { return m.id; })
          : Array.isArray(result) ? result.map(function(m) { return m.id || m.name; }) : [];
        models.sort();
        modelSelect.innerHTML = models.map(function(m) { return '<option value="' + m + '">' + m + '</option>'; }).join('');
        var saved = {}; try { saved = JSON.parse(localStorage.getItem(AI_KEY)) || {}; } catch(e) {}
        if (saved.model && models.indexOf(saved.model) >= 0) modelSelect.value = saved.model;
        saveAIConfig();
        aiStatus.textContent = 'âœ… æˆåŠŸè·å– ' + models.length + ' ä¸ªæ¨¡å‹ï¼'; aiStatus.style.color = '#10b981';
      } catch(err) { aiStatus.textContent = 'âŒ ' + err.message; aiStatus.style.color = '#ef4444'; }
      finally { btnFetchModels.textContent = 'ğŸ”„ æ‹‰å–å¯ç”¨æ¨¡å‹'; btnFetchModels.disabled = false; }
    });

    // ============================================================
    //  AI ä¸€é”®ç”Ÿæˆ
    // ============================================================
    btnAiGenerate.addEventListener('click', async function() {
      var url   = apiUrl.value.replace(/\/$/, '') + '/chat/completions';
      var key   = apiKey.value.trim();
      var model = modelSelect.value;
      if (!model) return alert('è¯·å…ˆæ‹‰å–æ¨¡å‹ï¼');
      if (!aiPrompt.value.trim()) return alert('è¯·å¡«å†™è§’è‰²è®¾å®šæç¤ºè¯ï¼');

      var skeletonCount = window.__getSkeletonCount__ ? window.__getSkeletonCount__() : 6;
      var searchEnabled = window.__searchConfig__ && window.__searchConfig__.isEnabled();
      var totalSteps    = (searchEnabled ? 1 : 0) + 1 + Math.ceil(skeletonCount / 5);
      var currentStep   = 0;
      var hacker        = window.__hackerAnim__;

      btnAiGenerate.disabled = true;
      cachedSearchResults = null;

      if (hacker) { hacker.start(); hacker.setPhase('âš¡ åˆå§‹åŒ–å¼•æ“...'); hacker.setProgress(0, totalSteps); hacker.setDetail(hacker.randomMsg()); }

      try {
        var headers = { 'Content-Type': 'application/json' };
        if (key) headers['Authorization'] = 'Bearer ' + key;
        var presetsStr = getActivePresetsStr();
        var searchInjection = '';

        // é˜¶æ®µ0ï¼šè”ç½‘æœç´¢
        if (searchEnabled) {
          currentStep++;
          if (hacker) { hacker.setPhase('ğŸŒ [é˜¶æ®µ ' + currentStep + '/' + totalSteps + '] è”ç½‘æœç´¢èµ„æ–™...'); hacker.setProgress(currentStep, totalSteps); hacker.setDetail('æ­£åœ¨æ‰«æäº’è”ç½‘æ•°æ®èŠ‚ç‚¹...'); }
          aiStatus.textContent = 'ğŸŒ è”ç½‘æœç´¢ä¸­...'; aiStatus.style.color = '#38bdf8';
          var searchResult = await performSearchIfEnabled(aiPrompt.value.trim());
          searchInjection = searchResult.searchText || '';
          if (searchResult.mode === 'engine') { if (hacker) hacker.setDetail('âœ… æœç´¢å®Œæˆï¼Œè·å–åˆ° ' + searchResult.searchResults.length + ' æ¡å‚è€ƒèµ„æ–™'); }
          else if (searchResult.mode === 'ai_native') { if (hacker) hacker.setDetail('â„¹ï¸ ä½¿ç”¨ AI è‡ªå¸¦è”ç½‘èƒ½åŠ›'); }
          else if (searchResult.mode === 'ai_fallback') { if (hacker) hacker.setDetail('âš ï¸ æœç´¢å¼•æ“å‡ºé”™ï¼Œé™çº§ä¸º AI è”ç½‘: ' + (searchResult.error || '')); }
          await sleep(400);
        }

        // é˜¶æ®µ1ï¼šç”Ÿæˆè§’è‰²
        currentStep++;
        if (hacker) { hacker.setPhase('ğŸ§¬ [é˜¶æ®µ ' + currentStep + '/' + totalSteps + '] æ„å»ºè§’è‰²çµé­‚...'); hacker.setProgress(currentStep, totalSteps); hacker.setDetail(hacker.randomMsg()); }
        aiStatus.textContent = 'â³ [é˜¶æ®µ 1] æ„æ€è§’è‰²è®¾å®š...'; aiStatus.style.color = '#38bdf8';

        var p1Sys = 'ç”Ÿæˆè§’è‰²åŸºç¡€å±æ€§ï¼Œä»…è¾“å‡ºJSONå¯¹è±¡ã€‚æ ¼å¼ï¼š{ "charName": "è§’è‰²å", "wbName": "ä¸–ç•Œä¹¦å", "charDesc": "è¯¦ç»†çš„è§’è‰²æè¿°(è‡³å°‘200å­—ï¼ŒåŒ…å«å¤–è²Œã€æ€§æ ¼ã€èƒŒæ™¯ã€èƒ½åŠ›)", "firstMes": "æ²‰æµ¸æ„Ÿå¼ºçš„å¼€åœºç™½(è‡³å°‘150å­—)", "creatorNotes": "ç»™ä½¿ç”¨è€…çš„è¯´æ˜", "altGreetings": ["å¤‡é€‰å¼€åœºç™½1(ä¸åŒåœºæ™¯æˆ–æ°›å›´)", "å¤‡é€‰å¼€åœºç™½2"] }'
          + (presetsStr ? '\nã€æ–‡é£è¦æ±‚ã€‘ï¼š\n' + presetsStr : '')
          + searchInjection;

        var r1 = await fetch(url, { method: 'POST', headers: headers, body: JSON.stringify({ model: model, messages: [{ role: "system", content: p1Sys }, { role: "user", content: aiPrompt.value.trim() }], temperature: 0.85 }) });
        if (!r1.ok) throw new Error('è§’è‰²ç”Ÿæˆå¤±è´¥ HTTP ' + r1.status);
        var charData = extractJsonObj((await r1.json()).choices[0].message.content);

        charName.value     = charData.charName     || '';
        wbName.value       = charData.wbName       || '';
        charDesc.value     = charData.charDesc     || '';
        firstMes.value     = charData.firstMes     || '';
        creatorNotes.value = charData.creatorNotes || '';
        window.__altGreetings__ = (charData.altGreetings && Array.isArray(charData.altGreetings)) ? charData.altGreetings : [];
        if (window.__renderAltGreetings__) window.__renderAltGreetings__();
        worldbookEntries = [];
        debouncedUpdateAndSave();
        if (hacker) hacker.setDetail('âœ… è§’è‰²ã€Œ' + (charData.charName || '???') + 'ã€é”»é€ å®Œæˆ');
        await sleep(500);

        // é˜¶æ®µ2+ï¼šæ‰¹é‡ç”Ÿæˆä¸–ç•Œä¹¦éª¨æ¶
        var wbGoal    = wbPrompt.value.trim();
        var remaining = skeletonCount;
        var batchIndex = 0;

        while (remaining > 0) {
          var batchSize = Math.min(remaining, 5);
          batchIndex++; currentStep++;
          if (hacker) { hacker.setPhase('ğŸ¦´ [é˜¶æ®µ ' + currentStep + '/' + totalSteps + '] ä¸–ç•Œä¹¦éª¨æ¶ (æ‰¹æ¬¡ ' + batchIndex + ')'); hacker.setProgress(currentStep, totalSteps); hacker.setDetail(hacker.randomMsg()); }
          aiStatus.textContent = 'â³ ç”Ÿæˆä¸–ç•Œä¹¦éª¨æ¶... ' + worldbookEntries.length + '/' + skeletonCount;

          var existingTitles = worldbookEntries.map(function(e) { return e.comment; }).join('ã€');
          var existingRef    = existingTitles ? '\nã€å·²æœ‰æ¡ç›®(ç¦æ­¢é‡å¤)ã€‘ï¼š' + existingTitles : '';

          var skSys = 'ä½ æ˜¯ä¸€ä¸ªé…’é¦†V3ä¸–ç•Œä¹¦éª¨æ¶ç”Ÿæˆå™¨ã€‚å¿«é€Ÿäº§å‡ºã€' + batchSize + 'æ¡ã€‘ç®€çŸ­éª¨æ¶ã€‚'
            + '\næ¯æ¡åªéœ€ï¼šcomment(æ ‡é¢˜)ã€content(ä¸€å¥è¯20-40å­—)ã€keys(1-3ä¸ªè§¦å‘è¯)ã€strategy("selective"æˆ–"constant")'
            + '\nã€è§’è‰²ã€‘ï¼š' + charName.value.trim() + ' | ' + charDesc.value.trim().substring(0, 300)
            + existingRef
            + (wbGoal ? '\nã€æ–¹å‘ã€‘ï¼š' + wbGoal : '')
            + (presetsStr ? '\nã€æ–‡é£ã€‘ï¼š' + presetsStr.substring(0, 200) : '')
            + searchInjection
            + '\nã€è¾“å‡ºã€‘ï¼šJSONæ•°ç»„ [{ "comment":"===æ ‡é¢˜===", "content":"ä¸€å¥è¯", "keys":["è¯"], "strategy":"selective" }, ...]'
            + '\nè¦æ±‚ï¼šæç®€ã€ä¸é‡å¤ã€è¦†ç›–å¤šç»´åº¦ï¼ˆåœ°ç‚¹/äººç‰©/ç»„ç»‡/ç‰©å“/äº‹ä»¶/è§„åˆ™ï¼‰';

          try {
            var r2 = await fetch(url, { method: 'POST', headers: headers, body: JSON.stringify({ model: model, messages: [{ role: "system", content: skSys }, { role: "user", content: 'ç”Ÿæˆ' + batchSize + 'æ¡éª¨æ¶' }], temperature: 0.9 }) });
            if (!r2.ok) throw new Error('HTTP ' + r2.status);
            var rawC = (await r2.json()).choices[0].message.content;
            var skeletons;
            try { skeletons = extractJsonArray(rawC); } catch(pe) { try { skeletons = [extractJsonObj(rawC)]; } catch(e2) { throw new Error('è¿”å›æ ¼å¼å¼‚å¸¸'); } }
            skeletons.forEach(function(sk) {
              if (!sk || !sk.comment) return;
              worldbookEntries.push({ comment: sk.comment || 'æœªå‘½å', content: sk.content || '(å¾…å±•å¼€)', keys: Array.isArray(sk.keys) ? sk.keys : [], strategy: sk.strategy || 'selective', position: 4, depth: 4, role: 0, order: 100, prob: 100 });
            });
            renderEntriesList(); debouncedUpdateAndSave();
            if (hacker) hacker.setDetail('âœ… æ‰¹æ¬¡ ' + batchIndex + ' å®Œæˆï¼Œå·² ' + worldbookEntries.length + ' æ¡');
            await sleep(300);
          } catch(bErr) {
            if (hacker) hacker.setDetail('âš ï¸ æ‰¹æ¬¡ ' + batchIndex + ': ' + bErr.message);
            await sleep(500);
          }
          remaining -= batchSize;
        }

        // å®Œæˆ
        if (hacker) {
          hacker.stop(); hacker.setPhase('ğŸ‰ ç”Ÿæˆå®Œæ¯•ï¼'); hacker.setProgress(totalSteps, totalSteps);
          var doneMsg = 'è§’è‰²ã€Œ' + charName.value.trim() + 'ã€+ ' + worldbookEntries.length + ' æ¡éª¨æ¶å·²å°±ç»ªã€‚';
          if (searchEnabled && cachedSearchResults) doneMsg += ' (å‚è€ƒäº† ' + cachedSearchResults.length + ' æ¡æœç´¢ç»“æœ)';
          doneMsg += ' è¯·ç”¨ã€Œâœ¨ AIé‡å†™ã€é€æ¡å±•å¼€ã€‚';
          hacker.setDetail(doneMsg);
          setTimeout(function() { if (hacker) hacker.hide(); }, 5000);
        }
        aiStatus.textContent = 'âœ… å®Œæ¯•ï¼' + worldbookEntries.length + ' æ¡éª¨æ¶' + (searchEnabled ? ' (å·²è”ç½‘)' : '') + 'ã€‚è¯·é€æ¡å±•å¼€ã€‚';
        aiStatus.style.color = '#10b981';

      } catch(err) {
        if (hacker) { hacker.stop(); hacker.setPhase('âŒ ä¸­æ­¢'); hacker.setDetail(err.message); setTimeout(function() { hacker.hide(); }, 3000); }
        aiStatus.textContent = 'âŒ ä¸­æ­¢: ' + err.message; aiStatus.style.color = '#ef4444';
      } finally { btnAiGenerate.disabled = false; }
    });

    // ============================================================
    //  AI å•æ¡è¿½åŠ 
    // ============================================================
    async function generateContextAwareWBEntry(customDirection, stepInfo) {
      if (!stepInfo) stepInfo = '';
      var url   = apiUrl.value.replace(/\/$/, '') + '/chat/completions';
      var key   = apiKey.value.trim();
      var model = modelSelect.value;
      var searchInjection = '';
      if (window.__searchConfig__ && window.__searchConfig__.isEnabled()) {
        var sq = customDirection || charName.value.trim() + ' ' + charDesc.value.trim().substring(0, 100);
        var sr = await performSearchIfEnabled(sq);
        searchInjection = sr.searchText || '';
      }
      var existingCtx = worldbookEntries.map(function(e) { return '[æ ‡é¢˜:' + e.comment + '] (ç­–ç•¥:' + e.strategy + '): ' + e.content; }).join('\n-----\n');
      var ctxStr      = existingCtx ? '\nã€å·²æœ‰è®¾å®š(ä¸å¯é‡å¤)ã€‘ï¼š\n' + existingCtx : '\nã€å½“å‰ä¸–ç•Œä¹¦ä¸ºç©ºã€‘';
      var presetsStr  = getActivePresetsStr();
      var presetBlock = presetsStr ? '\n\nã€æ–‡é£çº¦æŸã€‘ï¼š\n' + presetsStr : '';
      var includeChar = wbIncludeCharData && wbIncludeCharData.checked;
      var charBlock   = includeChar ? '\nã€è§’è‰²ã€‘ï¼š' + charName.value.trim() + ' | ' + charDesc.value.trim() + '\n' : '';
      var sysPrompt   = 'ä½ æ˜¯ä¸€ä¸ªé…’é¦†V3ä¸–ç•Œä¹¦è¯æ¡æ„å»ºå¤§å¸ˆã€‚è¯·ç”Ÿæˆã€ä»…ä»…1æ¡ã€‘è¯¦ç»†å®Œæ•´çš„è®¾å®šã€‚' + stepInfo + charBlock + '\n' + ctxStr + '\n' + presetBlock + searchInjection + '\nã€è¾“å‡ºã€‘ï¼š1ä¸ªJSONå¯¹è±¡ { "comment": "æ ‡é¢˜", "content": "è¯¦ç»†è®¾å®š(è‡³å°‘100å­—)", "keys": ["è§¦å‘è¯"], "strategy": "selective æˆ– constant", "position": 4 }';
      var userPrompt  = customDirection ? 'ã€æ–¹å‘ã€‘ï¼š' + customDirection : 'ã€è‡ªç”±å‘æŒ¥ï¼Œæ‹’ç»é‡å¤ã€‘';
      var headers     = { 'Content-Type': 'application/json' };
      if (key) headers['Authorization'] = 'Bearer ' + key;
      var res = await fetch(url, { method: 'POST', headers: headers, body: JSON.stringify({ model: model, messages: [{ role: "system", content: sysPrompt }, { role: "user", content: userPrompt }], temperature: 0.8 }) });
      if (!res.ok) throw new Error('è¯·æ±‚å¤±è´¥ HTTP ' + res.status);
      var entry = extractJsonObj((await res.json()).choices[0].message.content);
      worldbookEntries.push({ comment: entry.comment || 'æ‹“å±•è®¾å®š', content: entry.content || '', keys: Array.isArray(entry.keys) ? entry.keys : [], strategy: entry.strategy || 'selective', position: parseInt(entry.position) || 4, depth: 4, role: 0, order: 100, prob: 100 });
    }

    btnAiSingleWb.addEventListener('click', async function() {
      if (!modelSelect.value) return alert('è¯·å…ˆé€‰æ‹©æ¨¡å‹ï¼');
      btnAiSingleWb.disabled = true; btnAiSingleWb.textContent = "â³ Rollä¸­...";
      try { await generateContextAwareWBEntry(wbSinglePrompt.value.trim(), "å•æ¡è¡¥å……ã€‚"); renderEntriesList(); debouncedUpdateAndSave(); wbSinglePrompt.value = ''; }
      catch(err) { alert('ç”Ÿæˆå¤±è´¥: ' + err.message); }
      finally { btnAiSingleWb.disabled = false; btnAiSingleWb.textContent = "ğŸ² ç”Ÿæˆ 1 æ¡"; }
    });

    // ============================================================
    //  ä¸–ç•Œä¹¦æ¡ç›®ç®¡ç†
    // ============================================================
    function resetWBForm() {
      editingIndex = -1; entryComment.value = ''; entryContent.value = ''; entryKeys.value = '';
      entryStrategy.value = 'selective'; entryPosition.value = '4'; entryDepth.value = '4';
      entryRole.value = '0'; entryOrder.value = '100'; entryProb.value = '100';
      btnAddEntry.textContent = 'â• ä¿å­˜åˆ°åˆ—è¡¨'; btnAddEntry.style.backgroundColor = '#059669';
    }

    function editEntry(index) {
      editingIndex = index; var e = worldbookEntries[index];
      entryComment.value = e.comment || ''; entryContent.value = e.content || '';
      entryKeys.value = (e.keys || []).join(', '); entryStrategy.value = e.strategy || 'selective';
      entryPosition.value = String(e.position || 4); entryDepth.value = String(e.depth || 4);
      entryRole.value = String(e.role || 0); entryOrder.value = String(e.order || 100); entryProb.value = String(e.prob || 100);
      btnAddEntry.textContent = 'ğŸ’¾ ç¡®è®¤è¦†ç›–'; btnAddEntry.style.backgroundColor = '#d97706';
      btnAddEntry.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    async function aiRewriteEntry(index, req, btn) {
      var url = apiUrl.value.replace(/\/$/, '') + '/chat/completions'; var key = apiKey.value.trim(); var model = modelSelect.value;
      if (!model) return alert('è¯·å…ˆé€‰æ‹©æ¨¡å‹ï¼');
      var old = worldbookEntries[index]; var oldText = btn.textContent; btn.disabled = true; btn.textContent = "â³ é‡é“¸ä¸­...";
      var presetsStr = getActivePresetsStr();
      var isSkeleton = old.content.length < 60;
      var expandHint = isSkeleton ? '\n\nã€é‡è¦ã€‘ï¼šåŸæ¡ç›®æ˜¯éª¨æ¶æ¦‚è¦ï¼Œè¯·å±•å¼€ä¸ºå®Œæ•´è¯¦ç»†çš„ä¸–ç•Œä¹¦è®¾å®šè¯æ¡ï¼ˆè‡³å°‘150å­—ï¼‰ï¼Œä¿ç•™æ–¹å‘ä½†å¤§å¹…æ‰©å……ã€‚' : '';
      var searchInjection = '';
      if (window.__searchConfig__ && window.__searchConfig__.isEnabled()) {
        var sq = old.comment + ' ' + (req || '');
        var sr = await performSearchIfEnabled(sq);
        searchInjection = sr.searchText || '';
      }
      var sys = 'ä½ æ˜¯ä¸€ä¸ªé…’é¦†V3è¯æ¡æ¶¦è‰²å¤§å¸ˆã€‚ä¿®æ”¹ä¸€ä¸ªã€å·²å­˜åœ¨çš„è¯æ¡ã€‘ã€‚\nã€åŸè¯æ¡ã€‘: æ ‡é¢˜: ' + old.comment + ' | ç­–ç•¥: ' + old.strategy + ' | è§¦å‘è¯: ' + old.keys.join(',') + '\nå†…å®¹: ' + old.content + (presetsStr ? '\nã€æ–‡é£ã€‘ï¼š\n' + presetsStr : '') + expandHint + searchInjection + '\nã€ä»»åŠ¡ã€‘ï¼šé‡å†™ã€‚è¾“å‡ºJSONï¼š{ "comment": "æ ‡é¢˜", "content": "è¯¦ç»†è®¾å®š", "keys": ["è§¦å‘è¯"], "strategy": "selective æˆ– constant", "position": ' + old.position + ' }';
      try {
        var h = { 'Content-Type': 'application/json' }; if (key) h['Authorization'] = 'Bearer ' + key;
        var res = await fetch(url, { method: 'POST', headers: h, body: JSON.stringify({ model: model, messages: [{ role: "system", content: sys }, { role: "user", content: isSkeleton ? 'å°†éª¨æ¶å±•å¼€ä¸ºå®Œæ•´è®¾å®šã€‚' + (req ? ' é¢å¤–è¦æ±‚ï¼š' + req : '') : 'ä¿®æ”¹è¦æ±‚ï¼š' + req }], temperature: 0.8 }) });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        var ed = extractJsonObj((await res.json()).choices[0].message.content);
        worldbookEntries[index].comment = ed.comment || old.comment;
        worldbookEntries[index].content = ed.content || old.content;
        if (ed.keys) worldbookEntries[index].keys = Array.isArray(ed.keys) ? ed.keys : [];
        if (ed.strategy) worldbookEntries[index].strategy = ed.strategy;
        renderEntriesList(); debouncedUpdateAndSave();
      } catch(err) { alert('é‡å†™å¤±è´¥: ' + err.message); }
      finally { btn.disabled = false; btn.textContent = oldText || 'âœ¨ AIé‡å†™'; }
    }

    function renderEntriesList() {
      entriesList.innerHTML = worldbookEntries.length ? '' : '<span style="color:#475569;font-size:0.8rem;">æš‚æ— æ¡ç›®</span>';
      var posMap = ["0å‰","1å","2å‰EM","3åEM","4æ·±åº¦","5å‰AN","6åAN"];
      worldbookEntries.forEach(function(entry, index) {
        var isSk = entry.content.length < 60;
        var skBadge = isSk ? '<span style="font-size:0.6rem;background:rgba(245,158,11,0.15);color:#f59e0b;padding:1px 6px;border-radius:99px;margin-left:6px;border:1px solid rgba(245,158,11,0.25);">ğŸ¦´ éª¨æ¶</span>' : '';
        var div = document.createElement('div'); div.className = 'entry-item fade-in';
        div.innerHTML = '<div class="entry-item-header"><div class="entry-info"><h4>' + (entry.comment || 'æœªå‘½å') + ' <span style="color:#8b5cf6;font-size:0.7rem;opacity:0.8;">[' + entry.strategy + ']</span>' + skBadge + '</h4><p>ä½ç½®: ' + (posMap[entry.position] || entry.position) + ' | é¡ºåº: ' + entry.order + ' | æ·±åº¦: ' + entry.depth + ' | æ¦‚ç‡: ' + entry.prob + '%</p><p>è§¦å‘è¯: ' + ((entry.keys || []).join(', ') || 'æ— ') + '</p>' + (isSk ? '<p style="color:#f59e0b;font-size:0.7rem;margin-top:4px;">ğŸ’¡ ç‚¹å‡»ã€Œâœ¨ AIé‡å†™ã€å±•å¼€ä¸ºå®Œæ•´è®¾å®š</p>' : '') + '</div><div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;max-width:160px;"><button class="btn btn-edit" data-index="' + index + '" style="width:auto;padding:4px 8px;font-size:0.75rem;background-color:#3b82f6;">âœï¸ ç¼–è¾‘</button><button class="btn btn-toggle-reroll" data-index="' + index + '" style="width:auto;padding:4px 8px;font-size:0.75rem;background:linear-gradient(135deg,#8b5cf6,#6d28d9);">âœ¨ AIé‡å†™</button><button class="btn btn-delete" data-index="' + index + '" style="width:auto;padding:4px 8px;font-size:0.75rem;">ğŸ—‘ï¸</button></div></div><div id="reroll_area_' + index + '" style="display:none;width:100%;margin-top:12px;padding-top:12px;border-top:1px dashed #334155;"><input type="text" id="reroll_prompt_' + index + '" placeholder="' + (isSk ? 'å¯ç•™ç©ºç›´æ¥å±•å¼€ï¼Œæˆ–è¾“å…¥é¢å¤–è¦æ±‚...' : 'æ€ä¹ˆä¿®æ”¹ï¼Ÿ') + '" style="width:100%;padding:8px;margin-bottom:8px;" /><button class="btn btn-submit-reroll" data-index="' + index + '" style="background:linear-gradient(135deg,#8b5cf6,#6d28d9);padding:8px;font-size:0.85rem;">' + (isSk ? 'ğŸ¦´â†’ğŸ“– å±•å¼€ä¸ºå®Œæ•´è®¾å®š' : 'ğŸ² ç¡®å®šè¦†ç›–é‡å†™') + '</button></div>';
        entriesList.appendChild(div);
      });
      document.querySelectorAll('.btn-edit').forEach(function(b) { b.addEventListener('click', function(e) { editEntry(parseInt(e.currentTarget.getAttribute('data-index'))); }); });
      document.querySelectorAll('.btn-toggle-reroll').forEach(function(b) { b.addEventListener('click', function(e) { var a = document.getElementById('reroll_area_' + e.currentTarget.getAttribute('data-index')); a.style.display = a.style.display === 'none' ? 'block' : 'none'; }); });
      document.querySelectorAll('.btn-submit-reroll').forEach(function(b) { b.addEventListener('click', async function(e) { var idx = parseInt(e.currentTarget.getAttribute('data-index')); var req = document.getElementById('reroll_prompt_' + idx).value.trim(); var isSk = worldbookEntries[idx].content.length < 60; if (!isSk && !req) return alert('è¯·å¡«å†™ä¿®æ”¹è¦æ±‚ï¼'); await aiRewriteEntry(idx, req, e.currentTarget); }); });
      document.querySelectorAll('.btn-delete').forEach(function(b) { b.addEventListener('click', function(e) { var idx = parseInt(e.currentTarget.getAttribute('data-index')); worldbookEntries.splice(idx, 1); if (editingIndex === idx) resetWBForm(); renderEntriesList(); debouncedUpdateAndSave(); }); });
    }

    btnAddEntry.addEventListener('click', function() {
      if (!entryContent.value.trim()) return alert('å†…å®¹ä¸èƒ½ä¸ºç©ºï¼');
      var ne = { comment: entryComment.value.trim(), content: entryContent.value.trim(), keys: entryKeys.value.split(',').map(function(k) { return k.trim(); }).filter(function(k) { return k; }), strategy: entryStrategy.value, position: parseInt(entryPosition.value), depth: parseInt(entryDepth.value) || 4, role: parseInt(entryRole.value) || 0, order: parseInt(entryOrder.value) || 100, prob: parseInt(entryProb.value) || 100 };
      if (editingIndex >= 0) worldbookEntries[editingIndex] = ne; else worldbookEntries.push(ne);
      resetWBForm(); renderEntriesList(); debouncedUpdateAndSave();
    });

    // ============================================================
    //  AI æ™ºèƒ½æ•´ç†ä¸–ç•Œä¹¦å‚æ•°
    // ============================================================
    var btnAiOrganize    = document.getElementById('btnAiOrganize');
    var organizePreview  = document.getElementById('organizePreview');
    var organizeStatus   = document.getElementById('organizeStatus');
    var pendingOrganizeData = null;

    btnAiOrganize.addEventListener('click', async function() {
      if (worldbookEntries.length === 0) return alert('ä¸–ç•Œä¹¦ä¸ºç©ºï¼Œæ²¡æœ‰å¯æ•´ç†çš„æ¡ç›®ï¼');
      var url = apiUrl.value.replace(/\/$/, '') + '/chat/completions';
      var key = apiKey.value.trim(); var model = modelSelect.value;
      if (!model) return alert('è¯·å…ˆé€‰æ‹© AI æ¨¡å‹ï¼');
      btnAiOrganize.disabled = true; btnAiOrganize.textContent = 'â³ AI åˆ†æä¸­...';
      organizeStatus.textContent = 'ğŸ” æ­£åœ¨åˆ†æ ' + worldbookEntries.length + ' æ¡ä¸–ç•Œä¹¦æ¡ç›®...';
      organizeStatus.style.color = '#38bdf8';
      organizePreview.style.display = 'none'; pendingOrganizeData = null;

      var entrySummaries = worldbookEntries.map(function(e, i) {
        return { index: i, title: e.comment || 'æœªå‘½å', content_preview: (e.content || '').substring(0, 150), strategy: e.strategy, keys: (e.keys || []).join(', '), current_depth: e.depth, current_order: e.order, current_prob: e.prob };
      });

      var sysPrompt = 'ä½ æ˜¯ SillyTavern ä¸–ç•Œä¹¦å‚æ•°ä¼˜åŒ–ä¸“å®¶ã€‚è¯·æ ¹æ®æ¯ä¸ªæ¡ç›®çš„å†…å®¹ç±»å‹å’Œé‡è¦æ€§ï¼Œä¸ºå®ƒä»¬åˆ†é…æœ€ä½³çš„ depthï¼ˆæ·±åº¦ï¼‰ã€orderï¼ˆæ’å…¥é¡ºåºï¼‰å’Œ probabilityï¼ˆè§¦å‘æ¦‚ç‡ï¼‰ã€‚\n\nã€å‚æ•°è¯´æ˜ã€‘ï¼š\nâ€¢ depthï¼ˆæ·±åº¦ 0-999ï¼‰ï¼šæ•°å€¼è¶Šå°è¶Šé è¿‘æœ€æ–°å¯¹è¯ã€‚æ ¸å¿ƒè®¾å®š depth=1-2ï¼Œé‡è¦è®¾å®š depth=3-4ï¼ŒèƒŒæ™¯è®¾å®š depth=5-8ï¼Œå†·é—¨/å½©è›‹ depth=8-15\nâ€¢ orderï¼ˆæ’å…¥é¡ºåº 0-999ï¼‰ï¼šåŒæ·±åº¦æ—¶çš„ä¼˜å…ˆçº§ï¼Œæ•°å€¼è¶Šå¤§è¶Šå…ˆå¤„ç†ã€‚æ ¸å¿ƒè§„åˆ™ order=900-1000ï¼Œé‡è¦ order=500-800ï¼Œæ™®é€š order=100-400ï¼Œä½ä¼˜å…ˆ order=10-99\nâ€¢ probabilityï¼ˆè§¦å‘æ¦‚ç‡ 1-100ï¼‰ï¼šå¸¸é©»æ¡ç›®å»ºè®®100%ï¼Œæ™®é€šè§¦å‘æ¡ç›®80-100%ï¼Œæ°›å›´/éšæœºäº‹ä»¶50-80%ï¼Œå½©è›‹/ç¨€æœ‰äº‹ä»¶10-40%\n\nã€åˆ†ç±»å‚è€ƒã€‘ï¼š\n- æ ¸å¿ƒä¸–ç•Œè§‚/è§„åˆ™/ç³»ç»Ÿ â†’ depth=1, order=900+, prob=100\n- ä¸»è¦è§’è‰²/é‡è¦NPC â†’ depth=2-3, order=600-800, prob=100\n- åœ°ç‚¹/ç»„ç»‡/åŠ¿åŠ› â†’ depth=3-5, order=300-500, prob=90-100\n- ç‰©å“/æŠ€èƒ½/é“å…· â†’ depth=4-6, order=200-400, prob=80-100\n- äº‹ä»¶/å‰§æƒ…/ä»»åŠ¡ â†’ depth=4-6, order=200-400, prob=70-90\n- èƒŒæ™¯çŸ¥è¯†/å†å² â†’ depth=6-10, order=100-200, prob=80-100\n- æ°›å›´/å¤©æ°”/éšæœº â†’ depth=5-8, order=50-150, prob=40-70\n- å½©è›‹/éšè—å†…å®¹ â†’ depth=8-15, order=10-50, prob=10-30\n\nã€è¾“å‡ºæ ¼å¼ã€‘ï¼šJSON æ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ ï¼š\n{ "index": æ¡ç›®åºå·, "depth": æ–°æ·±åº¦, "order": æ–°é¡ºåº, "prob": æ–°æ¦‚ç‡, "reason": "ä¸€å¥è¯ç†ç”±" }\n\nä»…è¾“å‡º JSON æ•°ç»„ï¼Œä¸è¦å…¶ä»–æ–‡å­—ã€‚';
      var userPrompt = 'ä»¥ä¸‹æ˜¯ ' + worldbookEntries.length + ' æ¡ä¸–ç•Œä¹¦æ¡ç›®ï¼Œè¯·åˆ†æå¹¶ä¼˜åŒ–å‚æ•°ï¼š\n\n' + JSON.stringify(entrySummaries, null, 2);

      try {
        var headers = { 'Content-Type': 'application/json' };
        if (key) headers['Authorization'] = 'Bearer ' + key;
        var res = await fetch(url, { method: 'POST', headers: headers, body: JSON.stringify({ model: model, messages: [{ role: 'system', content: sysPrompt }, { role: 'user', content: userPrompt }], temperature: 0.3 }) });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        var rawContent = (await res.json()).choices[0].message.content;
        var suggestions;
        try { suggestions = extractJsonArray(rawContent); } catch(pe) { suggestions = [extractJsonObj(rawContent)]; }
        if (!Array.isArray(suggestions) || suggestions.length === 0) throw new Error('AI è¿”å›æ ¼å¼å¼‚å¸¸');
        pendingOrganizeData = suggestions;
        renderOrganizePreview(suggestions);
        organizeStatus.textContent = 'âœ… åˆ†æå®Œæˆï¼è¯·æ£€æŸ¥ä¸‹æ–¹é¢„è§ˆï¼Œç¡®è®¤åç‚¹å‡»ã€Œåº”ç”¨ã€';
        organizeStatus.style.color = '#34d399';
      } catch(err) {
        organizeStatus.textContent = 'âŒ æ•´ç†å¤±è´¥: ' + err.message;
        organizeStatus.style.color = '#fca5a5';
        organizePreview.style.display = 'none';
      } finally {
        btnAiOrganize.disabled = false;
        btnAiOrganize.textContent = 'âš¡ ä¸€é”®æ•´ç†';
      }
    });

    function renderOrganizePreview(suggestions) {
      var changeCount = 0;
      suggestions.forEach(function(s) {
        var idx = s.index;
        if (idx === undefined || idx < 0 || idx >= worldbookEntries.length) return;
        var e = worldbookEntries[idx];
        if (e.depth !== s.depth || e.order !== s.order || e.prob !== s.prob) changeCount++;
      });

      var html = '<div class="organize-preview-header">';
      html += '<span class="preview-header-title">ğŸ“Š å‚æ•°ä¼˜åŒ–é¢„è§ˆ</span>';
      html += '<span class="preview-header-badge">å…± ' + suggestions.length + ' æ¡</span>';
      html += '</div>';
      html += '<div class="organize-table-wrap"><table class="organize-table">';
      html += '<thead><tr><th>æ¡ç›®</th><th>æ·±åº¦</th><th>é¡ºåº</th><th>æ¦‚ç‡</th><th>AI å»ºè®®</th></tr></thead>';
      html += '<tbody>';
      suggestions.forEach(function(s) {
        var idx = s.index;
        if (idx === undefined || idx < 0 || idx >= worldbookEntries.length) return;
        var e = worldbookEntries[idx];
        var dC = e.depth !== s.depth, oC = e.order !== s.order, pC = e.prob !== s.prob;
        html += '<tr>';
        html += '<td class="org-name-cell" title="' + (e.comment || '').replace(/"/g, '&quot;') + '">' + (e.comment || 'æœªå‘½å') + '</td>';
        html += '<td class="org-value-cell">' + (dC ? '<span class="org-old">' + e.depth + '</span><span class="org-changed">' + s.depth + '</span>' : e.depth) + '</td>';
        html += '<td class="org-value-cell">' + (oC ? '<span class="org-old">' + e.order + '</span><span class="org-changed">' + s.order + '</span>' : e.order) + '</td>';
        html += '<td class="org-value-cell">' + (pC ? '<span class="org-old">' + e.prob + '%</span><span class="org-changed">' + s.prob + '%</span>' : e.prob + '%') + '</td>';
        html += '<td class="org-reason-cell">' + (s.reason || 'â€”') + '</td>';
        html += '</tr>';
      });
      html += '</tbody></table></div>';
      html += '<div class="organize-footer">';
      html += '<span class="organize-stats">å‘ç° <strong>' + changeCount + '</strong> å¤„å¯ä¼˜åŒ–å‚æ•°</span>';
      html += '<div class="organize-actions">';
      html += '<button class="btn-org-cancel" id="btnOrgCancel">å–æ¶ˆ</button>';
      html += '<button class="btn-org-apply" id="btnOrgApply">âœ… åº”ç”¨ä¼˜åŒ–</button>';
      html += '</div></div>';

      organizePreview.innerHTML = html;
      organizePreview.style.display = 'block';

      document.getElementById('btnOrgApply').addEventListener('click', function() {
        if (!pendingOrganizeData) return;
        var applied = 0;
        pendingOrganizeData.forEach(function(s) {
          var idx = s.index;
          if (idx === undefined || idx < 0 || idx >= worldbookEntries.length) return;
          var changed = false;
          if (s.depth !== undefined && s.depth !== worldbookEntries[idx].depth) { worldbookEntries[idx].depth = s.depth; changed = true; }
          if (s.order !== undefined && s.order !== worldbookEntries[idx].order) { worldbookEntries[idx].order = s.order; changed = true; }
          if (s.prob  !== undefined && s.prob  !== worldbookEntries[idx].prob)  { worldbookEntries[idx].prob  = s.prob;  changed = true; }
          if (changed) applied++;
        });
        renderEntriesList(); debouncedUpdateAndSave();
        organizePreview.style.display = 'none'; pendingOrganizeData = null;
        organizeStatus.innerHTML = 'ğŸ‰ å·²åº”ç”¨ <strong>' + applied + '</strong> å¤„ä¼˜åŒ–ï¼';
        organizeStatus.style.color = '#34d399';
        setTimeout(function() { organizeStatus.innerHTML = ''; }, 3000);
      });

      document.getElementById('btnOrgCancel').addEventListener('click', function() {
        organizePreview.style.display = 'none'; pendingOrganizeData = null;
        organizeStatus.innerHTML = 'å·²å–æ¶ˆ'; organizeStatus.style.color = '#64748b';
        setTimeout(function() { organizeStatus.innerHTML = ''; }, 2000);
      });
    }

    // ============================================================
    //  JSON ç”Ÿæˆ
    // ============================================================
    function generateFullJSON() {
      var fe = worldbookEntries.map(function(e, i) {
        return { id: i, keys: e.keys || [], secondary_keys: [], comment: e.comment, content: e.content, constant: e.strategy === 'constant', selective: e.strategy === 'selective' || e.strategy === 'vectorized', insertion_order: e.order || 100, enabled: true, position: "before_char", use_regex: false, extensions: { position: e.position, exclude_recursion: false, display_index: i, probability: e.prob || 100, useProbability: true, depth: e.depth || 4, selectiveLogic: 0, outlet_name: "", group: "", group_override: false, group_weight: 100, prevent_recursion: false, delay_until_recursion: false, role: e.role || 0, vectorized: e.strategy === 'vectorized' } };
      });
      var cn  = charName.value.trim() || "æ— åè§’è‰²";
      var wn  = wbName.value.trim()   || "æ— åä¸–ç•Œä¹¦";
      var ext = { world: wn };
      if (statusBarActive && regexScripts && regexScripts.length > 0) ext.regex_scripts = regexScripts;
      // â˜… é…’é¦†åŠ©æ‰‹è„šæœ¬ï¼ˆScriptTree[] æ ¼å¼ï¼Œç›´æ¥è¾“å‡ºåŸå§‹æ•°ç»„ï¼‰
      if (tavernHelperScripts.length > 0) {
        ext.tavern_helper = { scripts: tavernHelperScripts, variables: {} };
      }
      var altG = (window.__altGreetings__ || []).filter(function(g) { return g && g.trim(); });
      return { name: cn, description: charDesc.value, personality: "", scenario: "", first_mes: firstMes.value, mes_example: "", creatorcomment: creatorNotes.value, avatar: "none", talkativeness: "0.5", fav: false, tags: [], spec: "chara_card_v3", spec_version: "3.0", data: { name: cn, description: charDesc.value, personality: "", scenario: "", first_mes: firstMes.value, mes_example: "", creator_notes: creatorNotes.value, system_prompt: "", post_history_instructions: "", tags: [], creator: "", character_version: "1.0", alternate_greetings: altG, extensions: ext, character_book: { name: wn, entries: fe } } };
    }

    // ============================================================
    //  é¢„è§ˆ & è”åŠ¨ & åˆå§‹åŒ–
    // ============================================================
    function updatePreview() {
      var fj = generateFullJSON();
      if (window.updatePreviewPanel) window.updatePreviewPanel(fj);
    }

    [charName, wbName, charDesc, firstMes, creatorNotes].forEach(function(el) {
      el.addEventListener('input', debouncedUpdateAndSave);
    });

    btnDownloadJson.addEventListener('click', function() {
      var j = JSON.stringify(generateFullJSON(), null, 2);
      var a = document.createElement('a');
      a.href = "data:text/json;charset=utf-8," + encodeURIComponent(j);
      a.download = (charName.value || "card") + ".json";
      a.click();
    });

    // â˜… åˆå§‹åŒ–é¡ºåºå¾ˆé‡è¦ï¼šå…ˆåŠ è½½ AI é…ç½®ï¼ˆå«é¢„è®¾ï¼‰ï¼Œå†åŠ è½½è‰ç¨¿
    loadAIConfig();
    var drafts = getAllDrafts();
    var lastId = localStorage.getItem(CURRENT_KEY);
    if (lastId && drafts[lastId]) loadDraft(lastId);
    else if (Object.keys(drafts).length > 0) loadDraft(Object.keys(drafts)[0]);
    else btnNewDraft.click();

  </script>
</Layout>
