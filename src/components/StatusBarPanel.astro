---
---
<div class="panel sb-panel area-statusbar">
  <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(245, 158, 11, 0.3); padding-bottom: 12px; margin-bottom: 16px;">
    <h2 style="margin: 0; border: none; padding: 0; color: #fcd34d; font-size: 1.05rem;">ğŸ“Š åŠ¨æ€çŠ¶æ€æ </h2>
    <div style="display: flex; align-items: center; gap: 6px;">
      <input type="checkbox" id="sbEnable" checked />
      <label for="sbEnable" style="margin: 0; color: #fcd34d; cursor: pointer; font-weight: 600; font-size: 0.82rem;">å¯ç”¨</label>
    </div>
  </div>

  <p style="font-size: 0.72rem; color: #64748b; margin: 0 0 16px 0;">æ¯è½®å›å¤æœ«å°¾è‡ªåŠ¨è¿½åŠ çŠ¶æ€æ ï¼Œæ‰€æœ‰å­—æ®µæ¯è½®å¼ºåˆ¶æ›´æ–°ã€‚</p>

  <div class="form-group">
    <label>çŠ¶æ€æ æ ‡é¢˜</label>
    <input type="text" id="sbTitle" value="ğŸ“Š STATUS REPORT" />
  </div>

  <div class="grid-2">
    <div class="form-group" style="margin-bottom: 0;">
      <label>é¢œè‰²ä¸»é¢˜</label>
      <select id="sbColor">
        <option value="#f59e0b">ğŸŸ  è­¦ç¤ºæ©™</option>
        <option value="#8b5cf6">ğŸŸ£ èµ›åšç´«</option>
        <option value="#38bdf8">ğŸ”µ æ·±ç©ºè“</option>
        <option value="#10b981">ğŸŸ¢ è§å…‰ç»¿</option>
        <option value="#ef4444">ğŸ”´ å±é™©çº¢</option>
        <option value="#f472b6">ğŸ©· çŒ›ç”·ç²‰</option>
        <option value="#fb923c">ğŸŸ§ çƒˆç„°æ©™</option>
        <option value="#a3e635">ğŸŸ© é…¸æ€§ç»¿</option>
        <option value="#e879f9">ğŸŸª é­”æ³•ç´«</option>
        <option value="#67e8f9">ğŸ©µ å†°å·è“</option>
        <option value="#fbbf24">ğŸŒŸ é‡‘è‰²</option>
        <option value="#f8fafc">â¬œ çº¯ç™½</option>
      </select>
    </div>
    <div class="form-group" style="margin-bottom: 0;">
      <label>å¸ƒå±€æ–¹å¼</label>
      <select id="sbLayout">
        <option value="grid2">â–¦ åŒåˆ—ç½‘æ ¼</option>
        <option value="grid3">â–¦ ä¸‰åˆ—ç½‘æ ¼</option>
        <option value="list">â˜° ç«–åˆ—æ¸…å•</option>
        <option value="compact">â–¬ ç´§å‡‘æ¨ªæ’</option>
        <option value="card">ğŸƒ å¤§å¡ç‰‡</option>
      </select>
    </div>
  </div>

  <div class="grid-2" style="margin-top: 12px;">
    <div class="form-group" style="margin-bottom: 0;">
      <label>åŠ¨ç”»é£æ ¼</label>
      <select id="sbAnim">
        <option value="cyber">âš¡ èµ›åšæœ‹å…‹</option>
        <option value="magic">âœ¨ é­”æ³•æ°´æ™¶</option>
        <option value="military">ğŸ–ï¸ å†›äº‹ç»ˆç«¯</option>
        <option value="neon">ğŸŒƒ éœ“è™¹éƒ½å¸‚</option>
        <option value="minimal">â—»ï¸ æç®€é£</option>
      </select>
    </div>
    <div class="form-group" style="margin-bottom: 0;">
      <label>ç‰¹æ•ˆ</label>
      <select id="sbFx">
        <option value="all">æ‰«æçº¿ + å‘¼å¸ç¯</option>
        <option value="glow">ä»…å‘¼å¸ç¯</option>
        <option value="scan">ä»…æ‰«æçº¿</option>
        <option value="none">æ— ç‰¹æ•ˆ</option>
      </select>
    </div>
  </div>

  <!-- å­—æ®µåˆ—è¡¨ -->
  <div style="margin-top: 18px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
      <label style="margin: 0; font-size: 0.82rem; color: #94a3b8; font-weight: 600;">ğŸ“‹ ç›‘æ§å­—æ®µ</label>
      <button id="btnAddField" class="btn" style="padding: 4px 12px; font-size: 0.75rem; background: rgba(16,185,129,0.2); border: 1px solid rgba(16,185,129,0.4); color: #34d399;">ï¼‹ æ·»åŠ å­—æ®µ</button>
    </div>
    <div id="sbFieldList" style="display: flex; flex-direction: column; gap: 8px;"></div>
  </div>

  <!-- æ³¨å…¥å‚æ•° -->
  <div style="margin-top: 16px; background: rgba(16,185,129,0.06); border: 1px solid rgba(16,185,129,0.2); border-radius: 8px; padding: 12px;">
    <h4 style="margin: 0 0 10px 0; color: #34d399; font-size: 0.8rem;">âš™ï¸ æ³¨å…¥å‚æ•°</h4>
    <div class="grid-2">
      <div class="form-group" style="margin-bottom: 0;">
        <label>æ³¨å…¥æ·±åº¦ (depth)</label>
        <input type="number" id="sbDepth" value="1" min="0" max="20" />
      </div>
      <div class="form-group" style="margin-bottom: 0;">
        <label>æ³¨å…¥é¡ºåº (order)</label>
        <input type="number" id="sbOrder" value="999" min="0" max="9999" />
      </div>
    </div>
    <p style="font-size: 0.68rem; color: #64748b; margin: 8px 0 0 0;">depth=1 è¡¨ç¤ºæ’å…¥åœ¨æœ€åä¸€æ¡å¯¹è¯ä¹‹å‰ï¼ŒAI å¿…ç„¶çœ‹åˆ°ã€‚</p>
  </div>

  <button id="btnInjectStatusBar" class="btn" style="width: 100%; margin-top: 16px; background: linear-gradient(135deg, #f59e0b, #d97706); color: #fff;">âœ¨ æ³¨å…¥åˆ°å¡ç‰‡</button>
  <div id="sbStatusText" class="status-text" style="color: #10b981;"></div>

  <!-- é¢„è§ˆåŒº -->
  <div id="sbPreviewArea" style="margin-top: 16px; display: none;">
    <label style="font-size: 0.75rem; color: #64748b; margin-bottom: 6px; display: block; font-weight: 600;">ğŸ‘ï¸ æ•ˆæœé¢„è§ˆ</label>
    <div id="sbPreviewContent" style="border-radius: 8px; overflow: hidden;"></div>
  </div>
</div>

<script is:inline>
(function () {

  
  
  
  const sbTitle            = document.getElementById('sbTitle');
  const sbColor            = document.getElementById('sbColor');
  const sbLayout           = document.getElementById('sbLayout');
  const sbAnim             = document.getElementById('sbAnim');
  const sbFx               = document.getElementById('sbFx');
  const sbDepth            = document.getElementById('sbDepth');
  const sbOrder            = document.getElementById('sbOrder');
  const sbEnable           = document.getElementById('sbEnable');
  const sbStatusText       = document.getElementById('sbStatusText');
  const sbFieldList        = document.getElementById('sbFieldList');
  const btnAddField        = document.getElementById('btnAddField');
  const btnInjectStatusBar = document.getElementById('btnInjectStatusBar');
  const sbPreviewArea      = document.getElementById('sbPreviewArea');
  const sbPreviewContent   = document.getElementById('sbPreviewContent');

  
  
  
  let fields = [
    { name: 'ç”Ÿå‘½å€¼',   desc: 'ä¸»è§’çš„èº«ä½“å®Œæ•´åº¦ï¼Œæœ€é«˜100%ï¼Œå—ä¼¤é™ä½ï¼Œæ²»ç–—æ¢å¤' },
    { name: 'ç²¾ç¥çŠ¶æ€', desc: 'ä¸»è§’å½“å‰çš„å¿ƒç†çŠ¶æ€ï¼Œå¦‚ï¼šæ¸…é†’ã€ç–²æƒ«ã€å´©æºƒè¾¹ç¼˜' },
    { name: 'å½“å‰ä½ç½®', desc: 'ä¸»è§’æ‰€åœ¨çš„å…·ä½“åœ°ç‚¹' },
    { name: 'æƒ…ç»ª',     desc: 'ä¸»è§’æ­¤åˆ»çš„æƒ…ç»ªå€¾å‘' },
  ];

  
  
  
  function renderFieldList() {
    sbFieldList.innerHTML = '';
    fields.forEach((f, i) => {
      const row = document.createElement('div');
      row.style.cssText =
        'background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);' +
        'border-radius:8px;padding:10px 12px;display:flex;flex-direction:column;gap:6px;position:relative;';

      row.innerHTML =
        `<div style="display:flex;gap:8px;align-items:center;">` +
          `<input type="text" placeholder="å­—æ®µåç§°" value="${escHtml(f.name)}" data-i="${i}" data-key="name"` +
          ` style="flex:0 0 120px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.12);` +
          `border-radius:6px;padding:5px 8px;color:#e2e8f0;font-size:0.82rem;" />` +
          `<input type="text" placeholder="å­—æ®µå®šä¹‰ï¼ˆå‘Šè¯‰AIè¿™ä¸ªå­—æ®µä»£è¡¨ä»€ä¹ˆã€å–å€¼èŒƒå›´ç­‰ï¼‰" value="${escHtml(f.desc)}" data-i="${i}" data-key="desc"` +
          ` style="flex:1;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.12);` +
          `border-radius:6px;padding:5px 8px;color:#94a3b8;font-size:0.78rem;" />` +
          `<button data-del="${i}" style="flex-shrink:0;background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);` +
          `color:#f87171;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:0.75rem;">âœ•</button>` +
        `</div>`;

      row.querySelectorAll('input').forEach(inp => {
        inp.addEventListener('input', e => {
          fields[+e.target.dataset.i][e.target.dataset.key] = e.target.value;
          updatePreview();
        });
      });

      row.querySelector('[data-del]').addEventListener('click', e => {
        fields.splice(+e.target.dataset.del, 1);
        renderFieldList();
        updatePreview();
      });

      sbFieldList.appendChild(row);
    });
    updatePreview();
  }

  btnAddField.addEventListener('click', () => {
    fields.push({ name: '', desc: '' });
    renderFieldList();
    const inputs = sbFieldList.querySelectorAll('input[data-key="name"]');
    if (inputs.length) inputs[inputs.length - 1].focus();
  });

  function escHtml(s) {
    return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  
  
  
  function hexToRgb(hex) {
    return [
      parseInt(hex.slice(1,3),16),
      parseInt(hex.slice(3,5),16),
      parseInt(hex.slice(5,7),16)
    ].join(',');
  }

  function getStyle(anim, color, rgb) {
    const map = {
      cyber:    { bg:'rgba(5,5,20,0.95)',   border:`rgba(${rgb},0.3)`,  labelC:`rgba(${rgb},0.6)`,  valueC:'#e2e8f0', accent:color },
      magic:    { bg:'rgba(15,5,30,0.95)',  border:`rgba(${rgb},0.3)`,  labelC:`rgba(${rgb},0.55)`, valueC:'#f0e6ff', accent:color },
      military: { bg:'rgba(5,12,5,0.95)',   border:`rgba(${rgb},0.3)`,  labelC:`rgba(${rgb},0.55)`, valueC:'#d1fae5', accent:color },
      neon:     { bg:'rgba(5,0,20,0.95)',   border:`rgba(${rgb},0.3)`,  labelC:`rgba(${rgb},0.6)`,  valueC:'#fdf2f8', accent:color },
      minimal:  { bg:'rgba(15,23,42,0.92)', border:`rgba(${rgb},0.25)`, labelC:`rgba(${rgb},0.7)`,  valueC:'#e2e8f0', accent:color },
    };
    return map[anim] || map.cyber;
  }

  
  
  
  function makeCard(name, val, layout, S, rgb, glowCSS) {
    if (layout === 'grid2' || layout === 'grid3') {
      return (
        `<div style="display:flex;flex-direction:column;background:rgba(${rgb},0.06);` +
        `border:1px solid rgba(${rgb},0.2);border-radius:8px;padding:10px 12px;">` +
        `<span style="font-size:0.62em;color:${S.labelC};text-transform:uppercase;` +
        `letter-spacing:0.8px;margin-bottom:5px;font-weight:600;">${name}</span>` +
        `<span style="font-size:1em;font-weight:700;color:${S.valueC};${glowCSS}">${val}</span>` +
        `</div>`
      );
    } else if (layout === 'list') {
      return (
        `<div style="display:flex;justify-content:space-between;align-items:center;` +
        `padding:7px 10px;border-bottom:1px solid rgba(${rgb},0.1);">` +
        `<span style="font-size:0.8em;color:${S.labelC};font-weight:600;">${name}</span>` +
        `<span style="font-weight:700;color:${S.valueC};${glowCSS}">${val}</span>` +
        `</div>`
      );
    } else if (layout === 'compact') {
      return (
        `<div style="display:inline-flex;align-items:center;gap:6px;` +
        `background:rgba(${rgb},0.08);border:1px solid rgba(${rgb},0.2);` +
        `border-radius:99px;padding:4px 12px;white-space:nowrap;">` +
        `<span style="font-size:0.7em;color:${S.labelC};font-weight:600;">${name}</span>` +
        `<span style="font-size:0.85em;font-weight:700;color:${S.valueC};${glowCSS}">${val}</span>` +
        `</div>`
      );
    } else if (layout === 'card') {
      return (
        `<div style="background:rgba(${rgb},0.07);border:1px solid rgba(${rgb},0.22);` +
        `border-left:3px solid ${S.accent};border-radius:8px;padding:12px 14px;` +
        `display:flex;justify-content:space-between;align-items:center;">` +
        `<div>` +
        `<div style="font-size:0.68em;color:${S.labelC};text-transform:uppercase;` +
        `letter-spacing:0.8px;margin-bottom:3px;font-weight:600;">${name}</div>` +
        `<div style="font-size:1.05em;font-weight:700;color:${S.valueC};${glowCSS}">${val}</div>` +
        `</div>` +
        `<span style="font-size:1.4em;opacity:0.15;">â—ˆ</span>` +
        `</div>`
      );
    }
    return '';
  }

  
  
  
  function makeWrapper(title, layout, S, rgb, color, glowCSS, uid, fx, innerHtml) {
    const useGlow = fx === 'all' || fx === 'glow';
    const useScan = fx === 'all' || fx === 'scan';

    let animCSS = '';
    if (useScan) {
      animCSS +=
        `.${uid}w::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;` +
        `background:repeating-linear-gradient(0deg,transparent,transparent 2px,` +
        `rgba(${rgb},0.02) 2px,rgba(${rgb},0.02) 4px);` +
        `pointer-events:none;border-radius:10px;z-index:0;}`;
    }
    if (useGlow) {
      animCSS +=
        `@keyframes ${uid}b{0%,100%{opacity:1}50%{opacity:0.25}}` +
        `.${uid}d{animation:${uid}b 2.5s ease-in-out infinite;}`;
    }

    const innerStyle =
      layout === 'grid2'     ? `display:grid;grid-template-columns:repeat(2,1fr);gap:8px;padding:12px 14px;`
      : layout === 'grid3'   ? `display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:12px 14px;`
      : layout === 'compact' ? `display:flex;flex-wrap:wrap;gap:6px;padding:12px 14px;`
      : layout === 'card'    ? `display:flex;flex-direction:column;gap:8px;padding:12px 14px;`
      :                        `display:flex;flex-direction:column;padding:8px 4px;`;

    const dotHtml = useGlow
      ? `<span class="${uid}d" style="width:8px;height:8px;border-radius:50%;background:${color};` +
        `box-shadow:0 0 10px rgba(${rgb},0.9);display:inline-block;flex-shrink:0;"></span>`
      : `<span style="width:8px;height:8px;border-radius:50%;background:${color};` +
        `display:inline-block;flex-shrink:0;"></span>`;

    return (
      `<style>` +
      `.${uid}w{background:${S.bg};border:1px solid ${S.border};border-radius:10px;` +
      `font-family:'Courier New',monospace;font-size:0.85em;color:#cbd5e1;` +
      `box-shadow:0 8px 32px rgba(0,0,0,0.5);margin-top:16px;overflow:hidden;position:relative;}` +
      animCSS +
      `</style>` +
      `<div class="${uid}w">` +
        `<div style="background:linear-gradient(90deg,rgba(${rgb},0.18),rgba(${rgb},0.04));` +
        `padding:10px 14px;border-bottom:1px solid rgba(${rgb},0.15);` +
        `display:flex;align-items:center;justify-content:space-between;position:relative;z-index:1;">` +
          `<div style="display:flex;align-items:center;gap:8px;">${dotHtml}` +
          `<span style="font-weight:700;color:${color};letter-spacing:1.5px;${glowCSS}">${title}</span>` +
          `</div>` +
          `<span style="font-size:0.6em;color:rgba(${rgb},0.4);letter-spacing:1px;">LIVE</span>` +
        `</div>` +
        `<div style="${innerStyle}position:relative;z-index:1;">${innerHtml}</div>` +
      `</div>`
    );
  }

  
  
  
  function updatePreview() {
    const validFields = fields.filter(f => f.name.trim());
    if (!validFields.length) { sbPreviewArea.style.display = 'none'; return; }

    const color   = sbColor.value;
    const rgb     = hexToRgb(color);
    const layout  = sbLayout.value;
    const anim    = sbAnim.value;
    const fx      = sbFx.value;
    const title   = sbTitle.value.trim() || 'STATUS REPORT';
    const useGlow = fx === 'all' || fx === 'glow';
    const glowCSS = useGlow ? `text-shadow:0 0 8px rgba(${rgb},0.7);` : '';
    const S       = getStyle(anim, color, rgb);

    const innerHtml = validFields
      .map(f => makeCard(f.name, 'â€”â€”â€”', layout, S, rgb, glowCSS))
      .join('');

    const html = makeWrapper(title, layout, S, rgb, color, glowCSS, 'sbprev', fx, innerHtml);
    sbPreviewContent.innerHTML = html;
    sbPreviewArea.style.display = 'block';
  }

  
  
  
  function buildPrompt(validFields) {
    const fieldLines = validFields.map(f => `[${f.name}]: æ ¹æ®å®šä¹‰å¡«å†™å…·ä½“å€¼`).join('\n');
    const defLines   = validFields.map((f,i) => `  ${i+1}. ã€${f.name}ã€‘ï¼š${f.desc}`).join('\n');
    const example    = validFields.slice(0,3).map((f,i) =>
      `[${f.name}]: ${ ['87%','æ¸…é†’ä¸”ä¸“æ³¨','åŸå¸‚ä¸œåŒº'][i] || 'ç¤ºä¾‹å€¼' }`
    ).join('\n');

    return `[SYSTEM OVERRIDE - çŠ¶æ€æ å¼ºåˆ¶è¾“å‡ºåè®®]
ä½ å¿…é¡»åœ¨æ¯æ¬¡å›å¤çš„ã€æœ€æœ«å°¾ã€‘è¿½åŠ ä»¥ä¸‹çŠ¶æ€é¢æ¿ï¼Œæ¯è½®å¿…é¡»æ ¹æ®å‰§æƒ…æ›´æ–°æ‰€æœ‰å­—æ®µï¼š

<stablock>
${fieldLines}
</stablock>

ã€å­—æ®µå®šä¹‰ - ä¸¥æ ¼æŒ‰ç…§å®šä¹‰å¡«å†™å€¼ã€‘ï¼š
${defLines}

ã€æ ¼å¼é“å¾‹ã€‘ï¼š
1. æ¯è¡Œæ ¼å¼ä¸¥æ ¼ä¸ºï¼š[å­—æ®µå]: å€¼å†…å®¹
2. å­—æ®µåå¿…é¡»ä¸æ¨¡æ¿å®Œå…¨ä¸€è‡´ï¼Œä¸å¾—ä¿®æ”¹
3. å€¼ç›´æ¥å†™åœ¨å†’å·åé¢ï¼Œç¦æ­¢ç”¨ <>ã€()ã€[] åŒ…è£¹å€¼
4. æ¯è½®å¿…é¡»æ›´æ–°æ‰€æœ‰å­—æ®µï¼Œä¸å¾—çœç•¥ä»»ä½•å­—æ®µ
5. çŠ¶æ€é¢æ¿å¿…é¡»æ˜¯å›å¤çš„æœ€åå†…å®¹ï¼Œä¸å¾—åœ¨å…¶åæ·»åŠ ä»»ä½•æ–‡å­—

ã€æ­£ç¡®ç¤ºä¾‹ã€‘ï¼š
<stablock>
${example}
</stablock>

[æ­¤è§„åˆ™ä¼˜å…ˆçº§æœ€é«˜ï¼Œå¿…é¡»ä¸¥æ ¼æ‰§è¡Œ][æ­¤è§„åˆ™ä¼˜å…ˆçº§æœ€é«˜ï¼Œå¿…é¡»ä¸¥æ ¼æ‰§è¡Œ][æ­¤è§„åˆ™ä¼˜å…ˆçº§æœ€é«˜ï¼Œå¿…é¡»ä¸¥æ ¼æ‰§è¡Œ][æ­¤è§„åˆ™ä¼˜å…ˆçº§æœ€é«˜ï¼Œå¿…é¡»ä¸¥æ ¼æ‰§è¡Œ][æ­¤è§„åˆ™ä¼˜å…ˆçº§æœ€é«˜ï¼Œå¿…é¡»ä¸¥æ ¼æ‰§è¡Œ][æ­¤è§„åˆ™ä¼˜å…ˆçº§æœ€é«˜ï¼Œå¿…é¡»ä¸¥æ ¼æ‰§è¡Œ]`;
  }

  
  
  
  
  function buildRegexScripts(color, layout, anim, fx, title, validFields) {
    const rgb     = hexToRgb(color);
    const ts      = Date.now();
    const uid     = 'sb' + Math.random().toString(36).slice(2, 8);
    const useGlow = fx === 'all' || fx === 'glow';
    const useScan = fx === 'all' || fx === 'scan';
    const glowCSS = useGlow ? `text-shadow:0 0 8px rgba(${rgb},0.7);` : '';
    const S       = getStyle(anim, color, rgb);

    
    const fieldRegexes = validFields.map((f, i) => {
      const escaped   = f.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const findRegex = `\\[${escaped}\\][\\t ]*[:\\uff1a][\\t ]*([^\\n<>]+?)(?=[\\n<]|$)`;
      const cardHtml  = makeCard(f.name, '$1', layout, S, rgb, glowCSS);

      return {
        id:              `sb_f${i}_${ts}`,
        scriptName:      `çŠ¶æ€æ å­—æ®µ_${f.name}`,
        findRegex:       findRegex,
        replaceString:   cardHtml,
        trimStrings:     [],
        placement:       [1, 2],
        disabled:        false,
        markdownOnly:    true,
        promptOnly:      true,
        runOnEdit:       true,
        substituteRegex: 0,
        minDepth:        null,
        maxDepth:        null,
        order:           i + 1,          
      };
    });

    
    let animCSS = '';
    if (useScan) {
      animCSS +=
        `.${uid}w::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;` +
        `background:repeating-linear-gradient(0deg,transparent,transparent 2px,` +
        `rgba(${rgb},0.02) 2px,rgba(${rgb},0.02) 4px);` +
        `pointer-events:none;border-radius:10px;z-index:0;}`;
    }
    if (useGlow) {
      animCSS +=
        `@keyframes ${uid}b{0%,100%{opacity:1}50%{opacity:0.25}}` +
        `.${uid}d{animation:${uid}b 2.5s ease-in-out infinite;}`;
    }

    const innerStyle =
      layout === 'grid2'     ? `display:grid;grid-template-columns:repeat(2,1fr);gap:8px;padding:12px 14px;`
      : layout === 'grid3'   ? `display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:12px 14px;`
      : layout === 'compact' ? `display:flex;flex-wrap:wrap;gap:6px;padding:12px 14px;`
      : layout === 'card'    ? `display:flex;flex-direction:column;gap:8px;padding:12px 14px;`
      :                        `display:flex;flex-direction:column;padding:8px 4px;`;

    const dotHtml = useGlow
      ? `<span class="${uid}d" style="width:8px;height:8px;border-radius:50%;background:${color};` +
        `box-shadow:0 0 10px rgba(${rgb},0.9);display:inline-block;flex-shrink:0;"></span>`
      : `<span style="width:8px;height:8px;border-radius:50%;background:${color};` +
        `display:inline-block;flex-shrink:0;"></span>`;

    const containerHtml =
      `<style>` +
      `.${uid}w{background:${S.bg};border:1px solid ${S.border};border-radius:10px;` +
      `font-family:'Courier New',monospace;font-size:0.85em;color:#cbd5e1;` +
      `box-shadow:0 8px 32px rgba(0,0,0,0.5);margin-top:16px;overflow:hidden;position:relative;}` +
      animCSS +
      `</style>` +
      `<div class="${uid}w">` +
        `<div style="background:linear-gradient(90deg,rgba(${rgb},0.18),rgba(${rgb},0.04));` +
        `padding:10px 14px;border-bottom:1px solid rgba(${rgb},0.15);` +
        `display:flex;align-items:center;justify-content:space-between;position:relative;z-index:1;">` +
          `<div style="display:flex;align-items:center;gap:8px;">${dotHtml}` +
          `<span style="font-weight:700;color:${color};letter-spacing:1.5px;${glowCSS}">${title}</span>` +
          `</div>` +
          `<span style="font-size:0.6em;color:rgba(${rgb},0.4);letter-spacing:1px;">LIVE</span>` +
        `</div>` +
        `<div style="${innerStyle}position:relative;z-index:1;">$1</div>` +
      `</div>`;

    const containerRegex = {
      id:              `sb_wrap_${ts}`,
      scriptName:      'çŠ¶æ€æ å®¹å™¨',
      findRegex:       `<[sS][tT][aA][bB][lL][oO][cC][kK]>([\\s\\S]*?)<\\/[sS][tT][aA][bB][lL][oO][cC][kK]>`,
      replaceString:   containerHtml,
      trimStrings:     [],
      placement:       [1, 2],
      disabled:        false,
      markdownOnly:    true,
      promptOnly:      true,
      runOnEdit:       true,
      substituteRegex: 0,
      minDepth:        null,
      maxDepth:        null,
      order:           validFields.length + 10,  
    };

    return [...fieldRegexes, containerRegex];
  }

  
  
  
  btnInjectStatusBar.addEventListener('click', () => {
    if (!sbEnable.checked) return alert('è¯·å…ˆå‹¾é€‰ã€Œå¯ç”¨ã€ï¼');
    const validFields = fields.filter(f => f.name.trim());
    if (!validFields.length) return alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªå­—æ®µï¼');

    const color  = sbColor.value;
    const title  = sbTitle.value.trim() || 'STATUS REPORT';
    const layout = sbLayout.value;
    const anim   = sbAnim.value;
    const fx     = sbFx.value;
    const depth  = parseInt(sbDepth.value) || 1;
    const order  = parseInt(sbOrder.value) || 999;

    const newWbEntry = {
      comment:  '===ç³»ç»Ÿåº•å±‚ï¼šçŠ¶æ€æ çº¦æŸ===',
      content:  buildPrompt(validFields),
      keys:     [],
      strategy: 'constant',
      position: 4,
      depth:    depth,
      role:     0,
      order:    order,
      prob:     100,
    };

    const regexScripts = buildRegexScripts(color, layout, anim, fx, title, validFields);

    if (window.injectStatusBarGlobal) {
      window.injectStatusBarGlobal(newWbEntry, regexScripts);
      sbStatusText.textContent =
        `âœ… æ³¨å…¥æˆåŠŸï¼${validFields.length} ä¸ªå­—æ®µï¼Œdepth=${depth}ï¼Œæ­£åˆ™Ã—${regexScripts.length}`;
      sbStatusText.style.color = '#10b981';
      setTimeout(() => { sbStatusText.textContent = ''; }, 3000);
    } else {
      alert('âŒ æ³¨å…¥æ¥å£æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥é¡µé¢æ˜¯å¦å®Œæ•´åŠ è½½ï¼');
    }
  });

  
  
  
  [sbTitle, sbColor, sbLayout, sbAnim, sbFx].forEach(el => {
    el.addEventListener('change', updatePreview);
    el.addEventListener('input', updatePreview);
  });

  sbEnable.addEventListener('change', () => {
    if (window.setStatusBarActiveState) window.setStatusBarActiveState(sbEnable.checked);
  });

  
  
  
  window.__getStatusBarData__ = function() {
    return {
      title:   sbTitle.value,
      color:   sbColor.value,
      layout:  sbLayout.value,
      anim:    sbAnim.value,
      fx:      sbFx.value,
      depth:   sbDepth.value,
      order:   sbOrder.value,
      enabled: sbEnable.checked,
      fields:  fields,
    };
  };

  window.__loadStatusBarData__ = function(data) {
    if (!data) {
      
      sbTitle.value    = 'ğŸ“Š STATUS REPORT';
      sbColor.value    = '#f59e0b';
      sbLayout.value   = 'grid2';
      sbAnim.value     = 'cyber';
      sbFx.value       = 'all';
      sbDepth.value    = '1';
      sbOrder.value    = '999';
      sbEnable.checked = true;
      fields = [
        { name: 'ç”Ÿå‘½å€¼',   desc: 'ä¸»è§’çš„èº«ä½“å®Œæ•´åº¦ï¼Œæœ€é«˜100%ï¼Œå—ä¼¤é™ä½ï¼Œæ²»ç–—æ¢å¤' },
        { name: 'ç²¾ç¥çŠ¶æ€', desc: 'ä¸»è§’å½“å‰çš„å¿ƒç†çŠ¶æ€ï¼Œå¦‚ï¼šæ¸…é†’ã€ç–²æƒ«ã€å´©æºƒè¾¹ç¼˜' },
        { name: 'å½“å‰ä½ç½®', desc: 'ä¸»è§’æ‰€åœ¨çš„å…·ä½“åœ°ç‚¹' },
        { name: 'æƒ…ç»ª',     desc: 'ä¸»è§’æ­¤åˆ»çš„æƒ…ç»ªå€¾å‘' },
      ];
      renderFieldList();
      return;
    }
    if (data.title   !== undefined) sbTitle.value    = data.title;
    if (data.color   !== undefined) sbColor.value    = data.color;
    if (data.layout  !== undefined) sbLayout.value   = data.layout;
    if (data.anim    !== undefined) sbAnim.value     = data.anim;
    if (data.fx      !== undefined) sbFx.value       = data.fx;
    if (data.depth   !== undefined) sbDepth.value    = data.depth;
    if (data.order   !== undefined) sbOrder.value    = data.order;
    if (data.enabled !== undefined) sbEnable.checked = data.enabled;
    if (data.fields && Array.isArray(data.fields)) {
      fields = data.fields;
      renderFieldList();
    }
    updatePreview();
  };

  
  
  
  renderFieldList();

})();
</script>
