---


---
<div class="panel" style="border-color: #f59e0b; background: rgba(245, 158, 11, 0.05);">
  <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #d97706; padding-bottom: 10px; margin-bottom: 15px;">
    <h2 style="margin:0; border:none; padding:0; color: #fcd34d;">ğŸ“Š åŠ¨æ€çŠ¶æ€æ  (åŠAIæ³¨å…¥)</h2>
    <div style="display: flex; align-items: center; gap: 6px;">
      <input type="checkbox" id="sbEnable" style="width: 18px; height: 18px; accent-color: #f59e0b; cursor: pointer;" checked />
      <label for="sbEnable" style="margin: 0; color: #fcd34d; cursor: pointer; font-weight: bold; font-size: 0.9rem;">å¯ç”¨çŠ¶æ€æ </label>
    </div>
  </div>
  <p style="font-size: 0.75rem; color: #94a3b8; margin: 0 0 15px 0;">å¼€å¯åï¼Œå¯¼å‡ºæ—¶å°†è‡ªåŠ¨æŒ‚è½½ã€åº•å±‚é«˜ä¼˜è¾“å‡ºæŒ‡ä»¤ã€‘å’Œã€æ­£åˆ™UIæ‹¦æˆªå™¨ã€‘ã€‚</p>

  <div class="form-group">
    <label>UI æŠ¬å¤´æ ‡é¢˜ (Title)</label>
    <input type="text" id="sbTitle" value="ğŸ“Š STATUS REPORT" />
  </div>
  <div class="form-group">
    <label>éœ€è¦ç›‘æ§çš„å­—æ®µ (Fields - é€—å·éš”å¼€)</label>
    <input type="text" id="sbFields" value="ç”Ÿå‘½å€¼, ç²¾ç¥çŠ¶æ€, å½“å‰ä½ç½®, å¤©æ°”, æƒ…ç»ª" />
  </div>
  <div class="grid-2">
    <div class="form-group" style="margin-bottom: 0;">
      <label>UI ä¸»é¢˜é£æ ¼é¢œè‰²</label>
      <select id="sbColor">
        <option value="#8b5cf6">èµ›åšç´« (#8b5cf6)</option>
        <option value="#38bdf8">æ·±ç©ºè“ (#38bdf8)</option>
        <option value="#10b981">è§å…‰ç»¿ (#10b981)</option>
        <option value="#f59e0b" selected>è­¦ç¤ºæ©™ (#f59e0b)</option>
        <option value="#ef4444">å±é™©çº¢ (#ef4444)</option>
        <option value="#f472b6">çŒ›ç”·ç²‰ (#f472b6)</option>
      </select>
    </div>
    <button id="btnAiStatusBar" class="btn" style="background-color: #d97706; margin-top: 22px; padding: 8px; font-size:0.85rem;">ğŸ¤– AI æ™ºèƒ½åŒ¹é…å­—æ®µ</button>
  </div>
  
  <button id="btnInjectStatusBar" class="btn" style="width: 100%; margin-top: 15px; background-color: #f59e0b; color: #fff;">âœ¨ å°†é…ç½®æ³¨å…¥åˆ°å¡ç‰‡ä¸­</button>
  <div id="sbStatusText" class="status-text" style="color: #10b981;"></div>
</div>

<script is:inline>
  
  const btnAiStatusBar = document.getElementById('btnAiStatusBar');
  const sbTitle = document.getElementById('sbTitle');
  const sbFields = document.getElementById('sbFields');
  const sbColor = document.getElementById('sbColor');
  const btnInjectStatusBar = document.getElementById('btnInjectStatusBar');
  const sbEnable = document.getElementById('sbEnable');
  const sbStatusText = document.getElementById('sbStatusText');

  
  function extractJsonObjSafe(text) { 
    const match = text.match(/```json\s*([\s\S]*?)\s*```/); 
    let obj = match ? JSON.parse(match[1]) : JSON.parse(text); 
    return (Array.isArray(obj) && obj.length > 0) ? obj[0] : obj;
  }

  
  btnAiStatusBar.addEventListener('click', async () => {
    
    const apiUrl = document.getElementById('apiUrl')?.value.replace(/\/$/, '') + '/chat/completions';
    const apiKey = document.getElementById('apiKey')?.value.trim();
    const model = document.getElementById('modelSelect')?.value;
    
    const charName = document.getElementById('charName')?.value || 'æœªçŸ¥';
    const charDesc = document.getElementById('charDesc')?.value || 'æœªçŸ¥';

    if (!model) return alert('è¯·å…ˆåœ¨å·¦ä¾§ AI å¼•æ“é¢æ¿æ‹‰å–å¹¶é€‰æ‹©æ¨¡å‹ï¼');
    if (!charDesc || charDesc === 'æœªçŸ¥') return alert('è¯·å…ˆåœ¨è§’è‰²è®¾å®šä¸­å¡«å†™è§’è‰²æè¿°ï¼ŒAIéœ€è¦æ ¹æ®èƒŒæ™¯æ¨æ–­çŠ¶æ€æ å­—æ®µï¼');

    btnAiStatusBar.disabled = true;
    btnAiStatusBar.textContent = "â³ AI æ€è€ƒä¸­...";

    const sysPrompt = `ä½ æ˜¯ä¸€ä¸ªè·‘å›¢æ¸¸æˆçŠ¶æ€æ UIè®¾è®¡å¤§å¸ˆã€‚è¯·æ ¹æ®ç”¨æˆ·çš„è§’è‰²è®¾å®šï¼Œæ„æ€ä¸€ä¸ªå¥‘åˆèƒŒæ™¯çš„ã€çŠ¶æ€æ æ ‡é¢˜ã€‘å’Œã€4-6ä¸ªéœ€è¦ç›‘æ§çš„çŠ¶æ€å­—æ®µã€‘ã€‚
æ¯”å¦‚ï¼šèµ›åšæœ‹å…‹è§’è‰²å¯ä»¥æ˜¯"ä¹‰ä½“å®Œæ•´åº¦, æ±¡æŸ“æŒ‡æ•°, ç”µæ± ä½™é‡"ï¼›é­”æ³•è§’è‰²å¯ä»¥æ˜¯"é­”åŠ›å€¼, ç†æ™ºå€¼, é­”æ³•æŠ¤ç›¾"ã€‚
å¿…é¡»ä¸”ä»…è¾“å‡ºçº¯JSONå¯¹è±¡ï¼š
{
  "title": "ç¬¦åˆè®¾å®šçš„UIæ ‡é¢˜ï¼Œå¯å¸¦ä¸€ä¸ªemojiï¼Œä¾‹å¦‚ ğŸ”® MAGIC STATUS",
  "fields": "å­—æ®µ1, å­—æ®µ2, å­—æ®µ3, å­—æ®µ4"
}`;

    try {
      const res = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...(apiKey && { 'Authorization': `Bearer ${apiKey}` }) },
        body: JSON.stringify({
          model: model,
          messages: [
            { role: "system", content: sysPrompt },
            { role: "user", content: `è§’è‰²åï¼š${charName}\nè§’è‰²è®¾å®šï¼š${charDesc}\nè¯·ä¸ºè¯¥è§’è‰²ç”ŸæˆåŒ¹é…çš„çŠ¶æ€æ é…ç½®ã€‚` }
          ],
          temperature: 0.8
        })
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = extractJsonObjSafe((await res.json()).choices[0].message.content);
      
      if (data.title) sbTitle.value = data.title;
      if (data.fields) sbFields.value = data.fields;
      
      
      if (window.triggerGlobalUpdate) window.triggerGlobalUpdate();
      
    } catch(err) {
      alert(`ç”Ÿæˆå¤±è´¥: ${err.message}`);
    } finally {
      btnAiStatusBar.disabled = false;
      btnAiStatusBar.textContent = "ğŸ¤– AI æ™ºèƒ½åŒ¹é…å­—æ®µ";
    }
  });

  
  btnInjectStatusBar.addEventListener('click', () => {
    if (!sbEnable.checked) return alert("è¯·å…ˆåœ¨å³ä¸Šè§’å‹¾é€‰ã€å¯ç”¨çŠ¶æ€æ ã€ï¼");
    const fieldsStr = sbFields.value.trim();
    const color = sbColor.value;
    const title = sbTitle.value.trim() || "STATUS REPORT";
    if (!fieldsStr) return alert("è¯·å¡«å†™ç›‘æ§å­—æ®µï¼");

    
    const wbTitle = "===ç³»ç»Ÿåº•å±‚ï¼šçŠ¶æ€æ çº¦æŸ===";
    const promptContent = `[System Note: ä½ çš„æ¯ä¸€æ¬¡å›å¤ã€å¿…é¡»ã€‘åœ¨æœ«å°¾æºå¸¦è§’è‰²çš„å½“å‰çŠ¶æ€é¢æ¿ï¼\næ ¼å¼è¦æ±‚æå…¶ä¸¥æ ¼ï¼Œå¿…é¡»åŸæ ·ä½¿ç”¨ä»¥ä¸‹ <stablock> æ ‡ç­¾åŒ…è£¹ï¼š\n<stablock>\n${fieldsStr.split(',').map(f => `${f.trim()}: <å…·ä½“æ•°å€¼/çŠ¶æ€>`).join(' | ')}\n</stablock>\nç¦æ­¢é—æ¼ä»»ä½•å­—æ®µï¼Œå¿…é¡»åŒ…å«åœ¨å›å¤çš„æœ€æœ«å°¾ï¼]`;
    
    const newWbEntry = { comment: wbTitle, content: promptContent, keys: [], strategy: 'constant', position: 4, depth: 0, role: 0, order: 999, prob: 100 };

    
    const replacementHTML = `<div style="background: rgba(15, 23, 42, 0.7); border: 1px solid ${color}40; border-left: 4px solid ${color}; padding: 12px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 0.85em; color: #cbd5e1; box-shadow: 0 4px 10px rgba(0,0,0,0.3); margin-top: 15px;"><div style="font-weight:bold; color:${color}; margin-bottom: 6px; border-bottom: 1px dashed ${color}80; padding-bottom: 4px; letter-spacing: 1px;">${title}</div><div style="white-space: pre-wrap; line-height: 1.6;">$1</div></div>`;
    const regexScript = { id: "statusbar_" + Date.now(), scriptName: "çŠ¶æ€æ UIç¾åŒ– (ç³»ç»Ÿç”Ÿæˆ)", regex: "<stablock>([\\s\\S]*?)<\\/stablock>", replacementString: replacementHTML, placement: [1], disabled: false, markdownOnly: false, promptOnly: false, runOnEdit: true, color: color };

    
    if (window.injectStatusBarGlobal) {
      window.injectStatusBarGlobal(newWbEntry, regexScript);
      sbStatusText.textContent = "âœ… æ³¨å…¥æˆåŠŸï¼åº•å±‚æç¤ºè¯ä¸æ­£åˆ™å·²å°±ç»ªã€‚";
      setTimeout(() => sbStatusText.textContent = "", 3000);
    }
  });

  
  sbEnable.addEventListener('change', () => {
    if (window.setStatusBarActiveState) {
      window.setStatusBarActiveState(sbEnable.checked);
    }
  });
</script>