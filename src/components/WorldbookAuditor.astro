---
---
<div class="panel wb-auditor area-auditor">
  <h2>ğŸ” ä¸–ç•Œä¹¦å®¡è®¡å®˜</h2>

  <!-- æ§åˆ¶æ ï¼šç«–æ’æŒ‰é’® + ç®€è¦è¯´æ˜ -->
  <div class="auditor-intro">
    <p class="auditor-desc">åˆ†æä¸–ç•Œä¹¦çš„å®Œæ•´åº¦ã€è§¦å‘è¯è®¾è®¡ã€å†…å®¹è´¨é‡ç­‰ç»´åº¦ï¼Œæ‰¾å‡ºæ½œåœ¨é—®é¢˜å¹¶ç»™å‡ºæ”¹è¿›å»ºè®®ã€‚</p>
    <div class="auditor-btn-group">
      <button id="btnQuickCheck" class="btn btn-audit-quick">âš¡ å¿«é€Ÿè‡ªæ£€</button>
      <button id="btnRunAudit" class="btn btn-audit-run">ğŸ§  AI æ·±åº¦å®¡è®¡</button>
    </div>
  </div>

  <!-- AI å®¡è®¡çŠ¶æ€ -->
  <div id="auditStatus" class="audit-status"></div>

  <!-- å¿«é€Ÿè‡ªæ£€ç»“æœ -->
  <div id="quickCheckResult" class="audit-section" style="display: none;"></div>

  <!-- AI å®¡è®¡æŠ¥å‘Š -->
  <div id="auditReport" class="audit-section" style="display: none;">
    <!-- æ€»è¯„åˆ† -->
    <div id="auditScoreCard" class="audit-score-card">
      <div class="audit-score-ring">
        <svg viewBox="0 0 100 100">
          <circle class="score-bg" cx="50" cy="50" r="42" />
          <circle class="score-fill" id="scoreCircle" cx="50" cy="50" r="42" />
        </svg>
        <div class="score-number" id="scoreNumber">0</div>
      </div>
      <div class="audit-score-info">
        <div class="score-grade" id="scoreGrade">--</div>
        <div class="score-summary" id="scoreSummary">ç­‰å¾…å®¡è®¡...</div>
      </div>
    </div>

    <!-- ç»´åº¦åˆ†æ -->
    <div id="auditDimensions" class="audit-dimensions"></div>

    <!-- è¯¦ç»†é—®é¢˜åˆ—è¡¨ -->
    <div id="auditIssues" class="audit-issues"></div>

    <!-- AI å»ºè®® -->
    <div id="auditSuggestions" class="audit-suggestions"></div>
  </div>
</div>

<style>
  .wb-auditor {
    display: flex;
    flex-direction: column;
  }

  
  .auditor-intro {
    margin-bottom: 14px;
  }
  .auditor-desc {
    font-size: 0.72rem;
    color: #64748b;
    line-height: 1.5;
    margin-bottom: 10px;
  }
  .auditor-btn-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .btn-audit-quick {
    width: 100%;
    background: rgba(56, 189, 248, 0.08);
    border: 1px solid rgba(56, 189, 248, 0.2);
    color: #38bdf8;
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 0.82rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: inherit;
  }
  .btn-audit-quick:hover {
    background: rgba(56, 189, 248, 0.15);
    border-color: rgba(56, 189, 248, 0.35);
    box-shadow: 0 2px 12px rgba(56, 189, 248, 0.12);
  }
  .btn-audit-run {
    width: 100%;
    background: linear-gradient(135deg, #8b5cf6, #6d28d9);
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: inherit;
  }
  .btn-audit-run:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 16px rgba(139, 92, 246, 0.3);
  }
  .btn-audit-run:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  
  .audit-status {
    font-size: 0.78rem;
    min-height: 0;
    margin-bottom: 4px;
    transition: all 0.3s ease;
  }
  .audit-status:empty {
    display: none;
  }

  
  .audit-section {
    animation: auditFadeIn 0.4s ease;
  }
  @keyframes auditFadeIn {
    from { opacity: 0; transform: translateY(6px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  
  .audit-score-card {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px;
    background: rgba(139, 92, 246, 0.05);
    border: 1px solid rgba(139, 92, 246, 0.15);
    border-radius: 12px;
    margin-bottom: 12px;
  }
  .audit-score-ring {
    position: relative;
    width: 72px;
    height: 72px;
    flex-shrink: 0;
  }
  .audit-score-ring svg {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
  }
  .score-bg {
    fill: none;
    stroke: rgba(139, 92, 246, 0.1);
    stroke-width: 6;
  }
  .score-fill {
    fill: none;
    stroke: #8b5cf6;
    stroke-width: 6;
    stroke-linecap: round;
    stroke-dasharray: 264;
    stroke-dashoffset: 264;
    transition: stroke-dashoffset 1.5s ease, stroke 0.5s ease;
  }
  .score-number {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 1.3rem;
    font-weight: 800;
    color: #c4b5fd;
    font-family: 'JetBrains Mono', monospace;
  }
  .audit-score-info {
    flex: 1;
    min-width: 0;
  }
  .score-grade {
    font-size: 1rem;
    font-weight: 800;
    margin-bottom: 3px;
  }
  .score-summary {
    font-size: 0.72rem;
    color: #94a3b8;
    line-height: 1.5;
    word-break: break-word;
  }

  
  .audit-dimensions {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 12px;
  }
  .dim-card {
    background: rgba(30, 41, 59, 0.5);
    border: 1px solid rgba(51, 65, 85, 0.4);
    border-radius: 8px;
    padding: 10px 12px;
    transition: all 0.2s ease;
  }
  .dim-card:hover {
    border-color: rgba(139, 92, 246, 0.3);
    background: rgba(30, 41, 59, 0.7);
  }
  .dim-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
  }
  .dim-name {
    font-size: 0.74rem;
    font-weight: 600;
    color: #e2e8f0;
  }
  .dim-status {
    font-size: 0.62rem;
    padding: 1px 7px;
    border-radius: 99px;
    font-weight: 600;
  }
  .dim-status.good {
    background: rgba(16, 185, 129, 0.12);
    color: #34d399;
    border: 1px solid rgba(16, 185, 129, 0.25);
  }
  .dim-status.warn {
    background: rgba(245, 158, 11, 0.12);
    color: #fbbf24;
    border: 1px solid rgba(245, 158, 11, 0.25);
  }
  .dim-status.bad {
    background: rgba(239, 68, 68, 0.12);
    color: #fca5a5;
    border: 1px solid rgba(239, 68, 68, 0.25);
  }
  .dim-status.none {
    background: rgba(100, 116, 139, 0.12);
    color: #64748b;
    border: 1px solid rgba(100, 116, 139, 0.25);
  }
  .dim-bar {
    height: 4px;
    background: rgba(51, 65, 85, 0.5);
    border-radius: 99px;
    overflow: hidden;
    margin-bottom: 4px;
  }
  .dim-bar-fill {
    height: 100%;
    border-radius: 99px;
    transition: width 1s ease;
  }
  .dim-detail {
    font-size: 0.65rem;
    color: #64748b;
    line-height: 1.4;
  }

  
  .audit-issues {
    margin-bottom: 12px;
  }
  .audit-issues-title {
    font-size: 0.78rem;
    font-weight: 700;
    color: #e2e8f0;
    margin-bottom: 8px;
  }
  .issue-item {
    display: flex;
    gap: 8px;
    padding: 8px 10px;
    background: rgba(30, 41, 59, 0.4);
    border-radius: 8px;
    margin-bottom: 6px;
    border-left: 3px solid transparent;
    animation: issueIn 0.3s ease both;
  }
  @keyframes issueIn {
    0% { opacity: 0; transform: translateX(-8px); }
    100% { opacity: 1; transform: translateX(0); }
  }
  .issue-item.critical { border-left-color: #ef4444; }
  .issue-item.warning  { border-left-color: #f59e0b; }
  .issue-item.info     { border-left-color: #38bdf8; }
  .issue-item.tip      { border-left-color: #34d399; }
  .issue-icon {
    font-size: 0.9rem;
    flex-shrink: 0;
    margin-top: 1px;
  }
  .issue-body {
    flex: 1;
    min-width: 0;
  }
  .issue-title {
    font-size: 0.78rem;
    font-weight: 600;
    color: #e2e8f0;
    margin-bottom: 2px;
  }
  .issue-desc {
    font-size: 0.7rem;
    color: #94a3b8;
    line-height: 1.4;
    word-break: break-word;
  }

  
  .audit-suggestions {
    background: rgba(139, 92, 246, 0.05);
    border: 1px solid rgba(139, 92, 246, 0.15);
    border-radius: 10px;
    padding: 14px;
  }
  .suggestions-title {
    font-size: 0.82rem;
    font-weight: 700;
    color: #c4b5fd;
    margin-bottom: 10px;
  }
  .suggestion-item {
    display: flex;
    gap: 8px;
    align-items: flex-start;
    margin-bottom: 8px;
    font-size: 0.75rem;
    color: #cbd5e1;
    line-height: 1.5;
  }
  .suggestion-item:last-child { margin-bottom: 0; }
  .suggestion-num {
    background: rgba(139, 92, 246, 0.2);
    color: #c4b5fd;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.65rem;
    font-weight: 700;
    flex-shrink: 0;
  }

  
  .qc-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
    margin-bottom: 10px;
  }
  .qc-stat {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 10px;
    background: rgba(30, 41, 59, 0.5);
    border-radius: 8px;
    border: 1px solid rgba(51, 65, 85, 0.4);
  }
  .qc-stat-num {
    font-size: 1.1rem;
    font-weight: 800;
    font-family: 'JetBrains Mono', monospace;
    min-width: 28px;
    text-align: right;
  }
  .qc-stat-label {
    font-size: 0.68rem;
    color: #94a3b8;
    line-height: 1.3;
  }

  
  .qc-dim-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-bottom: 10px;
  }
  .qc-dim-tag {
    font-size: 0.62rem;
    padding: 2px 8px;
    border-radius: 99px;
    font-weight: 500;
    white-space: nowrap;
  }

  
  .qc-issue-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  
  .qc-section-title {
    font-size: 0.72rem;
    font-weight: 700;
    color: #94a3b8;
    margin-bottom: 6px;
    margin-top: 4px;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }
</style>

<script is:inline>
(function() {
  
  
  
  var btnRunAudit = document.getElementById('btnRunAudit');
  var btnQuickCheck = document.getElementById('btnQuickCheck');
  var quickCheckResult = document.getElementById('quickCheckResult');
  var auditStatus = document.getElementById('auditStatus');
  var auditReport = document.getElementById('auditReport');
  var auditScoreCard = document.getElementById('auditScoreCard');
  var scoreCircle = document.getElementById('scoreCircle');
  var scoreNumber = document.getElementById('scoreNumber');
  var scoreGrade = document.getElementById('scoreGrade');
  var scoreSummary = document.getElementById('scoreSummary');
  var auditDimensions = document.getElementById('auditDimensions');
  var auditIssues = document.getElementById('auditIssues');
  var auditSuggestions = document.getElementById('auditSuggestions');

  
  
  
  function getCharData() {
    return {
      name: (document.getElementById('charName') || {}).value || '',
      description: (document.getElementById('charDesc') || {}).value || '',
      firstMes: (document.getElementById('firstMes') || {}).value || '',
    };
  }

  function getEntries() {
    if (window.__getWorldbookEntries__) return window.__getWorldbookEntries__();
    return [];
  }

  
  
  
  btnQuickCheck.addEventListener('click', function() {
    var entries = getEntries();
    var char = getCharData();
    var issues = [];

    var totalEntries = entries.length;
    var constantCount = entries.filter(function(e) { return e.strategy === 'constant'; }).length;
    var selectiveCount = entries.filter(function(e) { return e.strategy === 'selective'; }).length;
    var skeletonCount = entries.filter(function(e) { return (e.content || '').length < 60; }).length;
    var noKeysCount = entries.filter(function(e) { return e.strategy === 'selective' && (!e.keys || e.keys.length === 0); }).length;
    var emptyContentCount = entries.filter(function(e) { return !e.content || e.content.trim().length < 5; }).length;
    var totalContentLen = entries.reduce(function(s, e) { return s + (e.content || '').length; }, 0);

    if (totalEntries === 0) {
      issues.push({ level: 'critical', icon: 'ğŸš«', title: 'ä¸–ç•Œä¹¦ä¸ºç©º', desc: 'è¿˜æ²¡æœ‰ä»»ä½•æ¡ç›®ï¼Œè¯·å…ˆç”Ÿæˆæˆ–æ‰‹åŠ¨æ·»åŠ ã€‚' });
    }
    if (skeletonCount > 0) {
      issues.push({ level: 'warning', icon: 'ğŸ¦´', title: skeletonCount + ' æ¡éª¨æ¶æœªå±•å¼€', desc: 'å†…å®¹è¿‡çŸ­ï¼ˆ<60å­—ï¼‰ï¼Œå»ºè®®ç”¨ã€Œâœ¨ AIé‡å†™ã€å±•å¼€ä¸ºå®Œæ•´è®¾å®šã€‚' });
    }
    if (noKeysCount > 0) {
      issues.push({ level: 'critical', icon: 'ğŸ”‘', title: noKeysCount + ' æ¡ç¼ºå°‘è§¦å‘è¯', desc: 'ç­–ç•¥ä¸º selective ä½†æ²¡æœ‰è§¦å‘è¯ï¼Œè¿™äº›æ¡ç›®æ°¸è¿œä¸ä¼šè¢«æ¿€æ´»ï¼' });
    }
    if (emptyContentCount > 0) {
      issues.push({ level: 'critical', icon: 'ğŸ“­', title: emptyContentCount + ' æ¡å†…å®¹ä¸ºç©º', desc: 'è¿™äº›æ¡ç›®å‡ ä¹æ²¡æœ‰å†…å®¹ï¼Œæ³¨å…¥ä¹Ÿæ²¡æœ‰æ„ä¹‰ã€‚' });
    }
    if (constantCount > 5) {
      issues.push({ level: 'warning', icon: 'ğŸ“Œ', title: 'å¸¸é©»æ¡ç›®è¿‡å¤š (' + constantCount + ')', desc: 'å¤ªå¤šå¸¸é©»æ¡ç›®å ç”¨å¤§é‡ tokenï¼Œå»ºè®®æ§åˆ¶åœ¨ 3-5 æ¡ã€‚' });
    }

    
    var allKeys = {};
    entries.forEach(function(e, idx) {
      (e.keys || []).forEach(function(k) {
        var lk = k.toLowerCase().trim();
        if (!lk) return;
        if (!allKeys[lk]) allKeys[lk] = [];
        allKeys[lk].push(e.comment || 'æ¡ç›®' + idx);
      });
    });
    var dupKeys = Object.keys(allKeys).filter(function(k) { return allKeys[k].length > 1; });
    if (dupKeys.length > 0) {
      issues.push({ level: 'warning', icon: 'ğŸ”„', title: dupKeys.length + ' ä¸ªè§¦å‘è¯é‡å¤', desc: dupKeys.slice(0, 3).map(function(k) { return 'ã€Œ' + k + 'ã€â†’ ' + allKeys[k].join(', '); }).join('ï¼›') });
    }

    
    if (char.name && totalEntries > 0) {
      var nameInKeys = entries.some(function(e) {
        return (e.keys || []).some(function(k) { return k.toLowerCase().indexOf(char.name.toLowerCase()) >= 0; });
      });
      if (!nameInKeys) {
        issues.push({ level: 'info', icon: 'ğŸ’¡', title: 'è§’è‰²åæœªä½œä¸ºè§¦å‘è¯', desc: 'ã€Œ' + char.name + 'ã€ä¸åœ¨ä»»ä½•è§¦å‘è¯ä¸­ï¼Œè€ƒè™‘æ·»åŠ æ ¸å¿ƒè®¾å®šæ¡ç›®ã€‚' });
      }
    }

    if (totalEntries > 0 && totalContentLen < 200) {
      issues.push({ level: 'warning', icon: 'ğŸ“', title: 'æ€»å†…å®¹é‡åå°‘', desc: 'æ‰€æœ‰æ¡ç›®ä»… ' + totalContentLen + ' å­—ï¼Œå¯èƒ½ä¸è¶³ä»¥æ”¯æ’‘ä¸–ç•Œè§‚ã€‚' });
    }

    if (issues.length === 0) {
      issues.push({ level: 'tip', icon: 'âœ…', title: 'å¿«é€Ÿè‡ªæ£€é€šè¿‡', desc: 'æ²¡æœ‰æ˜æ˜¾é—®é¢˜ï¼å¯è¿›è¡Œ AI æ·±åº¦å®¡è®¡è·å–æ›´è¯¦ç»†å»ºè®®ã€‚' });
    }

    var dimensions = detectDimensionCoverage(entries);

    
    quickCheckResult.style.display = 'block';

    var statsHtml = '<div class="qc-section-title">ğŸ“Š åŸºç¡€ç»Ÿè®¡</div>'
      + '<div class="qc-stats">'
      + statCard(totalEntries, 'æ€»æ¡ç›®', '#c4b5fd')
      + statCard(constantCount, 'å¸¸é©»', '#34d399')
      + statCard(selectiveCount, 'è§¦å‘å¼', '#38bdf8')
      + statCard(skeletonCount, 'éª¨æ¶', '#f59e0b')
      + statCard(Math.round(totalContentLen / 1000 * 10) / 10 + 'k', 'æ€»å­—æ•°', '#94a3b8')
      + statCard(issues.length, 'é—®é¢˜', issues[0].level === 'tip' ? '#34d399' : '#ef4444')
      + '</div>';

    var dimHtml = '<div class="qc-section-title">ğŸ§­ ç»´åº¦è¦†ç›–</div>'
      + '<div class="qc-dim-tags">' + renderDimTags(dimensions) + '</div>';

    var issuesHtml = '<div class="qc-section-title">ğŸ” æ£€æŸ¥ç»“æœ</div>'
      + '<div class="qc-issue-list">'
      + issues.map(function(iss, i) {
        return '<div class="issue-item ' + iss.level + '" style="animation-delay:' + (i * 0.06) + 's;">'
          + '<span class="issue-icon">' + iss.icon + '</span>'
          + '<div class="issue-body"><div class="issue-title">' + iss.title + '</div><div class="issue-desc">' + iss.desc + '</div></div></div>';
      }).join('')
      + '</div>';

    quickCheckResult.innerHTML = statsHtml + dimHtml + issuesHtml;
  });

  function statCard(num, label, color) {
    return '<div class="qc-stat"><div class="qc-stat-num" style="color:' + color + ';">' + num + '</div><div class="qc-stat-label">' + label + '</div></div>';
  }

  
  
  
  var DIMENSION_KEYWORDS = {
    'ğŸ—ºï¸ åœ°ç‚¹': ['åœ°ç‚¹', 'åŸå¸‚', 'æ‘åº„', 'å»ºç­‘', 'åŒºåŸŸ', 'é¢†åœ°', 'ä¸–ç•Œ', 'å›½å®¶', 'åŸå ¡', 'æ£®æ—', 'å±±è„‰', 'æµ·æ´‹', 'è¡—é“', 'é…’é¦†', 'å­¦é™¢', 'åºŸå¢Ÿ', 'location', 'city', 'place'],
    'ğŸ‘¥ äººç‰©': ['äººç‰©', 'NPC', 'è§’è‰²', 'åŒä¼´', 'æ•Œäºº', 'é¢†è¢–', 'å•†äºº', 'è€å¸ˆ', 'æœ‹å‹', 'å®¶äºº', 'å¸ˆå‚…', 'å›½ç‹', 'å¥³ç‹', 'character', 'person'],
    'âš”ï¸ åŠ¿åŠ›': ['ç»„ç»‡', 'åŠ¿åŠ›', 'å¸®æ´¾', 'å…¬ä¼š', 'å†›å›¢', 'æ•™ä¼š', 'æ”¿åºœ', 'ä¼ä¸š', 'å®¶æ—', 'è”ç›Ÿ', 'é˜µè¥', 'faction', 'guild', 'organization'],
    'ğŸ”® ç‰©å“': ['ç‰©å“', 'æ­¦å™¨', 'è£…å¤‡', 'é“å…·', 'è¯æ°´', 'å®ç‰©', 'é­”æ³•', 'ç§‘æŠ€', 'ææ–™', 'è´§å¸', 'item', 'weapon', 'equipment'],
    'ğŸ“œ è§„åˆ™': ['è§„åˆ™', 'ç³»ç»Ÿ', 'æ³•åˆ™', 'é­”æ³•ä½“ç³»', 'ç­‰çº§', 'æŠ€èƒ½', 'å±æ€§', 'æœºåˆ¶', 'ç¦å¿Œ', 'æ³•å¾‹', 'rule', 'system', 'magic'],
    'ğŸ“– å†å²': ['å†å²', 'äº‹ä»¶', 'æˆ˜äº‰', 'ä¼ è¯´', 'èµ·æº', 'ç¾éš¾', 'é©å‘½', 'é¢„è¨€', 'çºªå…ƒ', 'è¿‡å»', 'history', 'event', 'lore'],
    'ğŸŒ æ–‡åŒ–': ['æ–‡åŒ–', 'é£ä¿—', 'è¯­è¨€', 'å®—æ•™', 'ä¿¡ä»°', 'èŠ‚æ—¥', 'ä¹ ä¿—', 'ç§æ—', 'æ°‘æ—', 'ä¼ ç»Ÿ', 'culture', 'religion', 'tradition'],
    'ğŸ­ å…³ç³»': ['å…³ç³»', 'ç¤¾äº¤', 'æ‹çˆ±', 'å‹è°Š', 'ä»‡æ¨', 'å¿ è¯š', 'èƒŒå›', 'ç§˜å¯†', 'æƒ…æ„Ÿ', 'relationship', 'social'],
  };

  function detectDimensionCoverage(entries) {
    var allText = entries.map(function(e) {
      return (e.comment || '') + ' ' + (e.content || '') + ' ' + (e.keys || []).join(' ');
    }).join(' ').toLowerCase();

    var results = {};
    Object.keys(DIMENSION_KEYWORDS).forEach(function(dim) {
      var keywords = DIMENSION_KEYWORDS[dim];
      var matchCount = 0;
      keywords.forEach(function(kw) {
        if (allText.indexOf(kw.toLowerCase()) >= 0) matchCount++;
      });
      results[dim] = Math.min(100, Math.round((matchCount / Math.min(keywords.length, 5)) * 100));
    });
    return results;
  }

  function renderDimTags(dimensions) {
    return Object.keys(dimensions).map(function(dim) {
      var cov = dimensions[dim];
      var color, bg;
      if (cov >= 60)      { color = '#34d399'; bg = 'rgba(16,185,129,0.1)'; }
      else if (cov >= 30) { color = '#fbbf24'; bg = 'rgba(245,158,11,0.1)'; }
      else if (cov > 0)   { color = '#fca5a5'; bg = 'rgba(239,68,68,0.1)'; }
      else                { color = '#475569'; bg = 'rgba(51,65,85,0.2)'; }
      return '<span class="qc-dim-tag" style="color:' + color + ';background:' + bg + ';border:1px solid ' + color + '22;">' + dim + ' ' + cov + '%</span>';
    }).join('');
  }

  
  
  
  btnRunAudit.addEventListener('click', async function() {
    var entries = getEntries();
    var char = getCharData();

    if (entries.length === 0) {
      auditStatus.textContent = 'âŒ ä¸–ç•Œä¹¦ä¸ºç©ºï¼Œæ— æ³•å®¡è®¡';
      auditStatus.style.color = '#ef4444';
      return;
    }

    var apiUrlEl = document.getElementById('apiUrl');
    var apiKeyEl = document.getElementById('apiKey');
    var modelEl = document.getElementById('modelSelect');
    var url = (apiUrlEl.value || '').replace(/\/$/, '') + '/chat/completions';
    var key = (apiKeyEl.value || '').trim();
    var model = (modelEl.value || '');
    if (!model) return alert('è¯·å…ˆåœ¨ AI å¼•æ“ä¸­é€‰æ‹©æ¨¡å‹ï¼');

    btnRunAudit.disabled = true;
    btnRunAudit.textContent = 'ğŸ§  å®¡è®¡ä¸­...';
    auditStatus.textContent = 'â³ AI æ­£åœ¨åˆ†æä½ çš„ä¸–ç•Œä¹¦...';
    auditStatus.style.color = '#c4b5fd';
    auditReport.style.display = 'none';

    var wbSummary = entries.map(function(e, i) {
      return '[' + i + '] æ ‡é¢˜: ' + (e.comment || 'æœªå‘½å')
        + ' | ç­–ç•¥: ' + (e.strategy || '?')
        + ' | è§¦å‘è¯: ' + ((e.keys || []).join(', ') || 'æ— ')
        + ' | å†…å®¹(' + (e.content || '').length + 'å­—): ' + (e.content || '').substring(0, 150) + (((e.content || '').length > 150) ? '...' : '');
    }).join('\n');

    var charInfo = 'è§’è‰²å: ' + (char.name || 'æœªè®¾ç½®') + '\nè§’è‰²æè¿°: ' + (char.description || 'æœªè®¾ç½®').substring(0, 300);

    var sysPrompt = 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„é…’é¦†(SillyTavern) V3 è§’è‰²å¡ä¸–ç•Œä¹¦å®¡è®¡ä¸“å®¶ã€‚è¯·å¯¹ä»¥ä¸‹ä¸–ç•Œä¹¦è¿›è¡Œå…¨é¢å®¡è®¡åˆ†æã€‚\n\n'
      + 'ã€è§’è‰²ä¿¡æ¯ã€‘\n' + charInfo + '\n\n'
      + 'ã€ä¸–ç•Œä¹¦æ¡ç›® (å…±' + entries.length + 'æ¡)ã€‘\n' + wbSummary + '\n\n'
      + 'ã€è¾“å‡ºè¦æ±‚ã€‘å¿…é¡»è¾“å‡ºä¸€ä¸ªJSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š\n'
      + '{\n'
      + '  "score": 75,\n'
      + '  "grade": "B+",\n'
      + '  "summary": "ä¸€å¥è¯æ€»è¯„",\n'
      + '  "dimensions": [\n'
      + '    { "name": "ç»´åº¦å", "score": 80, "status": "good|warn|bad|none", "detail": "è¯´æ˜" }\n'
      + '  ],\n'
      + '  "issues": [\n'
      + '    { "level": "critical|warning|info|tip", "title": "é—®é¢˜æ ‡é¢˜", "desc": "è¯¦ç»†è¯´æ˜", "entries": [0,1] }\n'
      + '  ],\n'
      + '  "suggestions": ["å»ºè®®1", "å»ºè®®2", "å»ºè®®3"]\n'
      + '}\n\n'
      + 'å®¡è®¡ç»´åº¦å¿…é¡»åŒ…æ‹¬ï¼š\n'
      + '1. è¦†ç›–å®Œæ•´åº¦ 2. å†…å®¹è´¨é‡ 3. è§¦å‘è¯è®¾è®¡ 4. ç­–ç•¥é…ç½®\n'
      + '5. å†…éƒ¨ä¸€è‡´æ€§ 6. ä¸è§’è‰²å¥‘åˆåº¦ 7. Token æ•ˆç‡ 8. å¯ç©æ€§\n';

    try {
      var headers = { 'Content-Type': 'application/json' };
      if (key) headers['Authorization'] = 'Bearer ' + key;

      var res = await fetch(url, {
        method: 'POST',
        headers: headers,
        body: JSON.stringify({
          model: model,
          messages: [
            { role: 'system', content: sysPrompt },
            { role: 'user', content: 'è¯·å¯¹è¿™ä¸ªä¸–ç•Œä¹¦è¿›è¡Œå…¨é¢å®¡è®¡ï¼Œç»™å‡ºè¯„åˆ†å’Œæ”¹è¿›å»ºè®®ã€‚' }
          ],
          temperature: 0.6
        })
      });

      if (!res.ok) throw new Error('HTTP ' + res.status);
      var raw = (await res.json()).choices[0].message.content;

      var match = raw.match(/```json\s*([\s\S]*?)\s*```/);
      var report = JSON.parse(match ? match[1] : raw);

      renderAuditReport(report);
      auditStatus.textContent = 'âœ… å®¡è®¡å®Œæˆï¼';
      auditStatus.style.color = '#10b981';

    } catch(err) {
      auditStatus.textContent = 'âŒ å®¡è®¡å¤±è´¥: ' + err.message;
      auditStatus.style.color = '#ef4444';
    } finally {
      btnRunAudit.disabled = false;
      btnRunAudit.textContent = 'ğŸ§  AI æ·±åº¦å®¡è®¡';
    }
  });

  
  
  
  function renderAuditReport(report) {
    auditReport.style.display = 'block';

    var score = Math.max(0, Math.min(100, report.score || 0));
    var offset = 264 - (264 * score / 100);
    var scoreColor = score >= 80 ? '#34d399' : (score >= 60 ? '#fbbf24' : (score >= 40 ? '#fb923c' : '#ef4444'));

    setTimeout(function() {
      scoreCircle.style.strokeDashoffset = offset;
      scoreCircle.style.stroke = scoreColor;
    }, 100);

    var currentNum = 0;
    var numInterval = setInterval(function() {
      currentNum += Math.ceil(score / 30);
      if (currentNum >= score) { currentNum = score; clearInterval(numInterval); }
      scoreNumber.textContent = currentNum;
      scoreNumber.style.color = scoreColor;
    }, 40);

    var gradeColors = { 'S': '#c084fc', 'A+': '#34d399', 'A': '#34d399', 'B+': '#38bdf8', 'B': '#38bdf8', 'C+': '#fbbf24', 'C': '#fbbf24', 'D': '#fb923c', 'F': '#ef4444' };
    scoreGrade.textContent = 'ğŸ† ' + (report.grade || '?');
    scoreGrade.style.color = gradeColors[report.grade] || '#94a3b8';
    scoreSummary.textContent = report.summary || '';

    
    if (report.dimensions && report.dimensions.length > 0) {
      auditDimensions.innerHTML = report.dimensions.map(function(dim) {
        var barColor = dim.status === 'good' ? '#34d399' : (dim.status === 'warn' ? '#fbbf24' : (dim.status === 'bad' ? '#ef4444' : '#475569'));
        var dimScore = dim.score || 0;
        return '<div class="dim-card">'
          + '<div class="dim-header"><span class="dim-name">' + escapeHTML(dim.name) + '</span><span class="dim-status ' + (dim.status || 'none') + '">' + dimScore + '%</span></div>'
          + '<div class="dim-bar"><div class="dim-bar-fill" style="width:' + dimScore + '%;background:' + barColor + ';"></div></div>'
          + '<div class="dim-detail">' + escapeHTML(dim.detail || '') + '</div>'
          + '</div>';
      }).join('');
    }

    
    if (report.issues && report.issues.length > 0) {
      var iconMap = { critical: 'ğŸš¨', warning: 'âš ï¸', info: 'ğŸ’¡', tip: 'âœ…' };
      auditIssues.innerHTML = '<div class="audit-issues-title">ğŸ“‹ å‘ç° ' + report.issues.length + ' ä¸ªé—®é¢˜</div>'
        + report.issues.map(function(iss, i) {
          return '<div class="issue-item ' + (iss.level || 'info') + '" style="animation-delay:' + (i * 0.08) + 's;">'
            + '<span class="issue-icon">' + (iconMap[iss.level] || 'ğŸ“Œ') + '</span>'
            + '<div class="issue-body"><div class="issue-title">' + escapeHTML(iss.title || '') + '</div>'
            + '<div class="issue-desc">' + escapeHTML(iss.desc || '')
            + (iss.entries && iss.entries.length > 0 ? ' <span style="color:#8b5cf6;">[æ¡ç›®: ' + iss.entries.join(', ') + ']</span>' : '')
            + '</div></div></div>';
        }).join('');
    } else {
      auditIssues.innerHTML = '<div class="issue-item tip"><span class="issue-icon">âœ…</span><div class="issue-body"><div class="issue-title">æœªå‘ç°ä¸¥é‡é—®é¢˜</div><div class="issue-desc">ä¸–ç•Œä¹¦ç»“æ„è‰¯å¥½ï¼</div></div></div>';
    }

    
    if (report.suggestions && report.suggestions.length > 0) {
      auditSuggestions.innerHTML = '<div class="suggestions-title">ğŸ’¡ æ”¹è¿›å»ºè®®</div>'
        + report.suggestions.map(function(s, i) {
          return '<div class="suggestion-item"><span class="suggestion-num">' + (i + 1) + '</span><span>' + escapeHTML(s) + '</span></div>';
        }).join('');
    }
  }

  function escapeHTML(str) {
    return String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

})();
</script>
