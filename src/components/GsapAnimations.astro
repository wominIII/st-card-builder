---
---
<!-- â˜… GSAP åŠ¨ç”»ç¼–æ’ä¸­å¿ƒ â€” æ”¯æŒç‰¹æ•ˆå¼€å…³ -->
<script is:inline>
(function () {
  if (!window.gsap) return;

  // ============================================================
  //  å·¥å…·
  // ============================================================
  function qAll(sel) { return Array.prototype.slice.call(document.querySelectorAll(sel)); }
  function q(sel) { return document.querySelector(sel); }

  var FX_KEY = 'st_v3_fx_enabled';
  var fxEnabled = true;
  var loopTweens = [];   // æ‰€æœ‰å¯æš‚åœçš„æŒç»­åŠ¨ç”»
  var orbEls = [];       // ç¯å¢ƒå…‰çƒ DOM
  var glowEls = [];      // è¿½å…‰ DOM

  // è¯»å–ä¿å­˜çš„åå¥½
  try {
    var saved = localStorage.getItem(FX_KEY);
    if (saved !== null) fxEnabled = saved === '1';
  } catch(e) {}

  // ============================================================
  //  å¼€å…³ UI ç»‘å®š
  // ============================================================
  var toggle = q('#fxToggle');
  if (toggle) {
    toggle.checked = fxEnabled;
    toggle.addEventListener('change', function () {
      fxEnabled = toggle.checked;
      try { localStorage.setItem(FX_KEY, fxEnabled ? '1' : '0'); } catch(e) {}
      applyFxState();
    });
  }

  function applyFxState() {
    // ç²’å­ Canvas
    var canvas = q('#particleCanvas');
    if (canvas) canvas.style.display = fxEnabled ? '' : 'none';

    // æŒç»­å¾ªç¯åŠ¨ç”»
    loopTweens.forEach(function (tw) {
      if (fxEnabled) tw.resume();
      else tw.pause();
    });

    // ç¯å¢ƒå…‰çƒ
    orbEls.forEach(function (orb) {
      orb.style.display = fxEnabled ? '' : 'none';
    });

    // è¿½å…‰å±‚
    glowEls.forEach(function (el) {
      el.style.display = fxEnabled ? '' : 'none';
    });

    // Header æµå…‰è¾¹æ¡†
    var header = q('.app-header');
    if (header) {
      if (fxEnabled) header.classList.add('header-glow-border');
      else header.classList.remove('header-glow-border');
    }
  }

  // ============================================================
  //  1. å…¥åœºåŠ¨ç”» â€” å˜å½¢é‡‘åˆšæŠ˜å å±•å¼€
  // ============================================================
  var header = q('.app-header');
  var logo = q('.app-logo');
  var title = q('.app-title');
  var subtitle = q('.app-subtitle');
  var badge = q('.app-version-badge');

  var master = gsap.timeline({ defaults: { ease: 'power3.out' } });

  if (header) {
    gsap.set(header, { y: -40, opacity: 0 });
    master.to(header, { y: 0, opacity: 1, duration: 0.8 }, 0);
  }
  if (logo) {
    gsap.set(logo, { scale: 0, rotation: -180 });
    master.to(logo, { scale: 1, rotation: 0, duration: 1, ease: 'back.out(1.7)' }, 0.2);
  }
  if (title) {
    gsap.set(title, { x: -30, opacity: 0 });
    master.to(title, { x: 0, opacity: 1, duration: 0.7 }, 0.4);
  }
  if (subtitle) {
    gsap.set(subtitle, { x: -20, opacity: 0 });
    master.to(subtitle, { x: 0, opacity: 1, duration: 0.6 }, 0.55);
  }
  if (badge) {
    gsap.set(badge, { scale: 0 });
    master.to(badge, { scale: 1, duration: 0.5, ease: 'back.out(2)' }, 0.6);
  }

  // â”€â”€ é¢æ¿ï¼š3D å±•å¼€ â”€â”€ ç‚¹ â†’ çº¿ â†’ é¢ â†’ å†…å®¹ä¾æ¬¡æ»‘å‡º â”€â”€
  var panels = qAll('.app-container > *');
  var panelColors = [
    { r: 99, g: 102, b: 241 },   // AI - é›è“
    { r: 139, g: 92, b: 246 },   // Character - ç´«
    { r: 16, g: 185, b: 129 },   // Worldbook - ç»¿
    { r: 56, g: 189, b: 248 },   // Preview - å¤©è“
    { r: 244, g: 114, b: 182 },  // Chat area - ç²‰
    { r: 245, g: 158, b: 11 },   // StatusBar - ç¥ç€
    { r: 52, g: 211, b: 153 },   // Auditor - ç¿¡ç¿ 
  ];

  function rgba(c, a) { return 'rgba(' + c.r + ',' + c.g + ',' + c.b + ',' + a + ')'; }

  if (panels.length) {
    var container = q('.app-container');
    if (container) {
      container.style.perspective = '1400px';
      container.style.perspectiveOrigin = '50% 30%';
    }

    panels.forEach(function (panel, idx) {
      var c = panelColors[idx % panelColors.length];
      var delay = 0.7 + idx * 0.4;

      // ä¿å­˜åŸå§‹æ ·å¼
      var origBorder = getComputedStyle(panel).borderColor;
      var origBg = getComputedStyle(panel).background;

      // å¼ºåˆ¶ panel ç›¸å¯¹å®šä½ï¼ˆä»…å¯¹ static å…ƒç´ ï¼‰+ åŠ¨ç”»æœŸé—´ç¦æ­¢æ¨ªå‘æº¢å‡º
      var origPosition = getComputedStyle(panel).position;
      var needSetPosition = origPosition === 'static';
      if (needSetPosition) {
        panel.style.position = 'relative';
      }
      panel.style.overflowX = 'hidden';

      // â•â•â• åˆ›å»º"å¤–æ¡†"çŸ©å½¢ï¼ˆç”¨ä¸€ä¸ª border-only çš„ div æ¨¡æ‹Ÿï¼‰ â•â•â•
      var frame = document.createElement('div');
      frame.style.cssText =
        'position:absolute;inset:0;border-radius:inherit;pointer-events:none;z-index:20;' +
        'border:1.5px solid ' + rgba(c, 0.8) + ';' +
        'box-shadow:0 0 12px ' + rgba(c, 0.3) + ', inset 0 0 12px ' + rgba(c, 0.08) + ';' +
        'transform-origin:center center;';
      panel.appendChild(frame);

      // â•â•â• å…‰çº¿æ‰«ææ¡ â•â•â•
      var sweep = document.createElement('div');
      sweep.style.cssText =
        'position:absolute;top:0;left:0;width:40%;height:100%;z-index:21;pointer-events:none;opacity:0;' +
        'background:linear-gradient(90deg, transparent, ' + rgba(c, 0.08) + ', ' + rgba(c, 0.25) + ', ' + rgba(c, 0.08) + ', transparent);' +
        'filter:blur(6px);';
      panel.appendChild(sweep);

      // â•â•â• æ”¶é›†å­å…ƒç´ ï¼ˆåªå–ç›´æ¥å­å…ƒç´ ï¼Œæ’é™¤è¾…åŠ©å±‚ï¼‰ â•â•â•
      var children = [];
      var childNodes = panel.children;
      for (var i = 0; i < childNodes.length; i++) {
        var ch = childNodes[i];
        if (ch === frame || ch === sweep) continue;
        if (ch.classList.contains('panel-hover-glow')) continue;
        if (ch.classList.contains('unfold-scan-line') || ch.classList.contains('unfold-border-glow')) continue;
        children.push(ch);
      }

      // â•â•â• åˆå§‹æ€ï¼šæ•´ä¸ªé¢æ¿å®Œå…¨ä¸å¯è§ï¼Œå¤–æ¡†ä»ä¸€ä¸ªç‚¹å¼€å§‹ â•â•â•
      gsap.set(panel, {
        opacity: 0,
        transformOrigin: '50% 50%',
      });
      // éšè—æ‰€æœ‰å­å†…å®¹
      children.forEach(function (ch) {
        gsap.set(ch, { opacity: 0, y: 0 });
      });

      // â•â•â• å¤–æ¡†åˆå§‹ä¸ºä¸€ä¸ªç‚¹ â•â•â•
      gsap.set(frame, {
        scaleX: 0,
        scaleY: 0,
        opacity: 1,
      });

      var tl = gsap.timeline({ delay: delay });

      // â”€â”€ Phase 1ï¼šé¢æ¿å¯è§ + å¤–æ¡†ä»ç‚¹å˜æˆä¸€æ¡æ¨ªçº¿ (0 â†’ 0.8s) â”€â”€
      tl.to(panel, {
        opacity: 1,
        duration: 0.15,
        ease: 'power1.in',
      }, 0);

      tl.to(frame, {
        scaleX: 1,
        scaleY: 0.015,
        duration: 0.8,
        ease: 'power3.inOut',
      }, 0);

      // å°è¾‰å…‰è„‰å†²åœ¨æ¨ªçº¿å±•å¼€æ—¶
      tl.fromTo(frame, {
        boxShadow: '0 0 20px ' + rgba(c, 0.6) + ', inset 0 0 20px ' + rgba(c, 0.2),
      }, {
        boxShadow: '0 0 8px ' + rgba(c, 0.3) + ', inset 0 0 8px ' + rgba(c, 0.05),
        duration: 0.8,
        ease: 'power2.out',
      }, 0);

      // â”€â”€ Phase 2ï¼šçº¿å‘ä¸Šä¸‹å±•å¼€æˆé¢ (0.7 â†’ 1.8s) â”€â”€
      tl.to(frame, {
        scaleY: 1,
        duration: 1.1,
        ease: 'power2.out',
      }, 0.7);

      // é¢æ¿è‡ªèº«èƒŒæ™¯è·Ÿéšæ˜¾ç°ï¼ˆç”¨ clip-path ä»ä¸­é—´çº¿å‘ä¸Šä¸‹å±•å¼€ï¼‰
      gsap.set(panel, {
        clipPath: 'inset(50% 0% 50% 0%)',
      });
      tl.to(panel, {
        clipPath: 'inset(0% 0% 0% 0%)',
        duration: 1.1,
        ease: 'power2.out',
      }, 0.7);

      // æ‰«æå…‰æ¨ªç©¿
      tl.fromTo(sweep, {
        opacity: 1, left: '-40%',
      }, {
        left: '120%',
        duration: 0.9,
        ease: 'power1.inOut',
      }, 1.0);
      tl.to(sweep, { opacity: 0, duration: 0.2 }, 1.8);

      // â”€â”€ Phase 3ï¼šå†…å®¹å…ƒç´ ä¾æ¬¡ä»ä¸Šä¸€ä¸ªåé¢æ»‘å‡º (1.6s èµ·) â”€â”€
      // æ¯ä¸ªå­å…ƒç´ ä»ä¸Šä¸€ä¸ªå…ƒç´ çš„ä½ç½®"æ»‘å‡ºæ¥"
      var contentStart = 1.6;
      var slideDur = 0.45;
      var slideGap = 0.12;

      children.forEach(function (ch, ci) {
        var t = contentStart + ci * slideGap;

        // åˆå§‹æ€ï¼šè¢«å‰ä¸€ä¸ªé®ä½ï¼Œå åœ¨ä¸Šæ–¹ä½ç½®
        gsap.set(ch, {
          opacity: 0,
          y: -15,
          scale: 0.97,
          filter: 'blur(4px)',
        });

        tl.to(ch, {
          opacity: 1,
          y: 0,
          scale: 1,
          filter: 'blur(0px)',
          duration: slideDur,
          ease: 'power2.out',
        }, t);
      });

      // â”€â”€ Phase 4ï¼šå¤–æ¡†æ¶ˆé€€ï¼Œäº¤è¿˜åŸå§‹æ ·å¼ â”€â”€
      var frameOutTime = contentStart + children.length * slideGap + 0.2;
      tl.to(frame, {
        opacity: 0,
        duration: 0.6,
        ease: 'power2.inOut',
      }, frameOutTime);

      // â”€â”€ æ¸…ç† â”€â”€
      tl.call(function () {
        if (frame.parentNode) frame.parentNode.removeChild(frame);
        if (sweep.parentNode) sweep.parentNode.removeChild(sweep);
        panel.style.clipPath = '';
        panel.style.overflowX = '';
        if (needSetPosition) panel.style.position = '';
        panel.style.filter = '';
      }, null, null, frameOutTime + 0.8);
    });
  }

  if (header) {
    var shine = document.createElement('div');
    shine.className = 'header-shine-sweep';
    header.appendChild(shine);
    master.fromTo(shine, { x: '-100%' }, { x: '200%', duration: 1.2, ease: 'power2.inOut' }, 0.8);
  }

  // ============================================================
  //  2. é¢æ¿ Hover è¿½å…‰ï¼ˆæ—  scaleï¼Œä»…å…‰æ•ˆï¼‰
  // ============================================================
  var allPanels = qAll('.panel, .code-window');
  allPanels.forEach(function (panel) {
    var glowEl = document.createElement('div');
    glowEl.className = 'panel-hover-glow';
    panel.appendChild(glowEl);
    glowEls.push(glowEl);

    panel.addEventListener('mouseenter', function () {
      if (!fxEnabled) return;
      gsap.to(glowEl, { opacity: 1, duration: 0.4 });
    });
    panel.addEventListener('mouseleave', function () {
      gsap.to(glowEl, { opacity: 0, duration: 0.5 });
    });
    var _glowRAF = 0;
    panel.addEventListener('mousemove', function (e) {
      if (!fxEnabled || _glowRAF) return;
      _glowRAF = requestAnimationFrame(function () {
        var rect = panel.getBoundingClientRect();
        glowEl.style.setProperty('--glow-x', (e.clientX - rect.left) + 'px');
        glowEl.style.setProperty('--glow-y', (e.clientY - rect.top) + 'px');
        _glowRAF = 0;
      });
    });
  });

  // ============================================================
  //  3. H2 æ ‡é¢˜å…¥åœº
  // ============================================================
  var h2s = qAll('.panel h2');
  if (h2s.length) {
    var obs = new IntersectionObserver(function (entries) {
      entries.forEach(function (entry) {
        if (entry.isIntersecting) {
          gsap.fromTo(entry.target,
            { x: -20, opacity: 0 },
            { x: 0, opacity: 1, duration: 0.6, ease: 'power2.out' }
          );
          obs.unobserve(entry.target);
        }
      });
    }, { threshold: 0.3 });
    h2s.forEach(function (h) { gsap.set(h, { opacity: 0 }); obs.observe(h); });
  }

  // ============================================================
  //  4. Logo æŒç»­æµ®åŠ¨ + è„‰å†²ï¼ˆå¯æš‚åœï¼‰
  // ============================================================
  if (logo) {
    loopTweens.push(gsap.to(logo, {
      y: -3, duration: 2, ease: 'sine.inOut', yoyo: true, repeat: -1,
    }));
    loopTweens.push(gsap.to(logo, {
      boxShadow: '0 0 18px rgba(139,92,246,0.5), 0 0 40px rgba(139,92,246,0.2)',
      duration: 2, ease: 'sine.inOut', yoyo: true, repeat: -1, delay: 0.5,
    }));
  }

  // ============================================================
  //  5. Badge å‘¼å¸å…‰ï¼ˆå¯æš‚åœï¼‰
  // ============================================================
  if (badge) {
    loopTweens.push(gsap.to(badge, {
      boxShadow: '0 0 12px rgba(139,92,246,0.4), inset 0 0 6px rgba(139,92,246,0.1)',
      duration: 2.5, ease: 'sine.inOut', yoyo: true, repeat: -1,
    }));
  }

  // ============================================================
  //  6. ç¯å¢ƒæµ®å…‰çƒï¼ˆå¯éšè—ï¼‰
  // ============================================================
  function createOrb(color, size, posX, posY, dur) {
    var orb = document.createElement('div');
    orb.className = 'ambient-orb';
    orb.style.cssText =
      'width:' + size + 'px;height:' + size + 'px;' +
      'background:radial-gradient(circle, ' + color + ' 0%, transparent 70%);' +
      'left:' + posX + '%;top:' + posY + '%;';
    document.body.appendChild(orb);
    orbEls.push(orb);
    loopTweens.push(gsap.to(orb, {
      x: 'random(-80, 80)', y: 'random(-60, 60)',
      duration: dur, ease: 'sine.inOut', yoyo: true, repeat: -1,
      delay: Math.random() * 2,
    }));
    loopTweens.push(gsap.to(orb, {
      opacity: 'random(0.3, 0.8)',
      duration: dur * 0.6, ease: 'sine.inOut', yoyo: true, repeat: -1,
    }));
  }

  createOrb('rgba(139,92,246,0.06)', 500, 10, 20, 12);
  createOrb('rgba(56,189,248,0.05)', 400, 80, 10, 15);
  createOrb('rgba(16,185,129,0.04)', 450, 50, 80, 18);
  createOrb('rgba(245,158,11,0.03)', 350, 25, 65, 14);

  // ============================================================
  //  7. Entry item å¼¹å…¥ hook
  // ============================================================
  window.__animateNewEntry__ = function (el) {
    if (!el || !window.gsap || !fxEnabled) return;
    gsap.fromTo(el,
      { y: 20, opacity: 0, scale: 0.95 },
      { y: 0, opacity: 1, scale: 1, duration: 0.45, ease: 'back.out(1.4)' }
    );
  };

  // ============================================================
  //  8. Header è¾¹æ¡†æµå…‰ï¼ˆå¯æš‚åœï¼‰
  // ============================================================
  if (header) {
    header.classList.add('header-glow-border');
    var angle = { value: 0 };
    loopTweens.push(gsap.to(angle, {
      value: 360, duration: 8, ease: 'none', repeat: -1,
      onUpdate: function () {
        header.style.setProperty('--glow-angle', angle.value + 'deg');
      },
    }));
  }

  // ============================================================
  //  9. ä¸–ç•Œä¹¦ç¼–è¾‘ â€” æ–‡å­—é£è¡ŒåŠ¨ç”»ï¼ˆå¼§çº¿ + æ‰“å­—æµ®ç°ï¼‰
  // ============================================================

  /* äºŒæ¬¡è´å¡å°”æ’å€¼ */
  function quadBezier(t, p0, p1, p2) {
    var u = 1 - t;
    return u * u * p0 + 2 * u * t * p1 + t * t * p2;
  }

  /* æ‰“å­—æœºæ•ˆæœï¼šé€å­—å¡«å…¥ input / textarea */
  function typewriterFill(el, text, dur) {
    if (!el || !text) return;
    el.value = '';
    var len = text.length;
    var perChar = dur / len;
    var idx = 0;
    // ç»™å…ƒç´ åŠ ä¸ªè¾‰å…‰æç¤ºæ­£åœ¨å†™å…¥
    el.style.transition = 'box-shadow 0.3s ease, border-color 0.3s ease';
    el.style.boxShadow = '0 0 12px rgba(139,92,246,0.35), inset 0 0 6px rgba(139,92,246,0.1)';
    el.style.borderColor = 'rgba(139,92,246,0.5)';
    function tick() {
      if (idx < len) {
        el.value += text[idx];
        idx++;
        setTimeout(tick, perChar * 1000);
      } else {
        // å†™å®Œï¼Œæ¸é€€è¾‰å…‰
        el.style.boxShadow = '';
        el.style.borderColor = '';
        setTimeout(function () { el.style.transition = ''; }, 350);
      }
    }
    tick();
  }

  /* select ä¸‹æ‹‰æ¡†å»¶è¿Ÿèµ‹å€¼ + é—ªå…‰ */
  function flashSetSelect(el, val) {
    if (!el) return;
    el.style.transition = 'box-shadow 0.3s ease, border-color 0.3s ease';
    el.style.boxShadow = '0 0 12px rgba(139,92,246,0.35)';
    el.style.borderColor = 'rgba(139,92,246,0.5)';
    el.value = val;
    el.dispatchEvent(new Event('change', { bubbles: true }));
    setTimeout(function () {
      el.style.boxShadow = ''; el.style.borderColor = '';
      setTimeout(function () { el.style.transition = ''; }, 350);
    }, 500);
  }

  window.__flyToEditArea__ = function (entryEl, data) {
    if (!gsap || !entryEl) return false;
    if (window.__fxEnabled__ && !window.__fxEnabled__()) return false;

    var editArea = document.getElementById('wbManualEditArea');
    if (!editArea) return;

    var er = entryEl.getBoundingClientRect();
    var ar = editArea.getBoundingClientRect();

    /* â”€â”€ æ„å»ºæ–‡å­—ç¢ç‰‡ï¼ˆå¸¦ç›®æ ‡å­—æ®µ IDï¼‰ â”€â”€ */
    var chips = [];
    if (data.comment)
      chips.push({ t: 'ğŸ“Œ ' + data.comment, c: '#c4b5fd', field: 'entryComment', val: data.comment });
    if (data.content) {
      var preview = data.content.length > 28 ? data.content.slice(0, 28) + 'â€¦' : data.content;
      chips.push({ t: 'ğŸ“ ' + preview, c: '#93c5fd', field: 'entryContent', val: data.content });
    }
    if (data.keys && data.keys.length)
      chips.push({ t: 'ğŸ”‘ ' + data.keys.join(', '), c: '#6ee7b7', field: 'entryKeys', val: data.keys.join(', ') });
    chips.push({ t: 'âš™ï¸ ' + (data.strategy || 'selective'), c: '#fcd34d', field: 'entryStrategy', val: data.strategy || 'selective' });
    if (!chips.length) return;

    /* â”€â”€ åæ ‡ â”€â”€ */
    var sx = er.left + er.width * 0.4;
    var sy = er.top  + er.height / 2;
    var ex = ar.left + ar.width / 2;
    var ey = Math.max(80, Math.min(ar.top + ar.height * 0.35, window.innerHeight - 80));

    /* å¼§çº¿æ§åˆ¶ç‚¹ï¼ˆå‘å·¦æˆ–å‘å³åç§»ï¼Œåˆ¶é€ å¼§åº¦ï¼‰ */
    var dx = ex - sx;
    var dy = ey - sy;
    var curveDir = dx > 0 ? -1 : 1;  // å¼§çº¿å‘åæ–¹å‘å¼¯
    var cpx = (sx + ex) / 2 + curveDir * Math.min(Math.abs(dy) * 0.5, 200);
    var cpy = Math.min(sy, ey) - Math.abs(dy) * 0.25 - 60;  // æ§åˆ¶ç‚¹åœ¨ä¸Šæ–¹

    /* â”€â”€ æ¡ç›®å¡é—ªå…‰è„‰å†² â”€â”€ */
    gsap.fromTo(entryEl,
      { boxShadow: '0 0 0px rgba(139,92,246,0)' },
      {
        boxShadow: '0 0 28px rgba(139,92,246,0.55), inset 0 0 14px rgba(139,92,246,0.15)',
        duration: 0.25, yoyo: true, repeat: 1, ease: 'power2.inOut',
        clearProps: 'boxShadow',
      }
    );

    /* â”€â”€ æ¸…ç©ºè¡¨å•ï¼Œç­‰ç¢ç‰‡åˆ°è¾¾åæ‰“å­—æµ®ç° â”€â”€ */
    var fieldsToType = ['entryComment', 'entryContent', 'entryKeys'];
    fieldsToType.forEach(function (id) {
      var f = document.getElementById(id);
      if (f) f.value = '';
    });

    /* â”€â”€ é€ç‰‡å¼§çº¿é£å‡º â”€â”€ */
    var flyDur = 0.65;  // é£è¡Œæ—¶é•¿

    chips.forEach(function (s, i) {
      var el = document.createElement('div');
      el.textContent = s.t;
      el.style.cssText =
        'position:fixed;z-index:99999;pointer-events:none;' +
        'font-size:0.74rem;font-weight:700;color:' + s.c + ';' +
        'background:rgba(8,12,28,0.92);padding:5px 14px;border-radius:8px;' +
        'border:1px solid ' + s.c + ';' +
        'box-shadow:0 0 18px ' + s.c + '55,0 2px 8px rgba(0,0,0,0.6);' +
        'white-space:nowrap;max-width:220px;overflow:hidden;text-overflow:ellipsis;' +
        'left:0;top:0;opacity:0;font-family:inherit;letter-spacing:0.02em;';

      /* ç²’å­å°¾è¿¹å®¹å™¨ */
      var trail = document.createElement('div');
      trail.style.cssText = 'position:absolute;inset:0;border-radius:inherit;pointer-events:none;overflow:hidden;';
      el.appendChild(trail);

      document.body.appendChild(el);

      var stagger = i * 0.12;
      var perChipOx = (i - (chips.length - 1) / 2) * 32;

      // æ¯ä¸ªç¢ç‰‡å¾®è°ƒæ§åˆ¶ç‚¹
      var myCpx = cpx + perChipOx * 1.5;
      var myCpy = cpy - i * 18;
      var myEx  = ex + perChipOx * 0.3;
      var myEy  = ey + i * 6;

      gsap.set(el, {
        x: sx, y: sy, scale: 0.1, opacity: 0,
        rotation: gsap.utils.random(-12, 12),
      });

      var tl = gsap.timeline({ delay: stagger });

      /* Phase A â€” ä»æ¡ç›®å¡èƒŒåå¼¹å‡º */
      tl.to(el, {
        opacity: 1, scale: 1, rotation: gsap.utils.random(-4, 4),
        x: sx + perChipOx, y: sy - 35 - i * 8,
        duration: 0.3,
        ease: 'back.out(2.2)',
      });

      /* Phase B â€” è´å¡å°”å¼§çº¿é£è¡Œ */
      var progress = { t: 0 };
      var popX = sx + perChipOx;
      var popY = sy - 35 - i * 8;

      tl.to(progress, {
        t: 1,
        duration: flyDur,
        ease: 'power2.inOut',
        onUpdate: function () {
          var p = progress.t;
          var cx = quadBezier(p, popX, myCpx, myEx);
          var cy = quadBezier(p, popY, myCpy, myEy);
          gsap.set(el, {
            x: cx, y: cy,
            rotation: (1 - p) * gsap.utils.random(-6, 6),
            scale: 1 + Math.sin(p * Math.PI) * 0.15,  // é£è¡Œä¸­å¾®å¾®èƒ€å¤§
          });

          /* åŠ¨æ€æ‹–å°¾è¾‰å…‰ */
          var glowStr = Math.sin(p * Math.PI) * 40;
          el.style.boxShadow = '0 0 ' + (18 + glowStr) + 'px ' + s.c + '88, 0 0 ' + (8 + glowStr * 1.5) + 'px ' + s.c + '44, 0 2px 8px rgba(0,0,0,0.6)';
        },
      });

      /* Phase C â€” åˆ°è¾¾åèå…¥æ¶ˆæ•£ + è§¦å‘æ‰“å­—æµ®ç° */
      tl.to(el, {
        opacity: 0, scale: 0.3,
        duration: 0.25, ease: 'power2.in',
        onComplete: function () {
          el.remove();
          /* ç¢ç‰‡åˆ°è¾¾ â†’ æ‰“å­—æµ®ç°å¯¹åº”å­—æ®µ */
          var target = document.getElementById(s.field);
          if (target) {
            if (target.tagName === 'SELECT') {
              flashSetSelect(target, s.val);
            } else {
              var typeDur = Math.min(s.val.length * 0.018, 0.8);
              typewriterFill(target, s.val, Math.max(typeDur, 0.2));
            }
          }
        },
      });
    });

    /* â”€â”€ ç¼–è¾‘åŒºæ¥æ”¶å…‰è„‰å†² â”€â”€ */
    var receiveT = chips.length * 0.12 + 0.3 + flyDur + 0.1;
    gsap.delayedCall(receiveT, function () {
      gsap.fromTo(editArea,
        { boxShadow: '0 0 0 rgba(139,92,246,0)', borderColor: 'rgba(30,41,59,1)' },
        {
          boxShadow: '0 0 30px rgba(139,92,246,0.45), inset 0 0 20px rgba(139,92,246,0.1)',
          borderColor: 'rgba(139,92,246,0.6)',
          duration: 0.35, yoyo: true, repeat: 1, ease: 'power2.inOut',
          clearProps: 'boxShadow,borderColor',
        }
      );

      /* å…¶ä½™éæ‰“å­—å­—æ®µå»¶è¿Ÿèµ‹å€¼ï¼ˆæ•°å­—ã€ä¸‹æ‹‰ç­‰ï¼‰ */
      var extras = [
        { id: 'entryPosition', val: String(data.position || 4) },
        { id: 'entryDepth', val: String(data.depth || 4) },
        { id: 'entryRole', val: String(data.role || 0) },
        { id: 'entryOrder', val: String(data.order || 100) },
        { id: 'entryProb', val: String(data.prob || 100) },
      ];
      extras.forEach(function (item, idx) {
        setTimeout(function () {
          flashSetSelect(document.getElementById(item.id), item.val);
        }, idx * 80);
      });
    });

    return true;
  };

  // ============================================================
  //  åˆå§‹åŒ–çŠ¶æ€
  // ============================================================
  if (!fxEnabled) {
    // ç­‰å…¥åœºåŠ¨ç”»ç»“æŸåå†åº”ç”¨å…³é—­
    master.eventCallback('onComplete', function () { applyFxState(); });
  }

  // æš´éœ²ç»™å¤–éƒ¨
  window.__fxEnabled__ = function () { return fxEnabled; };

})();
</script>
