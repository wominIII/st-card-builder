---
---
<div class="panel ai-panel area-ai">
  <h2>âœ¨ AI å¼•æ“</h2>

  <!-- API é…ç½® -->
  <div class="grid-2">
    <div class="form-group">
      <label>API æ¥å£åœ°å€</label>
      <input type="text" id="apiUrl" value="https:
    </div>
    <div class="form-group">
      <label>API å¯†é’¥</label>
      <input type="password" id="apiKey" placeholder="sk-..." />
    </div>
  </div>

  <div class="grid-2" style="margin-bottom: 16px;">
    <button id="btnFetchModels" class="btn btn-fetch">ğŸ”„ æ‹‰å–å¯ç”¨æ¨¡å‹</button>
    <div class="form-group" style="margin-bottom: 0;">
      <select id="modelSelect">
        <option value="">è¯·å…ˆè·å–æ¨¡å‹...</option>
      </select>
    </div>
  </div>

  <hr class="divider" />

  <!-- è”ç½‘æœç´¢é…ç½® -->
  <div id="searchConfigBlock" style="margin-bottom: 16px;">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
      <div style="display: flex; align-items: center; gap: 8px;">
        <input type="checkbox" id="searchEnable" style="width: 16px; height: 16px; accent-color: #38bdf8; cursor: pointer;" />
        <label for="searchEnable" style="margin: 0; color: #38bdf8; cursor: pointer; font-weight: 700; font-size: 0.88rem;">ğŸŒ è”ç½‘æœç´¢å¢å¼º</label>
      </div>
      <span id="searchModeBadge" style="font-size: 0.62rem; padding: 2px 8px; border-radius: 99px; font-weight: 600; display: none;"></span>
    </div>

    <!-- æŠ˜å åŒºï¼šæœç´¢è¯¦ç»†é…ç½® -->
    <div id="searchConfigDetail" style="display: none;">
      <p style="font-size: 0.7rem; color: #64748b; margin: 0 0 12px 0; line-height: 1.5;">
        å¼€å¯åï¼ŒAI ç”Ÿæˆè§’è‰²/ä¸–ç•Œä¹¦å‰ä¼šå…ˆæœç´¢ç›¸å…³èµ„æ–™ä½œä¸ºå‚è€ƒã€‚<br/>
        <span style="color: #94a3b8;">â€¢ ä¸å¡«æœç´¢ Key â†’ ä¾èµ– AI æ¨¡å‹è‡ªå¸¦è”ç½‘èƒ½åŠ›ï¼ˆGemini/Perplexity ç­‰ï¼‰</span><br/>
        <span style="color: #94a3b8;">â€¢ å¡«å†™æœç´¢ Key â†’ ç‹¬ç«‹æœç´¢å¼•æ“ï¼Œç»“æœæ›´å¯é </span>
      </p>

      <!-- æœç´¢å¼•æ“é€‰æ‹© -->
      <div class="form-group" style="margin-bottom: 10px;">
        <label>æœç´¢å¼•æ“</label>
        <select id="searchEngine">
          <option value="none" selected>ä¸ä½¿ç”¨ç‹¬ç«‹æœç´¢ï¼ˆé  AI è‡ªèº«è”ç½‘ï¼‰</option>
          <option value="serper">Serper.devï¼ˆGoogle ç»“æœ Â· å…è´¹ 2500æ¬¡/æœˆï¼‰</option>
          <option value="tavily">Tavilyï¼ˆAI ä¸“ç”¨ Â· å…è´¹ 1000æ¬¡/æœˆï¼‰</option>
        </select>
      </div>

      <!-- æœç´¢ API Keyï¼ˆåŠ¨æ€æ˜¾ç¤ºï¼‰ -->
      <div id="searchKeyGroup" style="display: none;">
        <div class="form-group" style="margin-bottom: 10px;">
          <label id="searchKeyLabel">æœç´¢ API Key</label>
          <input type="password" id="searchApiKey" placeholder="å¡«å…¥æœç´¢å¼•æ“çš„ API Key..." />
        </div>
        <div id="searchRegisterHint" style="font-size: 0.68rem; color: #64748b; margin-bottom: 10px; line-height: 1.5;"></div>
      </div>

      <!-- æœç´¢é€‰é¡¹ -->
      <div class="grid-2" style="margin-bottom: 10px;">
        <div class="form-group" style="margin-bottom: 0;">
          <label>æœç´¢ç»“æœæ•°é‡</label>
          <select id="searchResultCount">
            <option value="3">3 æ¡ï¼ˆå¿«é€Ÿï¼‰</option>
            <option value="5" selected>5 æ¡ï¼ˆæ¨èï¼‰</option>
            <option value="8">8 æ¡ï¼ˆè¯¦ç»†ï¼‰</option>
            <option value="12">12 æ¡ï¼ˆæ·±åº¦ï¼‰</option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label>æœç´¢è¯­è¨€</label>
          <select id="searchLang">
            <option value="zh-CN" selected>ä¸­æ–‡</option>
            <option value="en">English</option>
            <option value="ja">æ—¥æœ¬èª</option>
            <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
          </select>
        </div>
      </div>

      <!-- è‡ªå®šä¹‰æœç´¢å…³é”®è¯ -->
      <div class="form-group" style="margin-bottom: 10px;">
        <label>è‡ªå®šä¹‰æœç´¢è¯ <span style="font-weight: normal; color: #475569;">ï¼ˆç•™ç©ºåˆ™è‡ªåŠ¨ä»æç¤ºè¯æå–ï¼‰</span></label>
        <input type="text" id="searchCustomQuery" placeholder="ä¾‹å¦‚ï¼šèµ›åšæœ‹å…‹ ä¸–ç•Œè§‚ è®¾å®šé›†..." />
      </div>

      <!-- æœç´¢æµ‹è¯• -->
      <div style="display: flex; gap: 8px; align-items: center;">
        <button id="btnTestSearch" class="btn btn-fetch" style="width: auto; padding: 6px 14px; font-size: 0.78rem; margin: 0;">ğŸ” æµ‹è¯•æœç´¢</button>
        <span id="searchTestStatus" style="font-size: 0.72rem; color: #64748b;"></span>
      </div>

      <!-- æœç´¢ç»“æœé¢„è§ˆ -->
      <div id="searchPreview" style="display: none; margin-top: 10px; max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px; font-size: 0.72rem;"></div>
    </div>
  </div>

  <hr class="divider" />

  <!-- é¢„è®¾å¯¼å…¥ -->
  <div class="preset-upload">
    <label style="color: #c4b5fd; margin-bottom: 8px; display: block; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">ğŸ“‚ å¯¼å…¥é…’é¦†åŸç”Ÿé¢„è®¾ (.json)</label>
    <input type="file" id="presetInput" accept=".json" />
    <div id="presetListContainer" style="display: none; max-height: 180px; overflow-y: auto; margin-top: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 8px;"></div>
    <div id="presetStatus" style="font-size: 0.75rem; margin-top: 8px; color: #64748b;">
      å¯¼å…¥é¢„è®¾åï¼Œå¯å‹¾é€‰è¦æ³¨å…¥çš„æ–‡é£å’Œè§„åˆ™
    </div>
  </div>

  <!-- ç”Ÿæˆæç¤ºè¯ -->
  <div class="form-group">
    <label style="color: #38bdf8;">ğŸ“ [é˜¶æ®µ1] è§’è‰²è®¾å®šæç¤ºè¯</label>
    <textarea id="aiPrompt" placeholder="ä¾‹å¦‚ï¼šä¸€ä¸ªåœ¨èµ›åšæœ‹å…‹ä¸–ç•Œä¸­é æ¡åƒåœ¾ä¸ºç”Ÿçš„è¾¹ç¼˜é»‘å®¢å°‘å¥³..." style="min-height: 80px;"></textarea>
  </div>

  <div class="form-group">
    <label style="color: #34d399;">ğŸŒ [é˜¶æ®µ2] ä¸–ç•Œä¹¦éª¨æ¶æç¤ºè¯</label>
    <textarea id="wbPrompt" placeholder="ä¾‹å¦‚ï¼šå›´ç»•èµ›åšåºŸåœŸå±•å¼€ï¼ŒåŒ…å«æ­¦å™¨ã€åŠ¿åŠ›ã€åœ°ç‚¹ã€NPC..." style="min-height: 60px; border-color: rgba(16, 185, 129, 0.3);"></textarea>
  </div>

  <!-- ä¸–ç•Œä¹¦æ¡æ•°è®¾ç½® -->
  <div style="background: rgba(16, 185, 129, 0.06); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 10px; padding: 12px 14px; margin-bottom: 14px;">
    <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
      <div style="flex: 1;">
        <label style="color: #34d399; font-size: 0.78rem; font-weight: 600; margin: 0 0 4px 0; display: block;">ğŸ¦´ éª¨æ¶æ¨¡å¼</label>
        <p style="font-size: 0.68rem; color: #64748b; margin: 0; line-height: 1.4;">
          ä¸€é”®ç”Ÿæˆæ—¶åªäº§å‡ºç®€çŸ­éª¨æ¶ã€‚åç»­ç”¨ã€Œâœ¨ AIé‡å†™ã€é€æ¡å±•å¼€ã€‚
        </p>
      </div>
      <div style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
        <label style="color: #94a3b8; font-size: 0.75rem; white-space: nowrap; margin: 0;">ç”Ÿæˆ</label>
        <input type="number" id="wbSkeletonCount" value="6" min="1" max="30" style="width: 52px; text-align: center; padding: 6px 4px; font-size: 0.9rem; font-weight: 700; border-color: rgba(16,185,129,0.3);" />
        <label style="color: #94a3b8; font-size: 0.75rem; white-space: nowrap; margin: 0;">æ¡</label>
      </div>
    </div>
    <div style="display: flex; gap: 6px; margin-top: 10px;">
      <button class="wb-count-btn" data-count="3" style="flex:1;">3æ¡</button>
      <button class="wb-count-btn" data-count="6" style="flex:1;">6æ¡</button>
      <button class="wb-count-btn" data-count="10" style="flex:1;">10æ¡</button>
      <button class="wb-count-btn" data-count="15" style="flex:1;">15æ¡</button>
      <button class="wb-count-btn" data-count="20" style="flex:1;">20æ¡</button>
    </div>
  </div>

  <button id="btnAiGenerate" class="btn btn-ai">ğŸš€ ä¸€é”®ç”Ÿæˆï¼ˆè§’è‰² + ä¸–ç•Œä¹¦éª¨æ¶ï¼‰</button>

  <!-- é»‘å®¢é£åŠ¨ç”»åŒºåŸŸ -->
  <div id="hackerOverlay" style="display: none;">
    <div id="hackerCanvas"></div>
    <div id="hackerStatus">
      <div id="hackerPhase"></div>
      <div id="hackerProgress"></div>
      <div id="hackerDetail"></div>
    </div>
  </div>

  <div id="aiStatus" class="status-text"></div>
</div>

<style>
  .wb-count-btn {
    background: rgba(16, 185, 129, 0.08);
    border: 1px solid rgba(16, 185, 129, 0.2);
    color: #6ee7b7;
    padding: 4px 0;
    border-radius: 6px;
    font-size: 0.72rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: inherit;
  }
  .wb-count-btn:hover {
    background: rgba(16, 185, 129, 0.18);
    border-color: rgba(16, 185, 129, 0.4);
    color: #a7f3d0;
    transform: translateY(-1px);
  }
  .wb-count-btn.active {
    background: rgba(16, 185, 129, 0.25);
    border-color: #10b981;
    color: #ecfdf5;
    box-shadow: 0 0 8px rgba(16, 185, 129, 0.3);
  }

  #searchConfigBlock {
    background: rgba(56, 189, 248, 0.04);
    border: 1px solid rgba(56, 189, 248, 0.15);
    border-radius: 10px;
    padding: 14px;
    transition: all 0.3s ease;
  }
  #searchConfigBlock.active {
    border-color: rgba(56, 189, 248, 0.35);
    background: rgba(56, 189, 248, 0.08);
  }

  .search-result-item {
    padding: 8px;
    border-bottom: 1px solid rgba(56, 189, 248, 0.1);
    transition: background 0.15s ease;
  }
  .search-result-item:last-child { border-bottom: none; }
  .search-result-item:hover { background: rgba(56, 189, 248, 0.06); }
  .search-result-title {
    color: #38bdf8;
    font-weight: 600;
    font-size: 0.75rem;
    margin-bottom: 3px;
  }
  .search-result-snippet {
    color: #94a3b8;
    font-size: 0.7rem;
    line-height: 1.4;
  }
  .search-result-url {
    color: #475569;
    font-size: 0.62rem;
    margin-top: 2px;
    word-break: break-all;
  }

  
  #hackerOverlay {
    position: relative;
    margin-top: 14px;
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid rgba(139, 92, 246, 0.25);
    background: #050510;
    min-height: 160px;
  }
  #hackerCanvas {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    font-family: 'JetBrains Mono', 'Courier New', monospace;
    font-size: 0.65rem;
    line-height: 1.2;
    color: rgba(139, 92, 246, 0.15);
    overflow: hidden;
    white-space: pre-wrap;
    word-break: break-all;
    padding: 8px;
    pointer-events: none;
  }
  #hackerStatus {
    position: relative;
    z-index: 2;
    padding: 20px 16px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 160px;
    gap: 12px;
  }
  #hackerPhase {
    font-size: 0.95rem;
    font-weight: 700;
    color: #c4b5fd;
    text-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
    text-align: center;
    animation: hackerGlow 1.5s ease-in-out infinite;
  }
  #hackerProgress {
    width: 80%;
    max-width: 260px;
    height: 4px;
    background: rgba(139, 92, 246, 0.15);
    border-radius: 99px;
    overflow: hidden;
    position: relative;
  }
  #hackerProgress::after {
    content: '';
    position: absolute;
    top: 0; left: 0;
    height: 100%;
    width: var(--progress, 0%);
    background: linear-gradient(90deg, #8b5cf6, #c084fc, #8b5cf6);
    border-radius: 99px;
    transition: width 0.4s ease;
    box-shadow: 0 0 12px rgba(139, 92, 246, 0.5);
  }
  #hackerDetail {
    font-size: 0.7rem;
    color: #64748b;
    text-align: center;
    font-family: 'JetBrains Mono', monospace;
    min-height: 1.2em;
  }
  @keyframes hackerGlow {
    0%, 100% { text-shadow: 0 0 20px rgba(139, 92, 246, 0.5); }
    50% { text-shadow: 0 0 40px rgba(139, 92, 246, 0.8), 0 0 80px rgba(139, 92, 246, 0.3); }
  }
  #hackerOverlay::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.5), transparent);
    animation: hackerScan 2s linear infinite;
    pointer-events: none;
    z-index: 3;
  }
  @keyframes hackerScan {
    0% { top: 0; opacity: 1; }
    100% { top: 100%; opacity: 0.2; }
  }
</style>

<script is:inline>
(function() {
  var wbSkeletonCount  = document.getElementById('wbSkeletonCount');
  var countBtns        = document.querySelectorAll('.wb-count-btn');
  var hackerOverlay    = document.getElementById('hackerOverlay');
  var hackerCanvas     = document.getElementById('hackerCanvas');
  var hackerPhase      = document.getElementById('hackerPhase');
  var hackerProgress   = document.getElementById('hackerProgress');
  var hackerDetail     = document.getElementById('hackerDetail');

  
  var searchEnable      = document.getElementById('searchEnable');
  var searchConfigBlock = document.getElementById('searchConfigBlock');
  var searchConfigDetail = document.getElementById('searchConfigDetail');
  var searchModeBadge   = document.getElementById('searchModeBadge');
  var searchEngine      = document.getElementById('searchEngine');
  var searchKeyGroup    = document.getElementById('searchKeyGroup');
  var searchKeyLabel    = document.getElementById('searchKeyLabel');
  var searchApiKey      = document.getElementById('searchApiKey');
  var searchRegisterHint = document.getElementById('searchRegisterHint');
  var searchResultCount = document.getElementById('searchResultCount');
  var searchLang        = document.getElementById('searchLang');
  var searchCustomQuery = document.getElementById('searchCustomQuery');
  var btnTestSearch     = document.getElementById('btnTestSearch');
  var searchTestStatus  = document.getElementById('searchTestStatus');
  var searchPreview     = document.getElementById('searchPreview');

  var SEARCH_CONFIG_KEY = 'st_v3_builder_search_config';

  
  
  
  function updateCountBtnActive() {
    var val = parseInt(wbSkeletonCount.value);
    countBtns.forEach(function(btn) {
      btn.classList.toggle('active', parseInt(btn.getAttribute('data-count')) === val);
    });
  }
  countBtns.forEach(function(btn) {
    btn.addEventListener('click', function() {
      wbSkeletonCount.value = btn.getAttribute('data-count');
      updateCountBtnActive();
    });
  });
  wbSkeletonCount.addEventListener('input', updateCountBtnActive);
  updateCountBtnActive();

  
  
  
  function updateSearchUI() {
    var enabled = searchEnable.checked;
    searchConfigDetail.style.display = enabled ? 'block' : 'none';
    searchConfigBlock.classList.toggle('active', enabled);

    if (!enabled) {
      searchModeBadge.style.display = 'none';
      return;
    }

    var engine = searchEngine.value;
    searchModeBadge.style.display = 'inline';

    if (engine === 'none') {
      searchModeBadge.textContent = 'AI è‡ªå¸¦è”ç½‘';
      searchModeBadge.style.background = 'rgba(56,189,248,0.12)';
      searchModeBadge.style.color = '#38bdf8';
      searchModeBadge.style.border = '1px solid rgba(56,189,248,0.25)';
      searchKeyGroup.style.display = 'none';
    } else if (engine === 'serper') {
      searchModeBadge.textContent = 'Serper Â· Google';
      searchModeBadge.style.background = 'rgba(16,185,129,0.12)';
      searchModeBadge.style.color = '#34d399';
      searchModeBadge.style.border = '1px solid rgba(16,185,129,0.25)';
      searchKeyGroup.style.display = 'block';
      searchKeyLabel.textContent = 'Serper API Key';
      searchRegisterHint.innerHTML = 'ğŸ“ å…è´¹æ³¨å†Œï¼š<a href="https:
    } else if (engine === 'tavily') {
      searchModeBadge.textContent = 'Tavily Â· AI ä¸“ç”¨';
      searchModeBadge.style.background = 'rgba(245,158,11,0.12)';
      searchModeBadge.style.color = '#fbbf24';
      searchModeBadge.style.border = '1px solid rgba(245,158,11,0.25)';
      searchKeyGroup.style.display = 'block';
      searchKeyLabel.textContent = 'Tavily API Key';
      searchRegisterHint.innerHTML = 'ğŸ“ å…è´¹æ³¨å†Œï¼š<a href="https:
    }

    saveSearchConfig();
  }

  searchEnable.addEventListener('change', updateSearchUI);
  searchEngine.addEventListener('change', updateSearchUI);
  searchApiKey.addEventListener('input', saveSearchConfig);
  searchResultCount.addEventListener('change', saveSearchConfig);
  searchLang.addEventListener('change', saveSearchConfig);

  
  
  
  function saveSearchConfig() {
    localStorage.setItem(SEARCH_CONFIG_KEY, JSON.stringify({
      enabled:     searchEnable.checked,
      engine:      searchEngine.value,
      apiKey:      searchApiKey.value.trim(),
      resultCount: parseInt(searchResultCount.value),
      lang:        searchLang.value,
    }));
  }

  function loadSearchConfig() {
    try {
      var c = JSON.parse(localStorage.getItem(SEARCH_CONFIG_KEY));
      
      if (!c) {
        searchEnable.checked = false;
        updateSearchUI();
        return;
      }
      
      searchEnable.checked = c.enabled === true ? true : false;
      if (c.engine)      searchEngine.value      = c.engine;
      if (c.apiKey)      searchApiKey.value       = c.apiKey;
      if (c.resultCount) searchResultCount.value  = c.resultCount;
      if (c.lang)        searchLang.value         = c.lang;
      updateSearchUI();
    } catch(e) {
      
      searchEnable.checked = false;
      updateSearchUI();
    }
  }

  loadSearchConfig();

  
  
  
  async function executeSearch(query, count, lang) {
    var engine = searchEngine.value;
    var key    = searchApiKey.value.trim();
    if (engine === 'serper' && key) {
      return await searchWithSerper(query, count, lang, key);
    } else if (engine === 'tavily' && key) {
      return await searchWithTavily(query, count, key);
    } else {
      return null;
    }
  }

  async function searchWithSerper(query, count, lang, key) {
    var res = await fetch('https:
      method: 'POST',
      headers: { 'X-API-KEY': key, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        q:   query,
        num: count,
        gl:  lang === 'zh-CN' ? 'cn' : (lang === 'ja' ? 'jp' : 'us'),
        hl:  lang === 'auto' ? 'zh-CN' : lang
      })
    });
    if (!res.ok) throw new Error('Serper æœç´¢å¤±è´¥ HTTP ' + res.status);
    var data = await res.json();
    var results = [];
    if (data.organic) {
      data.organic.forEach(function(item) {
        results.push({ title: item.title || '', snippet: item.snippet || '', url: item.link || '' });
      });
    }
    if (data.knowledgeGraph) {
      var kg = data.knowledgeGraph;
      results.unshift({ title: '[çŸ¥è¯†é¢æ¿] ' + (kg.title || ''), snippet: kg.description || '', url: kg.descriptionLink || '' });
    }
    return results.slice(0, count);
  }

  async function searchWithTavily(query, count, key) {
    var res = await fetch('https:
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ api_key: key, query: query, max_results: count, search_depth: 'basic', include_answer: true })
    });
    if (!res.ok) throw new Error('Tavily æœç´¢å¤±è´¥ HTTP ' + res.status);
    var data = await res.json();
    var results = [];
    if (data.answer) {
      results.push({ title: '[AI æ€»ç»“]', snippet: data.answer, url: '' });
    }
    if (data.results) {
      data.results.forEach(function(item) {
        results.push({ title: item.title || '', snippet: item.content || '', url: item.url || '' });
      });
    }
    return results.slice(0, count + 1);
  }

  function formatSearchResultsForPrompt(results) {
    if (!results || results.length === 0) return '';
    var text = '\n\nã€ğŸŒ è”ç½‘æœç´¢å‚è€ƒèµ„æ–™ã€‘ï¼š\n';
    text += 'ä»¥ä¸‹æ˜¯ä»äº’è”ç½‘æœç´¢åˆ°çš„ç›¸å…³èµ„æ–™ï¼Œè¯·å‚è€ƒè¿™äº›çœŸå®ä¿¡æ¯æ¥ä¸°å¯Œä½ çš„åˆ›ä½œï¼Œä½†ä¸è¦ç…§æ¬ï¼š\n';
    text += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
    results.forEach(function(r, i) {
      text += 'ğŸ“„ [' + (i + 1) + '] ' + r.title + '\n';
      text += '   ' + r.snippet + '\n';
      if (r.url) text += '   ğŸ”— ' + r.url + '\n';
      text += '\n';
    });
    text += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
    text += 'è¯·åŸºäºä»¥ä¸Šå‚è€ƒèµ„æ–™ï¼Œç»“åˆç”¨æˆ·çš„åˆ›æ„è¦æ±‚è¿›è¡Œåˆ›ä½œã€‚å¯ä»¥å€Ÿé‰´ä½†ä¸è¦ç…§æ¬åŸæ–‡ã€‚\n';
    return text;
  }

  function renderSearchPreview(results) {
    if (!results || results.length === 0) { searchPreview.style.display = 'none'; return; }
    var html = '';
    results.forEach(function(r) {
      html += '<div class="search-result-item">';
      html += '<div class="search-result-title">'   + escapeHTMLSimple(r.title)                        + '</div>';
      html += '<div class="search-result-snippet">' + escapeHTMLSimple(r.snippet).substring(0, 200)    + '</div>';
      if (r.url) html += '<div class="search-result-url">' + escapeHTMLSimple(r.url) + '</div>';
      html += '</div>';
    });
    searchPreview.innerHTML = html;
    searchPreview.style.display = 'block';
  }

  function escapeHTMLSimple(str) {
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  
  
  
  btnTestSearch.addEventListener('click', async function() {
    var engine = searchEngine.value;
    var query  = searchCustomQuery.value.trim() || document.getElementById('aiPrompt').value.trim();
    if (!query) {
      searchTestStatus.textContent = 'âŒ è¯·å…ˆå¡«å†™æç¤ºè¯æˆ–æœç´¢è¯';
      searchTestStatus.style.color = '#fca5a5';
      return;
    }
    if (engine === 'none') {
      searchTestStatus.textContent = 'â„¹ï¸ å½“å‰ä¸º AI è‡ªå¸¦è”ç½‘æ¨¡å¼ï¼Œæ— éœ€æµ‹è¯•';
      searchTestStatus.style.color = '#38bdf8';
      searchPreview.style.display = 'none';
      return;
    }
    if (!searchApiKey.value.trim()) {
      searchTestStatus.textContent = 'âŒ è¯·å…ˆå¡«å†™æœç´¢ API Key';
      searchTestStatus.style.color = '#fca5a5';
      return;
    }
    btnTestSearch.disabled = true;
    searchTestStatus.textContent = 'ğŸ” æœç´¢ä¸­...';
    searchTestStatus.style.color = '#38bdf8';
    try {
      var count   = parseInt(searchResultCount.value) || 5;
      var lang    = searchLang.value;
      var results = await executeSearch(query, count, lang);
      if (results && results.length > 0) {
        searchTestStatus.textContent = 'âœ… æ‰¾åˆ° ' + results.length + ' æ¡ç»“æœ';
        searchTestStatus.style.color = '#34d399';
        renderSearchPreview(results);
      } else {
        searchTestStatus.textContent = 'âš ï¸ æœªæ‰¾åˆ°ç»“æœ';
        searchTestStatus.style.color = '#fbbf24';
        searchPreview.style.display = 'none';
      }
    } catch(err) {
      searchTestStatus.textContent = 'âŒ ' + err.message;
      searchTestStatus.style.color = '#fca5a5';
      searchPreview.style.display = 'none';
    } finally {
      btnTestSearch.disabled = false;
    }
  });

  
  
  
  var hackerChars   = '01ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒŠãƒ‹ãƒŒãƒãƒãƒãƒ’ãƒ•ãƒ˜ãƒ›ãƒãƒŸãƒ ãƒ¡ãƒ¢ãƒ¤ãƒ¦ãƒ¨ãƒ©ãƒªãƒ«ãƒ¬ãƒ­ãƒ¯ãƒ²ãƒ³{}[]<>/\\|=+-*&^%$#@!~;:,.?ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  var hackerAnimId  = null;
  var hackerStreamText = '';

  function startHackerAnim() {
    hackerOverlay.style.display = 'block';
    hackerStreamText = '';
    hackerCanvas.textContent = '';
    for (var i = 0; i < 800; i++) {
      hackerStreamText += hackerChars[Math.floor(Math.random() * hackerChars.length)];
      if (Math.random() < 0.08) hackerStreamText += '\n';
    }
    hackerCanvas.textContent = hackerStreamText;
    var frameCount = 0;
    function tick() {
      frameCount++;
      if (frameCount % 2 === 0) {
        var arr     = hackerStreamText.split('');
        var changes = 15 + Math.floor(Math.random() * 25);
        for (var c = 0; c < changes; c++) {
          var pos = Math.floor(Math.random() * arr.length);
          if (arr[pos] !== '\n') arr[pos] = hackerChars[Math.floor(Math.random() * hackerChars.length)];
        }
        var newLine = '';
        for (var n = 0; n < 20; n++) newLine += hackerChars[Math.floor(Math.random() * hackerChars.length)];
        arr.push('\n');
        for (var nn = 0; nn < newLine.length; nn++) arr.push(newLine[nn]);
        if (arr.length > 1200) arr.splice(0, arr.length - 1200);
        hackerStreamText = arr.join('');
        hackerCanvas.textContent = hackerStreamText;
        hackerCanvas.scrollTop = hackerCanvas.scrollHeight;
      }
      hackerAnimId = requestAnimationFrame(tick);
    }
    hackerAnimId = requestAnimationFrame(tick);
  }

  function stopHackerAnim()  { if (hackerAnimId) { cancelAnimationFrame(hackerAnimId); hackerAnimId = null; } }
  function hideHackerOverlay() { hackerOverlay.style.display = 'none'; }
  function setHackerPhase(text)  { hackerPhase.textContent = text; }
  function setHackerProgress(current, total) {
    var pct = total > 0 ? Math.round((current / total) * 100) : 0;
    hackerProgress.style.setProperty('--progress', pct + '%');
  }
  function setHackerDetail(text) { hackerDetail.textContent = text; }

  var hackerMessages = [
    'æ­£åœ¨ç¼–è¯‘ç¥ç»è¯­è¨€çŸ©é˜µ...',
    'é‡å­çº ç¼ é€šé“å·²å»ºç«‹...',
    'è§£ç äºšç©ºé—´è®¾å®šç¢ç‰‡...',
    'æ³¨å…¥è™šæ„ç°å®åæ ‡...',
    'æ‰«æå¹³è¡Œä¸–ç•Œçº¿...',
    'åŒæ­¥è§’è‰²çµé­‚æ•°æ®...',
    'é‡æ„å™äº‹å› æœé“¾...',
    'åŠ è½½ä¸–ç•Œè§‚æ‹“æ‰‘ç»“æ„...',
    'æ ¡å‡†è§’è‰²äººæ ¼å‘é‡...',
    'ç¼–ç»‡å‘½è¿ä¹‹çº¿...',
    'æå–è®¾å®šåŸºå› åºåˆ—...',
    'æ¸²æŸ“è§’è‰²å…¨æ¯æŠ•å½±...',
    'å»ºç«‹ä¸–ç•Œä¹¦ç´¢å¼•èŠ‚ç‚¹...',
    'æ¿€æ´»æ·±å±‚å™äº‹å¼•æ“...',
    'è§£æè§’è‰²æ½œæ„è¯†å±‚...',
    'æ„å»ºè™šæ‹Ÿå­˜åœ¨è¯æ˜...',
    'æŠ˜å å¤šç»´è®¾å®šç©ºé—´...',
    'åˆå§‹åŒ–æ•…äº‹å¥‡ç‚¹...',
    'æ‹¦æˆªè·¨ç»´åº¦ä¿¡æ¯æµ...',
    'è§£é”å™äº‹é‡å­æ€...',
  ];
  function getRandomHackerMsg() { return hackerMessages[Math.floor(Math.random() * hackerMessages.length)]; }

  
  
  
  window.__hackerAnim__ = {
    start:    startHackerAnim,
    stop:     stopHackerAnim,
    hide:     hideHackerOverlay,
    setPhase: setHackerPhase,
    setProgress: setHackerProgress,
    setDetail:   setHackerDetail,
    randomMsg:   getRandomHackerMsg,
  };

  window.__getSkeletonCount__ = function() {
    var v = parseInt(wbSkeletonCount.value);
    if (isNaN(v) || v < 1) return 6;
    if (v > 30) return 30;
    return v;
  };

  window.__searchConfig__ = {
    isEnabled:     function() { return searchEnable.checked; },
    getEngine:     function() { return searchEngine.value; },
    getCustomQuery: function() { return searchCustomQuery.value.trim(); },
    getResultCount: function() { return parseInt(searchResultCount.value) || 5; },
    getLang:        function() { return searchLang.value; },
    executeSearch:  executeSearch,
    formatForPrompt: formatSearchResultsForPrompt,
  };

})();
</script>
