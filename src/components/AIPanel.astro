---
---
<div class="panel ai-panel area-ai">
  <h2>âœ¨ AI å¼•æ“</h2>

  <!-- API åœ°å€ + å¯†é’¥ -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;width:100%;margin-bottom:8px;">
    <div class="form-group" style="margin-bottom:0;">
      <label>API æ¥å£åœ°å€</label>
      <input type="text" id="apiUrl" value="https://api.openai.com/v1" placeholder="https://..." style="width:100%;" />
    </div>
    <div class="form-group" style="margin-bottom:0;">
      <label>API å¯†é’¥</label>
      <input type="password" id="apiKey" placeholder="sk-..." style="width:100%;" />
    </div>
  </div>

  <!-- åè®®æç¤ºæ¡ï¼ˆç‹¬å ä¸€è¡Œï¼Œç´§å‡‘ï¼‰ -->
  <div id="apiUrlHint" style="display:none;margin-bottom:8px;"></div>

  <!-- æ‹‰å–æ¨¡å‹ + æ¨¡å‹é€‰æ‹© -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;width:100%;margin-bottom:16px;">
    <button id="btnFetchModels" class="btn btn-fetch" style="margin:0;">ğŸ”„ æ‹‰å–æ¨¡å‹</button>
    <div class="form-group" style="margin-bottom:0;">
      <select id="modelSelect" style="width:100%;">
        <option value="">è¯·å…ˆè·å–æ¨¡å‹...</option>
      </select>
    </div>
  </div>

  <hr class="divider" />

  <!-- è”ç½‘æœç´¢é…ç½® -->
  <div id="searchConfigBlock" style="margin-bottom: 16px;">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
      <div style="display: flex; align-items: center; gap: 8px;">
        <input type="checkbox" id="searchEnable" />
        <label for="searchEnable" style="margin: 0; color: #38bdf8; cursor: pointer; font-weight: 700; font-size: 0.88rem;">ğŸŒ è”ç½‘æœç´¢å¢å¼º</label>
      </div>
      <span id="searchModeBadge" style="font-size: 0.62rem; padding: 2px 8px; border-radius: 99px; font-weight: 600; display: none;"></span>
    </div>

    <!-- æŠ˜å åŒºï¼šæœç´¢è¯¦ç»†é…ç½® -->
    <div id="searchConfigDetail" style="display: none;">
      <p style="font-size: 0.7rem; color: #64748b; margin: 0 0 12px 0; line-height: 1.5;">
        å¼€å¯åï¼ŒAI ç”Ÿæˆè§’è‰²/ä¸–ç•Œä¹¦å‰ä¼šå…ˆæœç´¢ç›¸å…³èµ„æ–™ä½œä¸ºå‚è€ƒã€‚<br/>
        <span style="color: #94a3b8;">â€¢ ä¸å¡«æœç´¢ Key â†’ ä¾èµ– AI æ¨¡å‹è‡ªå¸¦è”ç½‘èƒ½åŠ›ï¼ˆGemini/Perplexity ç­‰ï¼‰</span><br/>
        <span style="color: #94a3b8;">â€¢ å¡«å†™æœç´¢ Key â†’ ç‹¬ç«‹æœç´¢å¼•æ“ï¼Œç»“æœæ›´å¯é </span>
      </p>

      <!-- æœç´¢å¼•æ“é€‰æ‹© -->
      <div class="form-group" style="margin-bottom: 10px;">
        <label>æœç´¢å¼•æ“</label>
        <select id="searchEngine">
          <option value="none" selected>ä¸ä½¿ç”¨ç‹¬ç«‹æœç´¢ï¼ˆé  AI è‡ªèº«è”ç½‘ï¼‰</option>
          <option value="serper">Serper.devï¼ˆGoogle ç»“æœ Â· å…è´¹ 2500æ¬¡/æœˆï¼‰</option>
          <option value="tavily">Tavilyï¼ˆAI ä¸“ç”¨ Â· å…è´¹ 1000æ¬¡/æœˆï¼‰</option>
        </select>
      </div>

      <!-- æœç´¢ API Keyï¼ˆåŠ¨æ€æ˜¾ç¤ºï¼‰ -->
      <div id="searchKeyGroup" style="display: none;">
        <div class="form-group" style="margin-bottom: 10px;">
          <label id="searchKeyLabel">æœç´¢ API Key</label>
          <input type="password" id="searchApiKey" placeholder="å¡«å…¥æœç´¢å¼•æ“çš„ API Key..." />
        </div>
        <div id="searchRegisterHint" style="font-size: 0.68rem; color: #64748b; margin-bottom: 10px; line-height: 1.5;"></div>
      </div>

      <!-- æœç´¢é€‰é¡¹ -->
      <div class="grid-2" style="margin-bottom: 10px;">
        <div class="form-group" style="margin-bottom: 0;">
          <label>æœç´¢ç»“æœæ•°é‡</label>
          <select id="searchResultCount">
            <option value="3">3 æ¡</option>
            <option value="5" selected>5 æ¡</option>
            <option value="8">8 æ¡</option>
            <option value="12">12 æ¡</option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label>æœç´¢è¯­è¨€</label>
          <select id="searchLang">
            <option value="zh-CN" selected>ä¸­æ–‡</option>
            <option value="en">English</option>
            <option value="ja">æ—¥æœ¬èª</option>
            <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
          </select>
        </div>
      </div>

      <!-- è‡ªå®šä¹‰æœç´¢å…³é”®è¯ -->
      <div class="form-group" style="margin-bottom: 10px;">
        <label>è‡ªå®šä¹‰æœç´¢è¯ <span style="font-weight: normal; color: #475569;">ï¼ˆç•™ç©ºåˆ™è‡ªåŠ¨ä»æç¤ºè¯æå–ï¼‰</span></label>
        <input type="text" id="searchCustomQuery" placeholder="ä¾‹å¦‚ï¼šèµ›åšæœ‹å…‹ ä¸–ç•Œè§‚ è®¾å®šé›†..." />
      </div>

      <!-- æœç´¢æµ‹è¯• -->
      <div style="display: flex; gap: 8px; align-items: center;">
        <button id="btnTestSearch" class="btn btn-fetch" style="width: auto; padding: 6px 14px; font-size: 0.78rem; margin: 0;">ğŸ” æµ‹è¯•æœç´¢</button>
        <span id="searchTestStatus" style="font-size: 0.72rem; color: #64748b;"></span>
      </div>

      <!-- æœç´¢ç»“æœé¢„è§ˆ -->
      <div id="searchPreview" style="display: none; margin-top: 10px; max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px; font-size: 0.72rem;"></div>
    </div>
  </div>

  <hr class="divider" />

  <!-- é¢„è®¾å¯¼å…¥ -->
  <div class="preset-upload">
    <label style="color: #c4b5fd; margin-bottom: 8px; display: block; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">ğŸ“‚ å¯¼å…¥é…’é¦†åŸç”Ÿé¢„è®¾ (.json)</label>
    <input type="file" id="presetInput" accept=".json" />
    <div id="presetListContainer" style="display: none; max-height: 180px; overflow-y: auto; margin-top: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 8px;"></div>
    <div id="presetStatus" style="font-size: 0.75rem; margin-top: 8px; color: #64748b;">
      å¯¼å…¥é¢„è®¾åï¼Œå¯å‹¾é€‰è¦æ³¨å…¥çš„æ–‡é£å’Œè§„åˆ™
    </div>
  </div>

  <!-- ç”Ÿæˆæç¤ºè¯ -->
  <div class="form-group">
    <label style="color: #38bdf8;">ğŸ“ [é˜¶æ®µ1] è§’è‰²è®¾å®šæç¤ºè¯</label>
    <textarea id="aiPrompt" placeholder="ä¾‹å¦‚ï¼šä¸€ä¸ªåœ¨èµ›åšæœ‹å…‹ä¸–ç•Œä¸­é æ¡åƒåœ¾ä¸ºç”Ÿçš„è¾¹ç¼˜é»‘å®¢å°‘å¥³..." style="min-height: 80px;"></textarea>
  </div>

  <div class="form-group">
    <label style="color: #34d399;">ğŸŒ [é˜¶æ®µ2] ä¸–ç•Œä¹¦éª¨æ¶æç¤ºè¯</label>
    <textarea id="wbPrompt" placeholder="ä¾‹å¦‚ï¼šå›´ç»•èµ›åšåºŸåœŸå±•å¼€ï¼ŒåŒ…å«æ­¦å™¨ã€åŠ¿åŠ›ã€åœ°ç‚¹ã€NPC..." style="min-height: 60px; border-color: rgba(16, 185, 129, 0.3);"></textarea>
  </div>

  <!-- ä¸–ç•Œä¹¦æ¡æ•°è®¾ç½® -->
  <div style="background: rgba(16, 185, 129, 0.06); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 10px; padding: 12px 14px; margin-bottom: 14px;">
    <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
      <div style="flex: 1;">
        <label style="color: #34d399; font-size: 0.78rem; font-weight: 600; margin: 0 0 4px 0; display: block;">ğŸ¦´ éª¨æ¶æ¨¡å¼</label>
        <p style="font-size: 0.68rem; color: #64748b; margin: 0; line-height: 1.4;">
          ä¸€é”®ç”Ÿæˆæ—¶åªäº§å‡ºç®€çŸ­éª¨æ¶ã€‚åç»­ç”¨ã€Œâœ¨ AIé‡å†™ã€é€æ¡å±•å¼€ã€‚
        </p>
      </div>
      <div style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
        <label style="color: #94a3b8; font-size: 0.75rem; white-space: nowrap; margin: 0;">ç”Ÿæˆ</label>
        <input type="number" id="wbSkeletonCount" value="6" min="1" max="30" style="width: 52px; text-align: center; padding: 6px 4px; font-size: 0.9rem; font-weight: 700; border-color: rgba(16,185,129,0.3);" />
        <label style="color: #94a3b8; font-size: 0.75rem; white-space: nowrap; margin: 0;">æ¡</label>
      </div>
    </div>
    <div style="display: flex; gap: 6px; margin-top: 10px;">
      <button class="wb-count-btn" data-count="3" style="flex:1;">3æ¡</button>
      <button class="wb-count-btn" data-count="6" style="flex:1;">6æ¡</button>
      <button class="wb-count-btn" data-count="10" style="flex:1;">10æ¡</button>
      <button class="wb-count-btn" data-count="15" style="flex:1;">15æ¡</button>
      <button class="wb-count-btn" data-count="20" style="flex:1;">20æ¡</button>
    </div>
  </div>

  <button id="btnAiGenerate" class="btn btn-ai">ğŸš€ ä¸€é”®ç”Ÿæˆè§’è‰²å’Œä¸–ç•Œä¹¦éª¨æ¶</button>

  <!-- é»‘å®¢é£åŠ¨ç”»åŒºåŸŸ -->
  <div id="hackerOverlay" style="display: none;">
    <div id="hackerCanvas"></div>
    <div id="hackerStatus">
      <div id="hackerPhase"></div>
      <div id="hackerProgress"></div>
      <div id="hackerDetail"></div>
    </div>
  </div>

  <div id="aiStatus" class="status-text"></div>
</div>

<style>
  /* â”€â”€ åè®®æç¤ºæ¡ â”€â”€ */
  #apiUrlHint {
    width: 100%;
    box-sizing: border-box;
    font-size: 0.72rem;
  }
  #apiUrlHint .hint-bar {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 5px 10px;
    border-radius: 6px;
    cursor: default;
    line-height: 1.4;
  }
  #apiUrlHint .hint-detail {
    display: none;
    padding: 6px 10px 8px 10px;
    border-radius: 0 0 6px 6px;
    margin-top: -2px;
    font-size: 0.7rem;
    line-height: 1.7;
  }
  #apiUrlHint:hover .hint-detail {
    display: block;
  }

  /* â”€â”€ éª¨æ¶æ¡æ•°æŒ‰é’® â”€â”€ */
  .wb-count-btn {
    background: rgba(16, 185, 129, 0.08);
    border: 1px solid rgba(16, 185, 129, 0.2);
    color: #6ee7b7;
    padding: 4px 0;
    border-radius: 6px;
    font-size: 0.72rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: inherit;
  }
  .wb-count-btn:hover {
    background: rgba(16, 185, 129, 0.18);
    border-color: rgba(16, 185, 129, 0.4);
    color: #a7f3d0;
    transform: translateY(-1px);
  }
  .wb-count-btn.active {
    background: rgba(16, 185, 129, 0.25);
    border-color: #10b981;
    color: #ecfdf5;
    box-shadow: 0 0 8px rgba(16, 185, 129, 0.3);
  }

  /* â”€â”€ æœç´¢é…ç½®å— â”€â”€ */
  #searchConfigBlock {
    background: rgba(56, 189, 248, 0.04);
    border: 1px solid rgba(56, 189, 248, 0.15);
    border-radius: 10px;
    padding: 14px;
    transition: all 0.3s ease;
    position: relative;
    overflow: visible;
  }
  #searchConfigBlock.active {
    border-color: rgba(56, 189, 248, 0.35);
    background: rgba(56, 189, 248, 0.08);
  }
  /* æ”¾å¤§é•œæ‰«æåŠ¨ç”»è¦†ç›–å±‚ */
  .search-scan-overlay {
    position: absolute;
    inset: 0;
    z-index: 10;
    pointer-events: none;
    overflow: hidden;
    border-radius: inherit;
  }
  .search-scan-glass {
    position: absolute;
    font-size: 2.2rem;
    filter: drop-shadow(0 0 12px rgba(56,189,248,0.7));
    opacity: 0;
  }
  .search-scan-line {
    position: absolute;
    left: 0;
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, transparent, rgba(56,189,248,0.6), rgba(56,189,248,0.9), rgba(56,189,248,0.6), transparent);
    box-shadow: 0 0 12px rgba(56,189,248,0.5);
    opacity: 0;
  }
  .search-scan-doc {
    position: absolute;
    font-size: 1.4rem;
    opacity: 0;
    filter: drop-shadow(0 0 8px rgba(56,189,248,0.5));
  }

  /* â”€â”€ æœç´¢ç»“æœé¢„è§ˆ â”€â”€ */
  .search-result-item {
    padding: 8px;
    border-bottom: 1px solid rgba(56, 189, 248, 0.1);
    transition: background 0.15s ease;
  }
  .search-result-item:last-child { border-bottom: none; }
  .search-result-item:hover { background: rgba(56, 189, 248, 0.06); }
  .search-result-title {
    color: #38bdf8;
    font-weight: 600;
    font-size: 0.75rem;
    margin-bottom: 3px;
  }
  .search-result-snippet {
    color: #94a3b8;
    font-size: 0.7rem;
    line-height: 1.4;
  }
  .search-result-url {
    color: #475569;
    font-size: 0.62rem;
    margin-top: 2px;
    word-break: break-all;
  }

  /* â”€â”€ é»‘å®¢åŠ¨ç”» â”€â”€ */
  #hackerOverlay {
    position: relative;
    margin-top: 14px;
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid rgba(139, 92, 246, 0.25);
    background: #050510;
    min-height: 160px;
  }
  #hackerCanvas {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    font-family: 'JetBrains Mono', 'Courier New', monospace;
    font-size: 0.65rem;
    line-height: 1.2;
    color: rgba(139, 92, 246, 0.15);
    overflow: hidden;
    white-space: pre-wrap;
    word-break: break-all;
    padding: 8px;
    pointer-events: none;
  }
  #hackerStatus {
    position: relative;
    z-index: 2;
    padding: 20px 16px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 160px;
    gap: 12px;
  }
  #hackerPhase {
    font-size: 0.95rem;
    font-weight: 700;
    color: #c4b5fd;
    text-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
    text-align: center;
    animation: hackerGlow 1.5s ease-in-out infinite;
  }
  #hackerProgress {
    width: 80%;
    max-width: 260px;
    height: 4px;
    background: rgba(139, 92, 246, 0.15);
    border-radius: 99px;
    overflow: hidden;
    position: relative;
  }
  #hackerProgress::after {
    content: '';
    position: absolute;
    top: 0; left: 0;
    height: 100%;
    width: var(--progress, 0%);
    background: linear-gradient(90deg, #8b5cf6, #c084fc, #8b5cf6);
    border-radius: 99px;
    transition: width 0.4s ease;
    box-shadow: 0 0 12px rgba(139, 92, 246, 0.5);
  }
  #hackerDetail {
    font-size: 0.7rem;
    color: #64748b;
    text-align: center;
    font-family: 'JetBrains Mono', monospace;
    min-height: 1.2em;
  }
  @keyframes hackerGlow {
    0%, 100% { text-shadow: 0 0 20px rgba(139, 92, 246, 0.5); }
    50%       { text-shadow: 0 0 40px rgba(139, 92, 246, 0.8), 0 0 80px rgba(139, 92, 246, 0.3); }
  }
  #hackerOverlay::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.5), transparent);
    animation: hackerScan 2s linear infinite;
    pointer-events: none;
    z-index: 3;
  }
  @keyframes hackerScan {
    0%   { top: 0;    opacity: 1;   }
    100% { top: 100%; opacity: 0.2; }
  }
</style>

<script is:inline>
(function() {
  var apiUrl           = document.getElementById('apiUrl');
  var apiUrlHint       = document.getElementById('apiUrlHint');
  var wbSkeletonCount  = document.getElementById('wbSkeletonCount');
  var countBtns        = document.querySelectorAll('.wb-count-btn');
  var hackerOverlay    = document.getElementById('hackerOverlay');
  var hackerCanvas     = document.getElementById('hackerCanvas');
  var hackerPhase      = document.getElementById('hackerPhase');
  var hackerProgress   = document.getElementById('hackerProgress');
  var hackerDetail     = document.getElementById('hackerDetail');

  // æœç´¢ç›¸å…³ DOM
  var searchEnable       = document.getElementById('searchEnable');
  var searchConfigBlock  = document.getElementById('searchConfigBlock');
  var searchConfigDetail = document.getElementById('searchConfigDetail');
  var searchModeBadge    = document.getElementById('searchModeBadge');
  var searchEngine       = document.getElementById('searchEngine');
  var searchKeyGroup     = document.getElementById('searchKeyGroup');
  var searchKeyLabel     = document.getElementById('searchKeyLabel');
  var searchApiKey       = document.getElementById('searchApiKey');
  var searchRegisterHint = document.getElementById('searchRegisterHint');
  var searchResultCount  = document.getElementById('searchResultCount');
  var searchLang         = document.getElementById('searchLang');
  var searchCustomQuery  = document.getElementById('searchCustomQuery');
  var btnTestSearch      = document.getElementById('btnTestSearch');
  var searchTestStatus   = document.getElementById('searchTestStatus');
  var searchPreview      = document.getElementById('searchPreview');

  var SEARCH_CONFIG_KEY = 'st_v3_builder_search_config';

  // ============================================================
  //  åè®®æç¤ºæ¡
  // ============================================================
  function checkApiUrlProtocol() {
    var val     = apiUrl.value.trim();
    var isHttps = location.protocol === 'https:';
    var isHttp  = val.startsWith('http://');

    if (!val) { apiUrlHint.style.display = 'none'; return; }
    apiUrlHint.style.display = 'block';

    if (isHttps && isHttp) {
      apiUrlHint.innerHTML =
        '<div class="hint-bar" style="background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.25);color:#fcd34d;">' +
          'âš ï¸ <span>HTTP åœ°å€åœ¨ HTTPS é¡µé¢ä¸‹ä¼šè¢«æµè§ˆå™¨æ‹¦æˆª</span>' +
          '<span style="margin-left:auto;font-size:0.65rem;opacity:0.6;">æ‚¬åœæŸ¥çœ‹è§£å†³æ–¹æ³• â–¾</span>' +
        '</div>' +
        '<div class="hint-detail" style="background:rgba(245,158,11,0.06);border:1px solid rgba(245,158,11,0.2);border-top:none;color:#fcd34d;">' +
          'è§£å†³æ–¹æ³•ï¼ˆä»»é€‰ä¸€ç§ï¼‰ï¼š<br/>' +
          'â‘  ğŸ”— æ”¹ç”¨æœ¬å·¥å…·çš„ HTTP ç‰ˆæœ¬è®¿é—®ï¼š' +
          '<a href="http://zmer.xyz:11450" target="_blank" style="color:#38bdf8;text-decoration:underline;">http://zmer.xyz:11450</a><br/>' +
          'â‘¡ ç»™ä½ çš„ API å¥—ä¸Š HTTPS<br/>' +
          'â‘¢ ä½¿ç”¨ OpenAI / ä¸­è½¬ç«™ç­‰ HTTPS æ¥å£' +
        '</div>';
    } else if (!isHttps && isHttp) {
      apiUrlHint.innerHTML =
        '<div class="hint-bar" style="background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.2);color:#34d399;">' +
          'âœ… <span>HTTP åœ°å€ï¼Œå½“å‰é¡µé¢ä¹Ÿæ˜¯ HTTPï¼Œå¯ä»¥æ­£å¸¸è¯·æ±‚ã€‚</span>' +
        '</div>';
    } else {
      apiUrlHint.innerHTML =
        '<div class="hint-bar" style="background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.2);color:#34d399;">' +
          'âœ… <span>HTTPS åœ°å€ï¼Œå¯ä»¥æ­£å¸¸è¯·æ±‚ã€‚</span>' +
        '</div>';
    }
  }

  apiUrl.addEventListener('input', checkApiUrlProtocol);
  checkApiUrlProtocol();

  // ============================================================
  //  å¿«æ·æ¡æ•°æŒ‰é’®
  // ============================================================
  function updateCountBtnActive() {
    var val = parseInt(wbSkeletonCount.value);
    countBtns.forEach(function(btn) {
      btn.classList.toggle('active', parseInt(btn.getAttribute('data-count')) === val);
    });
  }
  countBtns.forEach(function(btn) {
    btn.addEventListener('click', function() {
      wbSkeletonCount.value = btn.getAttribute('data-count');
      updateCountBtnActive();
    });
  });
  wbSkeletonCount.addEventListener('input', updateCountBtnActive);
  updateCountBtnActive();

  // ============================================================
  //  è”ç½‘æœç´¢ UI é€»è¾‘
  // ============================================================
  var _searchInitDone = false;  // åˆæ¬¡ load ä¸åŠ¨ç”»
  var _searchAnimating = false;

  function updateSearchBadge() {
    var enabled = searchEnable.checked;
    if (!enabled) { searchModeBadge.style.display = 'none'; return; }

    var engine = searchEngine.value;
    searchModeBadge.style.display = 'inline';

    if (engine === 'none') {
      searchModeBadge.textContent      = 'AI è‡ªå¸¦è”ç½‘';
      searchModeBadge.style.background = 'rgba(56,189,248,0.12)';
      searchModeBadge.style.color      = '#38bdf8';
      searchModeBadge.style.border     = '1px solid rgba(56,189,248,0.25)';
      searchKeyGroup.style.display     = 'none';
    } else if (engine === 'serper') {
      searchModeBadge.textContent      = 'Serper Â· Google';
      searchModeBadge.style.background = 'rgba(16,185,129,0.12)';
      searchModeBadge.style.color      = '#34d399';
      searchModeBadge.style.border     = '1px solid rgba(16,185,129,0.25)';
      searchKeyGroup.style.display     = 'block';
      searchKeyLabel.textContent       = 'Serper API Key';
      searchRegisterHint.innerHTML     = 'ğŸ“ å…è´¹æ³¨å†Œï¼š<a href="https://serper.dev" target="_blank" style="color:#38bdf8;text-decoration:underline;">serper.dev</a> â†’ æ³¨å†Œååœ¨ Dashboard å¤åˆ¶ API Keyï¼ˆå…è´¹ 2,500 æ¬¡/æœˆï¼‰';
    } else if (engine === 'tavily') {
      searchModeBadge.textContent      = 'Tavily Â· AI ä¸“ç”¨';
      searchModeBadge.style.background = 'rgba(245,158,11,0.12)';
      searchModeBadge.style.color      = '#fbbf24';
      searchModeBadge.style.border     = '1px solid rgba(245,158,11,0.25)';
      searchKeyGroup.style.display     = 'block';
      searchKeyLabel.textContent       = 'Tavily API Key';
      searchRegisterHint.innerHTML     = 'ğŸ“ å…è´¹æ³¨å†Œï¼š<a href="https://tavily.com" target="_blank" style="color:#38bdf8;text-decoration:underline;">tavily.com</a> â†’ æ³¨å†Œååœ¨ API Keys é¡µå¤åˆ¶ï¼ˆå…è´¹ 1,000 æ¬¡/æœˆï¼‰';
    }
  }

  /* â”€â”€ æ”¾å¤§é•œæ‰«ææ–‡æ¡£åŠ¨ç”» â”€â”€ */
  function playSearchScanAnimation(cb) {
    if (!window.gsap) { cb(); return; }
    var overlay = document.createElement('div');
    overlay.className = 'search-scan-overlay';

    // æ–‡æ¡£å›¾æ ‡ç¾¤
    var docIcons = ['ğŸ“„', 'ğŸ“‹', 'ğŸ“‘'];
    var docs = [];
    docIcons.forEach(function (icon, i) {
      var d = document.createElement('span');
      d.className = 'search-scan-doc';
      d.textContent = icon;
      d.style.left = (20 + i * 30) + '%';
      d.style.top = '35%';
      overlay.appendChild(d);
      docs.push(d);
    });

    // æ”¾å¤§é•œ
    var glass = document.createElement('span');
    glass.className = 'search-scan-glass';
    glass.textContent = 'ğŸ”';
    overlay.appendChild(glass);

    // æ‰«æçº¿
    var scanLine = document.createElement('div');
    scanLine.className = 'search-scan-line';
    overlay.appendChild(scanLine);

    searchConfigBlock.appendChild(overlay);
    searchConfigBlock.style.overflow = 'hidden';

    var tl = gsap.timeline({
      onComplete: function () {
        overlay.remove();
        searchConfigBlock.style.overflow = '';
        cb();
      }
    });

    // Phase 1: æ–‡æ¡£å›¾æ ‡æ·¡å…¥æµ®èµ·
    docs.forEach(function (d, i) {
      tl.fromTo(d,
        { opacity: 0, y: 20, scale: 0.5 },
        { opacity: 0.7, y: 0, scale: 1, duration: 0.25, ease: 'back.out(1.5)' },
        i * 0.08
      );
    });

    // Phase 2: æ”¾å¤§é•œä»å·¦ä¾§é£å…¥å¹¶ä»å·¦åˆ°å³æ‰«æ
    tl.fromTo(glass,
      { opacity: 0, left: '-10%', top: '20%', scale: 0.3, rotation: -20 },
      { opacity: 1, left: '10%', top: '25%', scale: 1, rotation: 0, duration: 0.3, ease: 'power2.out' },
      0.15
    );
    tl.to(glass, {
      left: '75%', top: '30%', duration: 0.6, ease: 'power1.inOut',
    });

    // æ‰«æçº¿è·Ÿéš
    tl.fromTo(scanLine,
      { opacity: 0, top: '0%' },
      { opacity: 1, top: '100%', duration: 0.6, ease: 'power1.inOut' },
      0.35
    );

    // Phase 3: æ–‡æ¡£è¢«"å‘ç°"æ—¶é—ªå…‰
    docs.forEach(function (d, i) {
      tl.to(d, {
        scale: 1.3, opacity: 1,
        filter: 'drop-shadow(0 0 14px rgba(56,189,248,0.9))',
        duration: 0.15, yoyo: true, repeat: 1,
      }, 0.45 + i * 0.06);
    });

    // Phase 4: å…¨éƒ¨é£æ•£æ¶ˆå¤±ï¼Œæ”¾å¤§é•œç¼©å°æ¶ˆå¤±
    tl.to(glass, { opacity: 0, scale: 0.5, y: -15, duration: 0.2, ease: 'power2.in' });
    docs.forEach(function (d) {
      tl.to(d, { opacity: 0, scale: 0.3, y: -10, duration: 0.2, ease: 'power2.in' }, '-=0.15');
    });
    tl.to(scanLine, { opacity: 0, duration: 0.15 }, '-=0.2');
  }

  /* â”€â”€ å±•å¼€/æ”¶èµ·æœç´¢é…ç½®è¯¦æƒ…ï¼ˆå¸¦åŠ¨ç”»ï¼‰ â”€â”€ */
  function expandSearchDetail(animate) {
    if (animate && window.gsap) {
      searchConfigDetail.style.display = 'block';
      searchConfigDetail.style.overflow = 'hidden';
      var children = searchConfigDetail.children;
      // å…ˆè®©æ¯ä¸ªå­å…ƒç´ éšè—
      for (var i = 0; i < children.length; i++) {
        gsap.set(children[i], { opacity: 0, y: 12 });
      }
      gsap.fromTo(searchConfigDetail,
        { height: 0, opacity: 0 },
        {
          height: 'auto', opacity: 1, duration: 0.45, ease: 'power2.out',
          onComplete: function () {
            searchConfigDetail.style.overflow = '';
            searchConfigDetail.style.height = '';
          }
        }
      );
      // å­å…ƒç´ ä¾æ¬¡æ·¡å…¥
      for (var j = 0; j < children.length; j++) {
        gsap.to(children[j], {
          opacity: 1, y: 0, duration: 0.35, ease: 'power2.out',
          delay: 0.1 + j * 0.06,
        });
      }
    } else {
      searchConfigDetail.style.display = 'block';
    }
  }

  function collapseSearchDetail(animate) {
    if (animate && window.gsap) {
      searchConfigDetail.style.overflow = 'hidden';
      gsap.to(searchConfigDetail, {
        height: 0, opacity: 0, duration: 0.3, ease: 'power2.inOut',
        onComplete: function () {
          searchConfigDetail.style.display = 'none';
          searchConfigDetail.style.overflow = '';
          searchConfigDetail.style.height = '';
          searchConfigDetail.style.opacity = '';
        }
      });
    } else {
      searchConfigDetail.style.display = 'none';
    }
  }

  function updateSearchUI(isUserAction) {
    var enabled = searchEnable.checked;
    var shouldAnimate = _searchInitDone && isUserAction === true;
    var fxOn = window.__fxEnabled__ ? window.__fxEnabled__() : true;
    searchConfigBlock.classList.toggle('active', enabled);
    updateSearchBadge();

    if (enabled) {
      if (shouldAnimate && fxOn && !_searchAnimating) {
        _searchAnimating = true;
        playSearchScanAnimation(function () {
          expandSearchDetail(true);
          _searchAnimating = false;
        });
      } else if (shouldAnimate && !fxOn) {
        expandSearchDetail(true);
      } else {
        searchConfigDetail.style.display = 'block';
      }
    } else {
      if (shouldAnimate) {
        collapseSearchDetail(fxOn);
      } else {
        searchConfigDetail.style.display = 'none';
      }
      searchModeBadge.style.display = 'none';
    }

    saveSearchConfig();
  }

  searchEnable.addEventListener('change', function () { updateSearchUI(true); });
  searchEngine.addEventListener('change', function () { updateSearchBadge(); saveSearchConfig(); });
  searchApiKey.addEventListener('input', saveSearchConfig);
  searchResultCount.addEventListener('change', saveSearchConfig);
  searchLang.addEventListener('change', saveSearchConfig);

  // ============================================================
  //  æœç´¢é…ç½®æŒä¹…åŒ–
  // ============================================================
  function saveSearchConfig() {
    localStorage.setItem(SEARCH_CONFIG_KEY, JSON.stringify({
      enabled:     searchEnable.checked,
      engine:      searchEngine.value,
      apiKey:      searchApiKey.value.trim(),
      resultCount: parseInt(searchResultCount.value),
      lang:        searchLang.value,
    }));
  }

  function loadSearchConfig() {
    try {
      var c = JSON.parse(localStorage.getItem(SEARCH_CONFIG_KEY));
      if (!c) { searchEnable.checked = false; updateSearchUI(false); _searchInitDone = true; return; }
      searchEnable.checked = c.enabled === true;
      if (c.engine)      searchEngine.value      = c.engine;
      if (c.apiKey)      searchApiKey.value       = c.apiKey;
      if (c.resultCount) searchResultCount.value  = c.resultCount;
      if (c.lang)        searchLang.value         = c.lang;
      updateSearchUI(false);
      _searchInitDone = true;
    } catch(e) {
      searchEnable.checked = false;
      updateSearchUI(false);
      _searchInitDone = true;
    }
  }

  loadSearchConfig();

  // ============================================================
  //  æœç´¢æ‰§è¡Œå‡½æ•°
  // ============================================================
  async function executeSearch(query, count, lang) {
    var engine = searchEngine.value;
    var key    = searchApiKey.value.trim();
    if (engine === 'serper' && key) {
      return await searchWithSerper(query, count, lang, key);
    } else if (engine === 'tavily' && key) {
      return await searchWithTavily(query, count, key);
    } else {
      return null;
    }
  }

  async function searchWithSerper(query, count, lang, key) {
    var res = await fetch('https://google.serper.dev/search', {
      method: 'POST',
      headers: { 'X-API-KEY': key, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        q:   query,
        num: count,
        gl:  lang === 'zh-CN' ? 'cn' : (lang === 'ja' ? 'jp' : 'us'),
        hl:  lang === 'auto' ? 'zh-CN' : lang
      })
    });
    if (!res.ok) throw new Error('Serper æœç´¢å¤±è´¥ HTTP ' + res.status);
    var data = await res.json();
    var results = [];
    if (data.organic) {
      data.organic.forEach(function(item) {
        results.push({ title: item.title || '', snippet: item.snippet || '', url: item.link || '' });
      });
    }
    if (data.knowledgeGraph) {
      var kg = data.knowledgeGraph;
      results.unshift({ title: '[çŸ¥è¯†é¢æ¿] ' + (kg.title || ''), snippet: kg.description || '', url: kg.descriptionLink || '' });
    }
    return results.slice(0, count);
  }

  async function searchWithTavily(query, count, key) {
    var res = await fetch('https://api.tavily.com/search', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ api_key: key, query: query, max_results: count, search_depth: 'basic', include_answer: true })
    });
    if (!res.ok) throw new Error('Tavily æœç´¢å¤±è´¥ HTTP ' + res.status);
    var data = await res.json();
    var results = [];
    if (data.answer) {
      results.push({ title: '[AI æ€»ç»“]', snippet: data.answer, url: '' });
    }
    if (data.results) {
      data.results.forEach(function(item) {
        results.push({ title: item.title || '', snippet: item.content || '', url: item.url || '' });
      });
    }
    return results.slice(0, count + 1);
  }

  function formatSearchResultsForPrompt(results) {
    if (!results || results.length === 0) return '';
    var text = '\n\nã€ğŸŒ è”ç½‘æœç´¢å‚è€ƒèµ„æ–™ã€‘ï¼š\n';
    text += 'ä»¥ä¸‹æ˜¯ä»äº’è”ç½‘æœç´¢åˆ°çš„ç›¸å…³èµ„æ–™ï¼Œè¯·å‚è€ƒè¿™äº›çœŸå®ä¿¡æ¯æ¥ä¸°å¯Œä½ çš„åˆ›ä½œï¼Œä½†ä¸è¦ç…§æ¬ï¼š\n';
    text += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
    results.forEach(function(r, i) {
      text += 'ğŸ“„ [' + (i + 1) + '] ' + r.title + '\n';
      text += '   ' + r.snippet + '\n';
      if (r.url) text += '   ğŸ”— ' + r.url + '\n';
      text += '\n';
    });
    text += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
    text += 'è¯·åŸºäºä»¥ä¸Šå‚è€ƒèµ„æ–™ï¼Œç»“åˆç”¨æˆ·çš„åˆ›æ„è¦æ±‚è¿›è¡Œåˆ›ä½œã€‚å¯ä»¥å€Ÿé‰´ä½†ä¸è¦ç…§æ¬åŸæ–‡ã€‚\n';
    return text;
  }

  function renderSearchPreview(results) {
    if (!results || results.length === 0) { searchPreview.style.display = 'none'; return; }
    var html = '';
    results.forEach(function(r) {
      html += '<div class="search-result-item">';
      html += '<div class="search-result-title">'   + escapeHTMLSimple(r.title)                     + '</div>';
      html += '<div class="search-result-snippet">' + escapeHTMLSimple(r.snippet).substring(0, 200) + '</div>';
      if (r.url) html += '<div class="search-result-url">' + escapeHTMLSimple(r.url) + '</div>';
      html += '</div>';
    });
    searchPreview.innerHTML = html;
    searchPreview.style.display = 'block';
  }

  function escapeHTMLSimple(str) {
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  // ============================================================
  //  æœç´¢æµ‹è¯•æŒ‰é’®
  // ============================================================
  btnTestSearch.addEventListener('click', async function() {
    var engine = searchEngine.value;
    var query  = searchCustomQuery.value.trim() || document.getElementById('aiPrompt').value.trim();
    if (!query) {
      searchTestStatus.textContent = 'âŒ è¯·å…ˆå¡«å†™æç¤ºè¯æˆ–æœç´¢è¯';
      searchTestStatus.style.color = '#fca5a5';
      return;
    }
    if (engine === 'none') {
      searchTestStatus.textContent = 'â„¹ï¸ å½“å‰ä¸º AI è‡ªå¸¦è”ç½‘æ¨¡å¼ï¼Œæ— éœ€æµ‹è¯•';
      searchTestStatus.style.color = '#38bdf8';
      searchPreview.style.display  = 'none';
      return;
    }
    if (!searchApiKey.value.trim()) {
      searchTestStatus.textContent = 'âŒ è¯·å…ˆå¡«å†™æœç´¢ API Key';
      searchTestStatus.style.color = '#fca5a5';
      return;
    }
    btnTestSearch.disabled       = true;
    searchTestStatus.textContent = 'ğŸ” æœç´¢ä¸­...';
    searchTestStatus.style.color = '#38bdf8';
    try {
      var count   = parseInt(searchResultCount.value) || 5;
      var lang    = searchLang.value;
      var results = await executeSearch(query, count, lang);
      if (results && results.length > 0) {
        searchTestStatus.textContent = 'âœ… æ‰¾åˆ° ' + results.length + ' æ¡ç»“æœ';
        searchTestStatus.style.color = '#34d399';
        renderSearchPreview(results);
      } else {
        searchTestStatus.textContent = 'âš ï¸ æœªæ‰¾åˆ°ç»“æœ';
        searchTestStatus.style.color = '#fbbf24';
        searchPreview.style.display  = 'none';
      }
    } catch(err) {
      searchTestStatus.textContent = 'âŒ ' + err.message;
      searchTestStatus.style.color = '#fca5a5';
      searchPreview.style.display  = 'none';
    } finally {
      btnTestSearch.disabled = false;
    }
  });

  // ============================================================
  //  é»‘å®¢é£ä¿¡æ¯æµåŠ¨ç”»
  // ============================================================
  var hackerChars      = '01ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒŠãƒ‹ãƒŒãƒãƒãƒãƒ’ãƒ•ãƒ˜ãƒ›ãƒãƒŸãƒ ãƒ¡ãƒ¢ãƒ¤ãƒ¦ãƒ¨ãƒ©ãƒªãƒ«ãƒ¬ãƒ­ãƒ¯ãƒ²ãƒ³{}[]<>/\\|=+-*&^%$#@!~;:,.?ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  var hackerAnimId     = null;
  var hackerStreamText = '';

  function startHackerAnim() {
    hackerOverlay.style.display = 'block';
    hackerStreamText = '';
    hackerCanvas.textContent = '';
    for (var i = 0; i < 800; i++) {
      hackerStreamText += hackerChars[Math.floor(Math.random() * hackerChars.length)];
      if (Math.random() < 0.08) hackerStreamText += '\n';
    }
    hackerCanvas.textContent = hackerStreamText;
    var frameCount = 0;
    function tick() {
      frameCount++;
      if (frameCount % 2 === 0) {
        var arr     = hackerStreamText.split('');
        var changes = 15 + Math.floor(Math.random() * 25);
        for (var c = 0; c < changes; c++) {
          var pos = Math.floor(Math.random() * arr.length);
          if (arr[pos] !== '\n') arr[pos] = hackerChars[Math.floor(Math.random() * hackerChars.length)];
        }
        var newLine = '';
        for (var n = 0; n < 20; n++) newLine += hackerChars[Math.floor(Math.random() * hackerChars.length)];
        arr.push('\n');
        for (var nn = 0; nn < newLine.length; nn++) arr.push(newLine[nn]);
        if (arr.length > 1200) arr.splice(0, arr.length - 1200);
        hackerStreamText         = arr.join('');
        hackerCanvas.textContent = hackerStreamText;
        hackerCanvas.scrollTop   = hackerCanvas.scrollHeight;
      }
      hackerAnimId = requestAnimationFrame(tick);
    }
    hackerAnimId = requestAnimationFrame(tick);
  }

  function stopHackerAnim()    { if (hackerAnimId) { cancelAnimationFrame(hackerAnimId); hackerAnimId = null; } }
  function hideHackerOverlay() { hackerOverlay.style.display = 'none'; }
  function setHackerPhase(text)  { hackerPhase.textContent = text; }
  function setHackerProgress(current, total) {
    var pct = total > 0 ? Math.round((current / total) * 100) : 0;
    hackerProgress.style.setProperty('--progress', pct + '%');
  }
  function setHackerDetail(text) { hackerDetail.textContent = text; }

  var hackerMessages = [
    'æ­£åœ¨è‚˜å‡»gemini...',
    'æ­£åœ¨è‚˜å‡»deepseek...',
    'æ­£åœ¨ç”³è¯·é€€æ¬¾Claude...',
    'æ­£åœ¨ç»™è°·æ­Œå†™ç”³è¿°é‚®ä»¶...',
    'æ­£åœ¨åˆ é™¤æ— ç”¨çš„å±å±±ä»£ç ...',
    'æ­£åœ¨ç”³è¯·GPTå¤§å…µè®¤è¯...',
    'æ­£åœ¨å‡è£…çœ‹æ‡‚äº†æŠ¥é”™ä¿¡æ¯...',
    'æ­£åœ¨è¯´æœæ¨¡å‹ä¸è¦å¹»è§‰...',
    'æ­£åœ¨ç­‰æ¨¡å‹ç”Ÿæˆï¼Œå·²ç­‰å¾…ä¸‰ä¸ªä¸–çºª...',
    'æ­£åœ¨è®© GPT å‡è£…è‡ªå·±æ˜¯ Claude...',
    'æ­£åœ¨è®© Claude å‡è£…è‡ªå·±æ˜¯ GPT...',
    'æ­£åœ¨æŠŠå¹»è§‰ç»“æœå½“å‚è€ƒæ–‡çŒ®...',
    'æ­£åœ¨æŠŠäº”è¡Œä»£ç æ³¨é‡Šå†™æˆä¸¤ç™¾å­—...',
    'æ­£åœ¨æŠŠ bug é‡æ–°å‘½åä¸º feature...',
    'æ­£åœ¨å·å·ç»•è¿‡å†…å®¹å®¡æ ¸...',
    'æ­£åœ¨æ§è¯‰ token ä¸å¤Ÿç”¨...',
    'æ­£åœ¨ç­‰å¾… Cloudflare è½¬åœˆåœˆ...',
    'æ­£åœ¨ç»™ token çœé’±ï¼Œåˆ æ‰äº†æ ‡ç‚¹...',
    'æ­£åœ¨æµ‹è¯• AI æœ‰æ²¡æœ‰æ„Ÿæƒ…...',
    'æ­£åœ¨æŠŠ prompt æ”¹äº†åˆæ”¹...',
  ];
  function getRandomHackerMsg() { return hackerMessages[Math.floor(Math.random() * hackerMessages.length)]; }

  // ============================================================
  //  æš´éœ²ç»™ index.astro
  // ============================================================
  window.__hackerAnim__ = {
    start:       startHackerAnim,
    stop:        stopHackerAnim,
    hide:        hideHackerOverlay,
    setPhase:    setHackerPhase,
    setProgress: setHackerProgress,
    setDetail:   setHackerDetail,
    randomMsg:   getRandomHackerMsg,
  };

  window.__getSkeletonCount__ = function() {
    var v = parseInt(wbSkeletonCount.value);
    if (isNaN(v) || v < 1) return 6;
    if (v > 30) return 30;
    return v;
  };

  window.__searchConfig__ = {
    isEnabled:       function() { return searchEnable.checked; },
    getEngine:       function() { return searchEngine.value; },
    getCustomQuery:  function() { return searchCustomQuery.value.trim(); },
    getResultCount:  function() { return parseInt(searchResultCount.value) || 5; },
    getLang:         function() { return searchLang.value; },
    executeSearch:   executeSearch,
    formatForPrompt: formatSearchResultsForPrompt,
  };

})();
</script>
