---
---
<div class="panel area-character">
  <!-- è‰ç¨¿ç®¡ç† -->
  <div class="draft-manager">
    <label style="color: #34d399; font-size: 0.85rem; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
      <span>ğŸ’¾ å¤šå¡ç‰‡è‰ç¨¿ç®±</span>
      <span id="saveIndicator" style="color: #3b82f6; font-size: 0.75rem; display: none; font-weight: 600;">âœ”ï¸ å·²ä¿å­˜</span>
    </label>
    <select id="draftSelect"></select>
    <div class="draft-controls">
      <button id="btnNewDraft" class="btn btn-add" style="flex: 1;">ğŸ“„ æ–°å»º</button>
      <button id="btnDeleteDraft" class="btn btn-delete" style="flex: 1; width: 100%;">ğŸ—‘ï¸ åˆ é™¤</button>
    </div>
  </div>

  <h2>ğŸ§‘â€ğŸ¤ è§’è‰²è®¾å®š</h2>

  <!-- å¤´åƒä¸Šä¼  -->
  <div style="display: flex; gap: 14px; margin-bottom: 16px; align-items: center;">
    <div style="width: 56px; height: 56px; border-radius: 10px; background: #0a0f1e; border: 1px dashed #334155; overflow: hidden; display: flex; justify-content: center; align-items: center; flex-shrink: 0;">
      <span id="avatarPlaceholder" style="font-size: 0.65rem; color: #475569;">æ— å›¾</span>
      <img id="avatarImg" style="width: 100%; height: 100%; object-fit: cover; display: none;" alt="avatar" />
    </div>
    <div style="flex: 1; min-width: 0;">
      <label style="font-size: 0.75rem; color: #64748b; margin-bottom: 4px; display: block;">ä¸Šä¼ å¤´åƒï¼ˆå°†åµŒå…¥ PNG å¡ç‰‡ï¼‰</label>
      <input type="file" id="charImageInput" accept="image/*" />
    </div>
  </div>

  <!-- åŸºç¡€ä¿¡æ¯ -->
  <div class="grid-2">
    <div class="form-group">
      <label>è§’è‰²å (Name)</label>
      <input type="text" id="charName" placeholder="è§’è‰²åç§°" />
    </div>
    <div class="form-group">
      <label>ä¸–ç•Œä¹¦å (Worldbook)</label>
      <input type="text" id="wbName" placeholder="ä¸–ç•Œä¹¦åç§°" />
    </div>
  </div>

  <div class="form-group">
    <label>è§’è‰²æè¿° (Description)</label>
    <textarea id="charDesc" style="min-height: 130px;" placeholder="è§’è‰²çš„å¤–è²Œã€æ€§æ ¼ã€èƒŒæ™¯æ•…äº‹..."></textarea>
  </div>

  <div class="form-group">
    <label>ç¬¬ä¸€æ¡æ¶ˆæ¯ (First Message)</label>
    <textarea id="firstMes" style="min-height: 130px;" placeholder="è§’è‰²çš„å¼€åœºç™½..."></textarea>
  </div>

  <!-- â˜… å¤‡é€‰å¼€åœºç™½ -->
  <div class="alt-greetings-section">
    <div class="alt-greetings-header">
      <label style="color: #64748b; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin: 0;">
        å¤‡é€‰å¼€åœºç™½ (Alternate Greetings)
      </label>
      <button id="btnAddGreeting" class="btn-alt-add" title="æ·»åŠ å¤‡é€‰å¼€åœºç™½">ï¼‹</button>
    </div>
    <p class="alt-greetings-tip">é…’é¦†ä¸­ç”¨æˆ·å¯åœ¨å¤šä¸ªå¼€åœºç™½ä¹‹é—´åˆ‡æ¢é€‰æ‹©</p>
    <div id="altGreetingsList"></div>
  </div>

  <hr class="divider" />

  <div class="form-group">
    <label>ä½œè€…æ³¨é‡Š (Creator Notes)</label>
    <textarea id="creatorNotes" placeholder="ç»™ä½¿ç”¨è€…çš„è¯´æ˜..."></textarea>
  </div>
</div>

<style is:global>
  /* â”€â”€ å¤‡é€‰å¼€åœºç™½åŒºåŸŸ â”€â”€ */
  .alt-greetings-section {
    margin-bottom: 14px;
  }
  .alt-greetings-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
  }
  .alt-greetings-tip {
    font-size: 0.68rem;
    color: #475569;
    margin: 0 0 10px 0;
  }

  /* ï¼‹ æ·»åŠ æŒ‰é’® */
  .btn-alt-add {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    border: 1px dashed #334155;
    background: rgba(16, 185, 129, 0.06);
    color: #34d399;
    font-size: 1.1rem;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    font-family: inherit;
    line-height: 1;
    padding: 0;
  }
  .btn-alt-add:hover {
    background: rgba(16, 185, 129, 0.15);
    border-color: #34d399;
    transform: scale(1.1);
  }

  /* æ¡ç›®åŠ¨ç”» */
  .alt-greeting-item {
    position: relative;
    margin-bottom: 8px;
    animation: altIn 0.25s ease;
  }
  @keyframes altIn {
    from { opacity: 0; transform: translateY(-6px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .alt-greeting-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
  }
  .alt-greeting-label {
    font-size: 0.72rem;
    color: #8b5cf6;
    font-weight: 600;
  }
  .alt-greeting-actions {
    display: flex;
    gap: 4px;
  }

  /* â”€â”€ æ“ä½œæŒ‰é’®åŸºç¡€ â”€â”€ */
  .btn-alt-action {
    width: 26px;
    height: 26px;
    border-radius: 6px;
    border: 1px solid rgba(99, 102, 241, 0.25);
    background: rgba(99, 102, 241, 0.08);
    color: #818cf8;
    font-size: 0.78rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.18s ease;
    padding: 0;
    font-family: inherit;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
  }
  .btn-alt-action:hover {
    background: rgba(99, 102, 241, 0.2);
    border-color: rgba(99, 102, 241, 0.5);
    color: #c7d2fe;
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(99, 102, 241, 0.25);
  }
  .btn-alt-action:active {
    transform: translateY(0);
  }

  /* ä¸Šç§» â€” è“è‰² */
  .btn-alt-action[data-action="up"] {
    border-color: rgba(56, 189, 248, 0.25);
    background: rgba(56, 189, 248, 0.08);
    color: #7dd3fc;
  }
  .btn-alt-action[data-action="up"]:hover {
    background: rgba(56, 189, 248, 0.18);
    border-color: rgba(56, 189, 248, 0.5);
    color: #bae6fd;
    box-shadow: 0 3px 8px rgba(56, 189, 248, 0.2);
    transform: translateY(-1px);
  }

  /* ä¸‹ç§» â€” ç»¿è‰² */
  .btn-alt-action[data-action="down"] {
    border-color: rgba(16, 185, 129, 0.25);
    background: rgba(16, 185, 129, 0.08);
    color: #6ee7b7;
  }
  .btn-alt-action[data-action="down"]:hover {
    background: rgba(16, 185, 129, 0.18);
    border-color: rgba(16, 185, 129, 0.5);
    color: #a7f3d0;
    box-shadow: 0 3px 8px rgba(16, 185, 129, 0.2);
    transform: translateY(-1px);
  }

  /* åˆ é™¤ â€” çº¢è‰² */
  .btn-alt-action.btn-alt-del {
    border-color: rgba(239, 68, 68, 0.25);
    background: rgba(239, 68, 68, 0.08);
    color: #fca5a5;
  }
  .btn-alt-action.btn-alt-del:hover {
    background: rgba(239, 68, 68, 0.18);
    border-color: rgba(239, 68, 68, 0.5);
    color: #fecaca;
    box-shadow: 0 3px 8px rgba(239, 68, 68, 0.2);
    transform: translateY(-1px);
  }

  /* æ¡ç›®æ–‡æœ¬æ¡† */
  .alt-greeting-item textarea {
    width: 100%;
    min-height: 80px;
    resize: vertical;
  }

  /* ç©ºçŠ¶æ€ */
  .alt-greetings-empty {
    text-align: center;
    padding: 16px;
    border: 1px dashed #1e293b;
    border-radius: 8px;
    color: #334155;
    font-size: 0.75rem;
  }
</style>

<script is:inline>
(function() {
  var btnAdd = document.getElementById('btnAddGreeting');
  var listEl = document.getElementById('altGreetingsList');

  // å…¨å±€å­˜å‚¨
  if (!window.__altGreetings__) window.__altGreetings__ = [];

  function render() {
    var greetings = window.__altGreetings__;
    if (!greetings.length) {
      listEl.innerHTML = '<div class="alt-greetings-empty">æš‚æ— å¤‡é€‰å¼€åœºç™½ï¼Œç‚¹å‡»å³ä¸Šè§’ ï¼‹ æ·»åŠ </div>';
      return;
    }
    listEl.innerHTML = '';
    greetings.forEach(function(text, i) {
      var item = document.createElement('div');
      item.className = 'alt-greeting-item';
      item.innerHTML =
        '<div class="alt-greeting-bar">' +
          '<span class="alt-greeting-label">å¼€åœºç™½ #' + (i + 2) + '</span>' +
          '<div class="alt-greeting-actions">' +
            (i > 0
              ? '<button class="btn-alt-action" data-action="up" data-idx="' + i + '" title="ä¸Šç§»">â†‘</button>'
              : '') +
            (i < greetings.length - 1
              ? '<button class="btn-alt-action" data-action="down" data-idx="' + i + '" title="ä¸‹ç§»">â†“</button>'
              : '') +
            '<button class="btn-alt-action btn-alt-del" data-action="del" data-idx="' + i + '" title="åˆ é™¤">âœ•</button>' +
          '</div>' +
        '</div>' +
        '<textarea class="alt-greeting-ta" data-idx="' + i + '" placeholder="å¤‡é€‰å¼€åœºç™½ #' + (i + 2) + ' çš„å†…å®¹...">' +
          escapeHTML(text) +
        '</textarea>';
      listEl.appendChild(item);
    });

    // äº‹ä»¶ç»‘å®š
    listEl.querySelectorAll('.alt-greeting-ta').forEach(function(ta) {
      ta.addEventListener('input', function(e) {
        var idx = parseInt(e.target.getAttribute('data-idx'));
        window.__altGreetings__[idx] = e.target.value;
        notifyChange();
      });
    });
    listEl.querySelectorAll('.btn-alt-action').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        var action = e.currentTarget.getAttribute('data-action');
        var idx    = parseInt(e.currentTarget.getAttribute('data-idx'));
        var g      = window.__altGreetings__;
        if (action === 'del') {
          g.splice(idx, 1);
        } else if (action === 'up' && idx > 0) {
          var tmp = g[idx]; g[idx] = g[idx - 1]; g[idx - 1] = tmp;
        } else if (action === 'down' && idx < g.length - 1) {
          var tmp2 = g[idx]; g[idx] = g[idx + 1]; g[idx + 1] = tmp2;
        }
        render();
        notifyChange();
      });
    });
  }

  btnAdd.addEventListener('click', function() {
    window.__altGreetings__.push('');
    render();
    var tas = listEl.querySelectorAll('.alt-greeting-ta');
    if (tas.length) tas[tas.length - 1].focus();
    notifyChange();
  });

  function notifyChange() {
    if (window.triggerGlobalUpdate) window.triggerGlobalUpdate();
  }

  function escapeHTML(str) {
    return String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  window.__renderAltGreetings__ = render;
  render();
})();
</script>
